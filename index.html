<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBCS 2026 - Interactive Prep Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #667eea;
            --primary-2: #8b5cf6;
            --primary-dark: #4c1d95;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;

            --dark-bg: #070a16;
            --dark-card: rgba(22, 33, 62, 0.72);

            --card: rgba(255, 255, 255, 0.82);
            --card-border: rgba(255, 255, 255, 0.55);
            --shadow: 0 18px 45px rgba(2, 6, 23, 0.18);
            --shadow-strong: 0 25px 80px rgba(2, 6, 23, 0.38);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body { height: 100%; }

        body {
            background:
                radial-gradient(1000px 600px at 10% 10%, rgba(102,126,234,0.35), transparent 60%),
                radial-gradient(1000px 700px at 90% 20%, rgba(139,92,246,0.35), transparent 55%),
                radial-gradient(900px 700px at 40% 95%, rgba(34,197,94,0.18), transparent 55%),
                linear-gradient(180deg, #f8fafc, #eef2ff);
            color: #0f172a;
        }

        /* Smooth scroll + better selection */
        ::selection { background: rgba(102,126,234,0.25); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.35); border-radius: 999px; border: 2px solid rgba(255,255,255,0.6); }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.35); }

        .glass {
            background: var(--card);
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        .glass-strong {
            background: rgba(255,255,255,0.78);
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: var(--shadow-strong);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
        }

        .gradient-text {
            background: linear-gradient(90deg, var(--primary), var(--primary-2));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .soft-ring {
            box-shadow:
                0 0 0 1px rgba(99,102,241,0.18),
                0 12px 38px rgba(2, 6, 23, 0.14);
        }

        .loader {
            border: 4px solid rgba(255,255,255,0.55);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            animation: spin 0.9s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 14px;
            color: white;
            font-weight: 700;
            z-index: 9999;
            animation: toastIn 0.25s ease;
            box-shadow: 0 18px 40px rgba(2, 6, 23, 0.25);
            border: 1px solid rgba(255,255,255,0.25);
            backdrop-filter: blur(10px);
        }
        .toast.success { background: linear-gradient(135deg, rgba(34,197,94,0.95), rgba(16,185,129,0.95)); }
        .toast.error { background: linear-gradient(135deg, rgba(239,68,68,0.95), rgba(244,63,94,0.95)); }
        .toast.info { background: linear-gradient(135deg, rgba(99,102,241,0.95), rgba(139,92,246,0.95)); }
        @keyframes toastIn { from { transform: translateY(8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .dark-mode {
            background:
                radial-gradient(1000px 600px at 10% 10%, rgba(102,126,234,0.20), transparent 60%),
                radial-gradient(1000px 700px at 90% 20%, rgba(139,92,246,0.20), transparent 55%),
                radial-gradient(900px 700px at 40% 95%, rgba(34,197,94,0.10), transparent 55%),
                linear-gradient(180deg, #060815, #0b1227) !important;
            color: #e5e7eb !important;
        }

        .dark-mode .glass, .dark-mode .glass-strong {
            background: rgba(17, 24, 39, 0.60) !important;
            border-color: rgba(255,255,255,0.10) !important;
            box-shadow: 0 22px 70px rgba(0,0,0,0.45) !important;
        }

        .dark-mode .bg-white { background: rgba(17, 24, 39, 0.58) !important; }
        .dark-mode input, .dark-mode textarea, .dark-mode select {
            background: rgba(2, 6, 23, 0.45) !important;
            color: white !important;
            border-color: rgba(255,255,255,0.15) !important;
        }
        .dark-mode table { background: rgba(17, 24, 39, 0.55) !important; }
        .dark-mode td { border-color: rgba(255,255,255,0.08) !important; }

        /* Sidebar shape (more rectangular, slight rounding) */
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
            overflow: hidden;
        }
        .sidebar.active { transform: translateX(0); }

        /* Sidebar item containers (avoid text hugging curved edges) */
        #monthMenu, #subjectMenu {
            margin: 0 10px 12px;
            padding: 6px 0;
            border-radius: 14px;
            overflow: visible;
        }

        /* Sidebar items: slightly rounded rectangles + better text fit */
        .sidebar nav .menu-item {
            border-radius: 14px;
            margin: 6px 10px;
            padding: 12px 14px; /* ensure text doesn't touch edges */
            line-height: 1.25;
            white-space: normal;
            word-break: break-word;
            overflow: hidden;
        }

        /* Sidebar section headers (the toggle rows for month/subject) */
        .sidebar-section-toggle {
            margin: 6px 10px;
            padding: 12px 14px;
            border-radius: 14px;
            line-height: 1.25;
        }

        /* Sidebar submenu items (month list + subjects list + add subject) */
        .sidebar-subitem {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            margin: 6px 8px;
            line-height: 1.25;
            white-space: normal;
            word-break: break-word;
            overflow: hidden;
        }

        /* Sidebar icon visibility: give icons a contrast badge */
        .sidebar nav .menu-item > span:first-child {
            width: 28px;
            height: 28px;
            display: grid;
            place-items: center;
            border-radius: 10px;
            background: rgba(102,126,234,0.14);
            border: 1px solid rgba(102,126,234,0.18);
            flex: 0 0 auto;
        }
        body.dark-mode .sidebar nav .menu-item > span:first-child {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.10);
        }

        /* Icon badge for section toggles (Monthly/Subjects) */
        .sidebar-section-toggle span > span:first-child {
            width: 28px;
            height: 28px;
            display: grid;
            place-items: center;
            border-radius: 10px;
            background: rgba(102,126,234,0.14);
            border: 1px solid rgba(102,126,234,0.18);
            flex: 0 0 auto;
        }
        body.dark-mode .sidebar-section-toggle span > span:first-child {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.10);
        }

        /* Tiny dot used for subject progress indicators */
        .subj-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            flex: 0 0 auto;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.9);
        }
        body.dark-mode .subj-dot { box-shadow: 0 0 0 2px rgba(2,6,23,0.55); }

        .subj-pct {
            margin-left: auto;
            font-size: 12px;
            font-weight: 900;
            opacity: 0.9;
        }

        /* Sidebar subitem icon badge */
        .sidebar-subitem .subitem-icon {
            width: 26px;
            height: 26px;
            display: grid;
            place-items: center;
            border-radius: 10px;
            background: rgba(102,126,234,0.12);
            border: 1px solid rgba(102,126,234,0.18);
            flex: 0 0 auto;
        }
        body.dark-mode .sidebar-subitem .subitem-icon {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.10);
        }

        /* Subject chip used inside tables */
        .subject-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.03);
            border: 1px solid rgba(15, 23, 42, 0.06);
            max-width: 100%;
        }
        body.dark-mode .subject-chip {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.10);
        }

        .overlay { display: none; }
        .overlay.active { display: block; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.25s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

        /* Completed styling (keep strike-through, but background is handled by date-highlights) */
        .completed-row { background: transparent !important; }
        .dark-mode .completed-row { background: transparent !important; }
        .completed-row td { text-decoration: line-through; opacity: 0.75; }

        /* Date-based row highlights (Monthly + Subject views)
           - Today: light green
           - Tomorrow: light yellow
           - Past & pending: light red
           - Past & completed: light blue
           - Otherwise: keep default/white
        */
        .row-today { background: rgba(34, 197, 94, 0.14) !important; }
        .row-tomorrow { background: rgba(245, 158, 11, 0.18) !important; }
        .row-past-missed { background: rgba(239, 68, 68, 0.12) !important; }
        .row-past-done { background: rgba(59, 130, 246, 0.12) !important; }

        .dark-mode .row-today { background: rgba(34, 197, 94, 0.18) !important; }
        .dark-mode .row-tomorrow { background: rgba(245, 158, 11, 0.16) !important; }
        .dark-mode .row-past-missed { background: rgba(239, 68, 68, 0.16) !important; }
        .dark-mode .row-past-done { background: rgba(59, 130, 246, 0.16) !important; }

        .progress-bar { transition: width 0.5s ease; }

        .table-row-hover:hover {
            background: rgba(99, 102, 241, 0.06);
            animation: microBounce 360ms cubic-bezier(.34, 1.56, .64, 1);
            transform-origin: center;
        }

        .date-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 12px;
            background: rgba(99,102,241,0.10);
            border: 1px solid rgba(99,102,241,0.18);
            color: rgb(79, 70, 229);
            font-weight: 700;
            font-size: 12px;
        }
        .dark-mode .date-chip {
            background: rgba(99,102,241,0.14);
            border-color: rgba(99,102,241,0.22);
            color: rgba(199, 210, 254, 0.95);
        }

        /* Progress-tinted topic pill (Monthly + Subject views)
           Uses CSS vars so we can set per-row/subject styling inline:
           --topicBg, --topicBorder, --topicText
        */
        /* Topic (Monthly + Subject view) - plain (no color cards) */
        .topic-inline {
            display: block;
            padding: 4px 0;
            border-radius: 0;
            background: transparent;
            border: 0;
            color: inherit;
            line-height: 1.25;
            white-space: normal;
            word-break: break-word;
        }

        /* Subject label in monthly table: plain text */
        .subject-plain {
            font-weight: 800;
            color: inherit;
        }

        .input-mini {
            width: 9.8rem;
            padding: 6px 8px;
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.10);
            font-size: 12px;
        }

        .btn-glow {
            position: relative;
            overflow: hidden;
        }
        .btn-glow::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(400px 120px at var(--x, 50%) var(--y, 50%), rgba(255,255,255,0.35), transparent 60%);
            opacity: 0;
            transition: opacity 200ms ease;
        }
        .btn-glow:hover::before { opacity: 1; }

        @media print {
            .no-print { display: none !important; }
            body { font-size: 10pt !important; background: #fff !important; }
        }

        /* =========================================================
           OPTION B (Classic) SKIN OVERRIDES
           Applies a cleaner, more "classic" UI while keeping Option A functionality.
        ========================================================= */
        :root {
            --primary: #667eea;
            --primary-2: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --dark-bg: #1a1a2e;
            --dark-card: #16213e;
            --text-main: #1f2937;
            --text-light: #eef2ff;
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.6;
            background: #f5f7fa !important;
            color: var(--text-main) !important;
        }

        .dark-mode {
            background: var(--dark-bg) !important;
            color: var(--text-light) !important;
        }

        /* Main content spacing like Option B */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            /* leave room for the right action dock + left sidebar toggle */
            padding: 20px 90px 20px 90px;
        }
        @media (max-width: 768px) {
            /* on mobile the dock becomes a bottom bar */
            .app-container { padding: 84px 20px 20px 20px; }
        }

        /* Cards: more solid and crisp */
        .glass, .glass-strong {
            background: rgba(255,255,255,0.96) !important;
            border: 1px solid rgba(15, 23, 42, 0.08) !important;
            box-shadow: 0 12px 30px rgba(2, 6, 23, 0.08) !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }
        .dark-mode .glass, .dark-mode .glass-strong {
            background: rgba(22, 33, 62, 0.95) !important;
            border-color: rgba(255,255,255,0.08) !important;
            box-shadow: 0 18px 45px rgba(0,0,0,0.35) !important;
        }

        /* Reduce overly-round Tailwind radii for a more rectangular look */
        .rounded-3xl { border-radius: 14px !important; }
        .rounded-2xl { border-radius: 12px !important; }
        .rounded-xl { border-radius: 10px !important; }

        /* Sidebar: classic Option B style */
        .sidebar {
            position: fixed;
            left: -288px;
            top: 0;
            width: 288px;
            height: 100%;
            background: var(--dark-card) !important;
            color: rgba(255,255,255,0.92) !important;
            transition: left 0.28s ease;
            z-index: 2000;
            overflow-y: auto;
            box-shadow: 4px 0 15px rgba(0,0,0,0.35) !important;
            border-right: 1px solid rgba(255,255,255,0.08) !important;
            border-top-right-radius: 14px !important;
            border-bottom-right-radius: 14px !important;
        }
        .sidebar.active { left: 0; }

        .overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55) !important;
            z-index: 1999;
        }
        .overlay.active { display: block; }

        /* Sidebar buttons: ensure text fits and stays readable */
        .sidebar nav .menu-item {
            margin: 6px 12px !important;
            padding: 12px 14px !important;
            border-radius: 12px !important;
            border-left: 4px solid transparent;
            white-space: normal;
            word-break: break-word;
            line-height: 1.25;
            color: rgba(255,255,255,0.92) !important;
        }
        .sidebar nav .menu-item:hover {
            background: rgba(255,255,255,0.08) !important;
            border-left-color: var(--primary) !important;
        }

        .sidebar-section-toggle {
            margin: 6px 12px !important;
            padding: 12px 14px !important;
            border-radius: 12px !important;
            color: rgba(255,255,255,0.92) !important;
        }

        #monthMenu, #subjectMenu {
            margin: 0 12px 14px !important;
            padding: 8px 0 !important;
            border-radius: 12px !important;
            background: rgba(0,0,0,0.22) !important;
        }

        .sidebar-subitem {
            margin: 6px 10px !important;
            padding: 10px 12px !important;
            border-radius: 10px !important;
            color: rgba(255,255,255,0.86) !important;
            white-space: normal;
            word-break: break-word;
            line-height: 1.25;
        }
        .sidebar-subitem:hover { background: rgba(255,255,255,0.08) !important; color: rgba(255,255,255,0.95) !important; }

        /* Tables: more classic (Option B) */
        table { width: 100%; border-collapse: collapse; }
        th { font-size: 13px; letter-spacing: 0.01em; }
        td { border-color: rgba(15, 23, 42, 0.08) !important; }
        .dark-mode td { border-color: rgba(255,255,255,0.08) !important; }
        .table-row-hover:hover { background: rgba(102, 126, 234, 0.08) !important; }

        /* Date chip: keep but tone it to match classic skin */
        .date-chip {
            background: rgba(102, 126, 234, 0.12) !important;
            border-color: rgba(102, 126, 234, 0.22) !important;
            color: rgba(79, 70, 229, 1) !important;
        }
        .dark-mode .date-chip {
            background: rgba(102, 126, 234, 0.18) !important;
            border-color: rgba(102, 126, 234, 0.25) !important;
            color: rgba(224, 231, 255, 0.95) !important;
        }

        /* Modal: slightly more classic */
        #genericModal > div, #notesModal > div, #timerModal > div {
            border-radius: 16px !important;
        }

        /* =========================================================
           RIGHT ACTION DOCK (Icons + Tooltips)
        ========================================================= */
        .action-dock {
            position: fixed;
            right: 16px;
            left: auto;
            top: 78px;
            z-index: 1600;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            border-radius: 16px;
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(15, 23, 42, 0.10);
            box-shadow: 0 12px 30px rgba(2, 6, 23, 0.10);
        }
        .dark-mode .action-dock {
            background: rgba(22, 33, 62, 0.96);
            border-color: rgba(255,255,255,0.10);
            box-shadow: 0 18px 45px rgba(0,0,0,0.35);
        }

        .dock-btn {
            position: relative;
            width: 46px;
            height: 46px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            color: white;
            font-size: 18px;
            font-weight: 800;
            border: 1px solid rgba(255,255,255,0.18);
            box-shadow: 0 10px 22px rgba(2, 6, 23, 0.14);
            transition: transform 140ms ease, filter 140ms ease;
            cursor: pointer;
            user-select: none;
        }
        .dock-btn:hover { transform: translateY(-1px); filter: brightness(1.05); }

        /* Tooltip (shows purpose on hover) */
        .dock-btn::after {
            content: attr(data-tip);
            position: absolute;
            right: calc(100% + 12px);
            left: auto;
            top: 50%;
            transform: translateY(-50%) translateX(4px);
            opacity: 0;
            pointer-events: none;
            white-space: nowrap;
            font-size: 12px;
            font-weight: 800;
            padding: 8px 10px;
            border-radius: 12px;
            color: rgba(255,255,255,0.96);
            background: rgba(15, 23, 42, 0.92);
            border: 1px solid rgba(255,255,255,0.10);
            box-shadow: 0 18px 40px rgba(2, 6, 23, 0.28);
            transition: opacity 120ms ease, transform 120ms ease;
        }
        .dock-btn::before {
            content: '';
            position: absolute;
            right: calc(100% + 6px);
            left: auto;
            top: 50%;
            transform: translateY(-50%) translateX(4px);
            opacity: 0;
            width: 10px;
            height: 10px;
            background: rgba(15, 23, 42, 0.92);
            border-right: 1px solid rgba(255,255,255,0.10);
            border-top: 1px solid rgba(255,255,255,0.10);
            rotate: 45deg;
            transition: opacity 120ms ease, transform 120ms ease;
        }
        .dock-btn:hover::after, .dock-btn:hover::before {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
        }

        .dock-divider {
            height: 1px;
            margin: 2px 4px;
            background: rgba(15, 23, 42, 0.12);
        }
        .dark-mode .dock-divider { background: rgba(255,255,255,0.12); }

        @media (max-width: 768px) {
            .action-dock {
                top: auto;
                bottom: 14px;
                right: auto;
                left: 50%;
                transform: translateX(-50%);
                flex-direction: row;
                border-radius: 18px;
            }
            .dock-btn::after, .dock-btn::before { display: none; }
        }

        /* =========================================================
           USER THEME OVERRIDE (Provided CSS)
           Applies a clean modern "card" design across the app.
        ========================================================= */
        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --primary-2: var(--primary-dark);
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f8f9fa;
            --dark: #343a40;
            --bg: #f4f6fb;
            --card: #ffffff;
            --text: #2d3748;
            --border: #e2e8f0;

            /* compatibility with older styles */
            --dark-bg: #1a202c;
            --dark-card: #2d3748;
        }

        html, body { height: 100%; }
        body {
            background: var(--bg) !important;
            color: var(--text) !important;
            font-family: "Segoe UI", Tahoma, system-ui, -apple-system, Arial, sans-serif !important;
            min-height: 100vh;
        }

        /* Dark mode mapped to your variables */
        body.dark-mode {
            --bg: #1a202c;
            --card: #2d3748;
            --text: #edf2f7;
            --border: #4a5568;
            --light: #111827;
            --dark: #0f172a;

            background: var(--bg) !important;
            color: var(--text) !important;
        }

        /* Main container */
        .app-container {
            max-width: 1280px !important;
            margin: auto !important;
            padding: 24px 104px 28px 104px !important; /* room for dock + sidebar toggle */
        }
        @media (max-width: 768px) {
            .app-container { padding: 88px 16px 20px 16px !important; }
        }

        /* Cards */
        .glass, .glass-strong {
            background: var(--card) !important;
            border: 1px solid var(--border) !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08) !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }

        /* Tables */
        table {
            background: var(--card) !important;
            border: 1px solid var(--border) !important;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
        }
        table thead { background: var(--light) !important; }
        table thead th {
            background: transparent !important;
            color: var(--text) !important;
            font-weight: 800;
        }
        td {
            border-color: var(--border) !important;
            color: var(--text) !important;
        }
        .dark-mode td { border-color: var(--border) !important; }

        /* Inputs */
        input, textarea, select {
            background: var(--card) !important;
            color: var(--text) !important;
            border-color: var(--border) !important;
        }

        /* Sidebar (match page palette + strong contrast) */
        .sidebar {
            /* override inline background */
            background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(248,250,252,0.96)) !important;
            color: var(--text) !important;
            border-right: 1px solid var(--border) !important;
            box-shadow: 8px 0 26px rgba(2, 6, 23, 0.10) !important;
        }

        body.dark-mode .sidebar {
            background: linear-gradient(180deg, rgba(15,23,42,0.96), rgba(2,6,23,0.96)) !important;
            color: rgba(255,255,255,0.92) !important;
            border-right: 1px solid rgba(255,255,255,0.10) !important;
            box-shadow: 8px 0 30px rgba(0,0,0,0.45) !important;
        }

        /* Sidebar typography + readable colors */
        .sidebar h2 { color: rgba(30, 41, 59, 0.95) !important; }
        body.dark-mode .sidebar h2 { color: rgba(224, 231, 255, 0.95) !important; }

        .sidebar nav .menu-item,
        .sidebar-section-toggle,
        .sidebar-subitem {
            color: rgba(15,23,42,0.92) !important;
        }
        body.dark-mode .sidebar nav .menu-item,
        body.dark-mode .sidebar-section-toggle,
        body.dark-mode .sidebar-subitem {
            color: rgba(255,255,255,0.92) !important;
        }

        /* Sub-panels inside sidebar */
        #monthMenu, #subjectMenu {
            background: rgba(15, 23, 42, 0.04) !important;
            border: 1px solid rgba(15, 23, 42, 0.06) !important;
        }
        body.dark-mode #monthMenu, body.dark-mode #subjectMenu {
            background: rgba(255,255,255,0.06) !important;
            border: 1px solid rgba(255,255,255,0.08) !important;
        }

        /* Hover states aligned with theme */
        .sidebar nav .menu-item:hover,
        .sidebar-section-toggle:hover,
        .sidebar-subitem:hover {
            background: rgba(102, 126, 234, 0.12) !important;
        }
        body.dark-mode .sidebar nav .menu-item:hover,
        body.dark-mode .sidebar-section-toggle:hover,
        body.dark-mode .sidebar-subitem:hover {
            background: rgba(255,255,255,0.08) !important;
        }

        /* Date chip */
        .date-chip {
            background: rgba(102, 126, 234, 0.12) !important;
            border-color: rgba(102, 126, 234, 0.25) !important;
            color: var(--text) !important;
        }

        /* Action dock matches cards */
        .action-dock {
            background: var(--card) !important;
            border-color: var(--border) !important;
        }

        /* Buttons (keep existing gradients, but improve base feel) */
        .btn-glow { border-radius: 10px !important; }

        /* =========================================================
           BOUNCY HOVER (Cards/Boxes)
        ========================================================= */
        @keyframes softBounce {
            0% { transform: translateY(0) scale(1); }
            45% { transform: translateY(-4px) scale(1.01); }
            75% { transform: translateY(1px) scale(0.995); }
            100% { transform: translateY(0) scale(1); }
        }

        /* Micro-bounce (for specific table items like date/topic only) */
        @keyframes microBounce {
            0% { transform: translateY(0) scale(1); }
            42% { transform: translateY(-3px) scale(1.01); }
            72% { transform: translateY(1px) scale(0.995); }
            100% { transform: translateY(0) scale(1); }
        }

        .hover-bounce {
            display: inline-block;
            will-change: transform;
        }
        .hover-bounce:hover {
            animation: microBounce 360ms cubic-bezier(.34, 1.56, .64, 1);
        }

        /* Use alongside existing components (e.g., <div class="date-chip bounceable">) */
        .bounceable {
            will-change: transform;
        }
        .bounceable:hover {
            animation: microBounce 360ms cubic-bezier(.34, 1.56, .64, 1);
        }

        .glass, .glass-strong {
            will-change: transform;
            transition: box-shadow 200ms ease, transform 200ms ease;
        }

        /* Card bounce is opt-in (dashboard only). */
        .bouncy-card {
            will-change: transform;
            transition: box-shadow 200ms ease, transform 200ms ease;
        }
        .bouncy-card:hover {
            animation: softBounce 420ms cubic-bezier(.34, 1.56, .64, 1);
            box-shadow: 0 16px 34px rgba(2, 6, 23, 0.12) !important;
        }

        /* Sidebar should NOT bounce as a whole (disable card hover bounce on sidebar container) */
        .sidebar.glass:hover,
        .sidebar.glass-strong:hover,
        .sidebar:hover {
            animation: none !important;
            transform: none !important;
        }

        /* Instead, bounce each individual navigation line item */
        .sidebar nav .menu-item,
        .sidebar-section-toggle,
        .sidebar-subitem {
            will-change: transform;
            transform-origin: left center;
        }
        .sidebar nav .menu-item:hover,
        .sidebar-section-toggle:hover,
        .sidebar-subitem:hover {
            animation: microBounce 360ms cubic-bezier(.34, 1.56, .64, 1);
        }

        /* Disable card hover animation for specific surfaces (login + monthly + subject table cards) */
        .no-hover-card.glass:hover,
        .no-hover-card.glass-strong:hover {
            animation: none !important;
            transform: none !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08) !important;
        }

        .dark-mode .no-hover-card.glass:hover,
        .dark-mode .no-hover-card.glass-strong:hover {
            animation: none !important;
            transform: none !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.22) !important;
        }

        @media (prefers-reduced-motion: reduce) {
            .bouncy-card:hover,
            .hover-bounce:hover,
            .bounceable:hover,
            .table-row-hover:hover {
                animation: none !important;
                transform: none !important;
            }
        }

        /* =========================================================
           UI POLISH: Sizing & Layout Harmony
        ========================================================= */
        #mainApp main h1 { letter-spacing: -0.02em; }
        #mainApp main h2 { letter-spacing: -0.015em; }
        #mainApp main h3 { letter-spacing: -0.01em; }

        /* Buttons: consistent sizing (exclude dock + sidebar toggle) */
        #mainApp button:not(.dock-btn):not(.w-12):not(.h-12) {
            min-height: 44px;
            font-size: 14px;
            line-height: 1.1;
        }
        #authScreen button {
            min-height: 44px;
            font-size: 14px;
            line-height: 1.1;
        }

        /* Action dock: slightly more premium */
        .dock-btn {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            font-size: 18px;
        }

        /* Sidebar navigation sizing */
        .sidebar nav .menu-item,
        .sidebar-section-toggle {
            min-height: 46px;
            font-size: 14px;
        }
        .sidebar-subitem {
            min-height: 40px;
            font-size: 13px;
        }

        /* Tables: improve density/whitespace balance */
        table th.p-3 { padding: 14px 16px !important; }
        table td.p-3 { padding: 12px 16px !important; }
        table th.p-2 { padding: 12px 14px !important; }
        table td.p-2 { padding: 10px 14px !important; }

        /* Dashboard subject cards: more consistent height */
        #subjectCards > div { min-height: 132px; }

        /* Inputs: comfortable tap targets */
        input, select, textarea {
            min-height: 42px;
        }
        textarea { min-height: 120px; }

        /* Print */
        @media print {
            body { background: white !important; color: #000 !important; }
            .glass, .glass-strong, table { box-shadow: none !important; }
        }

        /* =========================================================
           TYPOGRAPHY + SPACING POLISH (Lato)
        ========================================================= */
        html, body {
            font-family: 'Lato', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif !important;
            text-rendering: geometricPrecision;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Stronger hierarchy */
        #mainApp main h1 { font-weight: 900 !important; }
        #mainApp main h2 { font-weight: 900 !important; }
        #mainApp main h3 { font-weight: 800 !important; }
        #mainApp main h4 { font-weight: 800 !important; }

        /* Make small labels readable */
        #mainApp .text-xs { font-weight: 700 !important; letter-spacing: 0.02em; }
        #mainApp .text-sm { font-weight: 700; }

        /* More breathing space inside card-like surfaces */
        .glass.rounded-3xl,
        .glass-strong.rounded-3xl {
            padding: 26px !important;
        }
        /* Don‚Äôt affect cards that already set their own padding strongly */
        .glass.rounded-3xl.p-4,
        .glass.rounded-3xl.p-5,
        .glass.rounded-3xl.p-6,
        .glass-strong.rounded-3xl.p-8,
        .glass-strong.rounded-3xl.p-10 {
            padding: unset !important;
        }

        /* Bigger cards + nicer spacing */
        #tab-overview .grid { gap: 18px !important; }
        #subjectCards { gap: 18px !important; }
        #subjectCards > div {
            min-height: 132px;
            padding: 18px !important;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Dashboard stat tiles: richer typography */
        #statProgress, #statStreak, #statHours, #statDays {
            font-weight: 900 !important;
            letter-spacing: -0.02em;
        }

        /* Tables: a little more editorial */
        table thead th {
            font-weight: 900 !important;
            font-size: 13px !important;
        }
        table td {
            font-weight: 600;
        }

        /* Sidebar titles feel premium */
        .sidebar h2 {
            font-weight: 900 !important;
            letter-spacing: -0.01em;
        }

        /* =========================================================
           FONT SCALE TUNING (Option B felt too large)
           Reduce overall rem scale slightly + minor heading tweaks.
        ========================================================= */
        html { font-size: 15px !important; }
        @media (max-width: 768px) {
            html { font-size: 14.5px !important; }
        }

        /* Keep dashboard stats strong but a touch more compact */
        #statProgress, #statStreak, #statHours, #statDays {
            font-size: 2.25rem; /* ~36px at 16px base; scales with html font-size */
        }
        @media (max-width: 768px) {
            #statProgress, #statStreak, #statHours, #statDays { font-size: 2.05rem; }
        }


        /* =========================================================
           Sidebar active state + icon visibility (light sidebar)
        ========================================================= */
        .sidebar nav .menu-item.active {
            background: rgba(102, 126, 234, 0.14) !important;
            border-left-color: var(--primary) !important;
        }
        body.dark-mode .sidebar nav .menu-item.active {
            background: rgba(255,255,255,0.10) !important;
            border-left-color: rgba(199, 210, 254, 0.85) !important;
        }

        /* Stronger icon badge contrast for light sidebar */
        .sidebar nav .menu-item > span:first-child,
        .sidebar-section-toggle span > span:first-child,
        .sidebar-subitem .subitem-icon {
            background: rgba(99,102,241,0.18) !important;
            border-color: rgba(99,102,241,0.26) !important;
        }
        body.dark-mode .sidebar nav .menu-item > span:first-child,
        body.dark-mode .sidebar-section-toggle span > span:first-child,
        body.dark-mode .sidebar-subitem .subitem-icon {
            background: rgba(255,255,255,0.08) !important;
            border-color: rgba(255,255,255,0.12) !important;
        }

        /* =========================================================
           Right tool dock as tall stacked buttons
        ========================================================= */
        .dock-btn {
            width: 52px;
            height: 64px;
            border-radius: 18px;
            font-size: 20px;
        }
        .action-dock {
            padding: 12px;
            border-radius: 20px;
        }

        /* =========================================================
           Dashboard subject tiles: pastel tile style
        ========================================================= */
        .subject-tile {
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        .subject-tile:hover { box-shadow: 0 16px 34px rgba(2, 6, 23, 0.12) !important; }

        @media (max-width: 768px) {
            .status-bar { height: 36px; }
        }

        /* =========================================================
           SIDEBAR: DESKTOP PIN + COLLAPSE (Icon rail)
        ========================================================= */
        body.sidebar-pinned .sidebar {
            left: 0 !important;
            transform: translateX(0) !important;
        }
        body.sidebar-pinned .overlay {
            display: none !important;
        }

        /* Make room for pinned sidebar */
        body.sidebar-pinned .app-container {
            padding-left: 336px !important;
        }
        body.sidebar-pinned.sidebar-collapsed .app-container {
            padding-left: 140px !important;
        }

        /* Collapsed sidebar (icon-only) */
        .sidebar.collapsed {
            width: 92px !important;
        }
        .sidebar.collapsed #monthMenu,
        .sidebar.collapsed #subjectMenu {
            display: none !important;
        }
        .sidebar.collapsed .item-label,
        .sidebar.collapsed .subitem-label,
        .sidebar.collapsed .subj-pct,
        .sidebar.collapsed #monthMenuArrow,
        .sidebar.collapsed #subjectMenuArrow,
        .sidebar.collapsed .sidebar-subtitle,
        .sidebar.collapsed .sidebar-email {
            display: none !important;
        }

        /* Center icons in collapsed state */
        .sidebar.collapsed .menu-item,
        .sidebar.collapsed .sidebar-section-toggle,
        .sidebar.collapsed .sidebar-subitem {
            justify-content: center !important;
            gap: 0 !important;
            padding-left: 12px !important;
            padding-right: 12px !important;
        }

        /* Tooltips for collapsed items */
        .sidebar [data-tip] { position: relative; }
        .sidebar.collapsed [data-tip]::after {
            content: attr(data-tip);
            position: absolute;
            left: calc(100% + 10px);
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            pointer-events: none;
            white-space: nowrap;
            font-size: 12px;
            font-weight: 900;
            padding: 8px 10px;
            border-radius: 12px;
            color: rgba(255,255,255,0.96);
            background: rgba(15, 23, 42, 0.92);
            border: 1px solid rgba(255,255,255,0.10);
            box-shadow: 0 18px 40px rgba(2, 6, 23, 0.28);
            transition: opacity 120ms ease, transform 120ms ease;
        }
        .sidebar.collapsed [data-tip]:hover::after {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
        }

        /* Sidebar header collapse button */
        .collapse-btn {
            width: 34px;
            height: 34px;
            border-radius: 12px;
            display: grid;
            place-items: center;
            font-weight: 900;
            background: rgba(99,102,241,0.14);
            border: 1px solid rgba(99,102,241,0.22);
            color: rgba(30,41,59,0.92);
        }
        body.dark-mode .collapse-btn {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.12);
            color: rgba(226,232,240,0.92);
        }

        @media (max-width: 1023px) {
            body.sidebar-pinned .app-container { padding-left: 104px !important; }
            body.sidebar-pinned.sidebar-collapsed .app-container { padding-left: 104px !important; }
        }
    </style>
</head>
<body class="min-h-screen antialiased">
    <!-- Auth Screen (Firebase Authentication) -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-6 relative" aria-hidden="false">
        <!-- Decorative blobs -->
        <div class="absolute -top-24 -left-24 w-96 h-96 bg-indigo-500/35 blur-3xl rounded-full"></div>
        <div class="absolute -bottom-28 -right-24 w-[28rem] h-[28rem] bg-fuchsia-500/30 blur-3xl rounded-full"></div>
        <div class="absolute top-1/3 left-1/2 -translate-x-1/2 w-[38rem] h-[14rem] bg-emerald-400/15 blur-3xl rounded-full"></div>

        <div class="w-full max-w-md glass-strong no-hover-card rounded-3xl p-8 sm:p-10 relative soft-ring">
            <div class="text-center mb-8">
                <div class="mx-auto w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-500 to-fuchsia-500 text-white flex items-center justify-center text-2xl shadow-lg">üéØ</div>
                <h1 class="text-3xl font-extrabold mt-4 tracking-tight"><span class="gradient-text">WBCS 2026</span></h1>
                <p class="text-slate-600 dark:text-slate-300 mt-2">Interactive Study Portal ‚Ä¢ Firestore Powered</p>
            </div>

            <div id="authTabs" class="grid grid-cols-2 bg-white/50 rounded-2xl p-1 border border-white/60 shadow-sm">
                <button onclick="showAuthTab('login')" id="loginTab" class="py-2.5 rounded-xl bg-gradient-to-r from-indigo-500 to-fuchsia-500 text-white font-bold transition btn-glow">Login</button>
                <button onclick="showAuthTab('register')" id="registerTab" class="py-2.5 rounded-xl text-slate-700 font-bold transition">Register</button>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="mt-6">
                <div class="mb-4">
                    <label class="block text-slate-700 font-bold mb-2">Email</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white/70" placeholder="you@email.com" autocomplete="username">
                </div>
                <div class="mb-6">
                    <label class="block text-slate-700 font-bold mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white/70" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                </div>
                <button onclick="handleLogin()" class="w-full py-3 rounded-2xl font-extrabold text-white bg-gradient-to-r from-indigo-500 to-fuchsia-500 hover:brightness-110 transition shadow-lg btn-glow">Sign In</button>
                <p class="text-xs text-slate-500 mt-4 text-center">Tip: Admin panel is available when your user is marked as <span class="font-semibold">isAdmin</span> in Firestore (optional).</p>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden mt-6">
                <div class="mb-4">
                    <label class="block text-slate-700 font-bold mb-2">Full Name</label>
                    <input type="text" id="regName" class="w-full px-4 py-3 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white/70" placeholder="Your Name" autocomplete="name">
                </div>
                <div class="mb-4">
                    <label class="block text-slate-700 font-bold mb-2">Email</label>
                    <input type="email" id="regEmail" class="w-full px-4 py-3 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white/70" placeholder="you@email.com" autocomplete="username">
                </div>
                <div class="mb-6">
                    <label class="block text-slate-700 font-bold mb-2">Password</label>
                    <input type="password" id="regPassword" class="w-full px-4 py-3 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white/70" placeholder="Min 6 characters" autocomplete="new-password">
                </div>
                <button onclick="handleRegister()" class="w-full py-3 rounded-2xl font-extrabold text-white bg-gradient-to-r from-emerald-500 to-teal-500 hover:brightness-110 transition shadow-lg btn-glow">Create Account</button>
            </div>

            <div id="authError" class="mt-4 text-rose-600 text-center hidden font-semibold"></div>
            <div id="authLoader" class="hidden"><div class="loader"></div></div>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="mainApp" class="hidden">
        <!-- Sidebar Toggle -->
        <button onclick="toggleSidebar()" class="fixed left-4 top-4 z-50 text-white w-12 h-12 rounded-2xl shadow-lg flex items-center justify-center text-xl no-print transition btn-glow"
                style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
            ‚ò∞
        </button>

        <!-- Right Action Dock (like screenshot) -->
        <div class="action-dock no-print" id="actionDock" aria-label="Quick actions">
            <button class="dock-btn btn-glow" data-tip="Theme" onclick="toggleDarkMode()" style="background: linear-gradient(135deg, #334155, #475569);">üåô</button>
            <button class="dock-btn btn-glow" data-tip="Save (Backup)" onclick="exportData()" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">üíæ</button>
            <button class="dock-btn btn-glow" data-tip="Upload (Restore)" onclick="importData()" style="background: linear-gradient(135deg, #fde047, #f59e0b); color: #0f172a; border-color: rgba(15,23,42,0.10);">‚¨ÜÔ∏è</button>
            <button class="dock-btn btn-glow" data-tip="Print" onclick="window.print()" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">üñ®Ô∏è</button>
            <button class="dock-btn btn-glow" data-tip="Settings" onclick="openSettingsModal()" style="background: linear-gradient(135deg, #7c3aed, #a855f7);">‚öôÔ∏è</button>
            <button class="dock-btn btn-glow" data-tip="Lock (Logout)" onclick="handleLogout()" style="background: linear-gradient(135deg, #ef4444, #f43f5e);">üîí</button>
        </div>

        <!-- Overlay -->
        <div class="overlay fixed inset-0 bg-black/50 z-40" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside class="sidebar fixed left-0 top-0 w-72 h-full z-50 overflow-y-auto no-print glass" id="appSidebar"
               style="border-top-right-radius: 18px; border-bottom-right-radius: 18px;">
            <div class="p-6 border-b" style="border-color: rgba(255,255,255,0.10);">
                <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-fuchsia-500 flex items-center justify-center shadow">üéØ</div>
                        <div class="min-w-0">
                            <h2 class="text-lg font-extrabold truncate">WBCS 2026</h2>
                            <p class="text-xs opacity-70 sidebar-subtitle truncate">Interactive Study Portal</p>
                        </div>
                    </div>
                    <button class="collapse-btn no-print" title="Collapse sidebar" onclick="toggleSidebarCollapse()">‚´∂</button>
                </div>
                <p class="text-xs font-extrabold mt-3 sidebar-email truncate" id="sidebarUserEmail"></p>
                <div class="mt-3 flex gap-2 no-print">
                    <button class="status-mini-btn" onclick="toggleSidebarPin()" title="Pin sidebar">Pin</button>
                </div>
            </div>

            <nav class="py-4">
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" data-tip="Dashboard" onclick="switchTab('overview')">
                    <span>üìä</span> <span class="item-label">Dashboard</span>
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" data-tip="Weekday Routine" onclick="switchTab('weekday')">
                    <span>üìÖ</span> <span class="item-label">Weekday Routine</span>
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" data-tip="Weekend Routine" onclick="switchTab('weekend')">
                    <span>üåÖ</span> <span class="item-label">Weekend Routine</span>
                </div>

                <div class="sidebar-section-toggle cursor-pointer hover:bg-white/10 flex items-center justify-between" data-tip="Monthly Schedules" onclick="toggleSubmenu('monthMenu')">
                    <span class="flex items-center gap-3"><span>üìÜ</span> <span class="item-label">Monthly Schedules</span></span>
                    <span id="monthMenuArrow">‚ñº</span>
                </div>
                <div id="monthMenu" class="hidden" style="background: rgba(2, 6, 23, 0.40);"></div>

                <div class="sidebar-section-toggle cursor-pointer hover:bg-white/10 flex items-center justify-between" data-tip="Subjects" onclick="toggleSubmenu('subjectMenu')">
                    <span class="flex items-center gap-3"><span>üìö</span> <span class="item-label">Subjects</span></span>
                    <span id="subjectMenuArrow">‚ñº</span>
                </div>
                <div id="subjectMenu" class="hidden" style="background: rgba(2, 6, 23, 0.40);">
                    <div class="sidebar-subitem cursor-pointer hover:bg-white/10 text-sm" data-tip="All Subjects" onclick="switchTab('subjects')">üìö <span class="subitem-label">All Subjects</span></div>
                    <div class="sidebar-subitem text-emerald-300 cursor-pointer hover:bg-white/10 text-sm" data-tip="Add Subject" onclick="createNewSubject()">‚ûï <span class="subitem-label">Add Subject</span></div>
                    <div id="subjectMenuList"></div>
                </div>

                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" data-tip="Test Tracker" onclick="switchTab('tests')">
                    <span>‚úÖ</span> <span class="item-label">Test Tracker</span>
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" data-tip="Analytics" onclick="switchTab('analytics')">
                    <span>üìà</span> <span class="item-label">Analytics</span>
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" data-tip="Cutoff Analytics" onclick="switchTab('cutoff')">
                    <span>üéØ</span> <span class="item-label">Cutoff Analytics</span>
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" data-tip="Global Notes" onclick="openNotesModal()">
                    <span>üìù</span> <span class="item-label">Global Notes</span>
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" data-tip="Session Timer" onclick="openTimerModal()">
                    <span>‚è±Ô∏è</span> <span class="item-label">Session Timer</span>
                </div>

                <!-- Admin Menu (visible for admins) -->
                <div id="adminMenuSection" class="hidden border-t mt-4 pt-4" style="border-color: rgba(255,255,255,0.10);">
                    <div class="px-6 py-2 text-xs text-slate-300/70 uppercase item-label">Admin Panel</div>
                    <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-yellow-400 transition flex items-center gap-3 text-yellow-300" data-tip="Manage Blueprints" onclick="switchTab('admin')">
                        <span>‚öôÔ∏è</span> <span class="item-label">Manage Blueprints</span>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="app-container transition-all">
            <!-- Header -->
            <header class="relative overflow-hidden rounded-3xl mb-6 no-print glass">
                <div class="absolute inset-0" style="background: linear-gradient(135deg, rgba(99,102,241,0.92), rgba(217,70,239,0.78));"></div>
                <div class="absolute -top-20 -right-20 w-72 h-72 bg-white/15 blur-2xl rounded-full"></div>
                <div class="absolute -bottom-24 -left-24 w-72 h-72 bg-white/15 blur-2xl rounded-full"></div>
                <div class="relative p-7 text-white">
                    <div class="flex flex-wrap items-start justify-between gap-3">
                        <div>
                            <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">üéØ WBCS Exam Preparation 2026</h1>
                            <p class="text-white/90 mt-1">Plan with clarity ‚Ä¢ Track with confidence ‚Ä¢ Finish strong for WBCS 2026</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-white/80 font-bold">Signed in</div>
                            <div id="userEmailDisplay" class="text-sm font-extrabold text-white/95"></div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Controls moved to left action dock -->

            <!-- Tab Contents -->
            <!-- Overview Tab -->
            <div id="tab-overview" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-7">
                    <div class="glass bouncy-card rounded-3xl p-7 border-l-4 border-indigo-500">
                        <h3 class="text-sm uppercase text-slate-500 font-extrabold tracking-wider">Overall Progress</h3>
                        <div class="text-4xl font-extrabold text-indigo-600 mt-3" id="statProgress">0%</div>
                        <div class="h-3 bg-white/70 rounded-full mt-4 overflow-hidden">
                            <div class="progress-bar h-full" id="progressBar" style="width: 0%; background: linear-gradient(90deg, var(--primary), var(--primary-2));"></div>
                        </div>
                    </div>
                    <div class="glass bouncy-card rounded-3xl p-7 border-l-4 border-emerald-500">
                        <h3 class="text-sm uppercase text-slate-500 font-extrabold tracking-wider">Study Streak</h3>
                        <div class="text-4xl font-extrabold text-emerald-600 mt-3" id="statStreak">0 days</div>
                        <div class="text-xs text-slate-500 mt-2 font-bold">Keep it alive daily</div>
                    </div>
                    <div class="glass bouncy-card rounded-3xl p-7 border-l-4 border-sky-500">
                        <h3 class="text-sm uppercase text-slate-500 font-extrabold tracking-wider">Total Hours</h3>
                        <div class="text-4xl font-extrabold text-sky-600 mt-3" id="statHours">0.0h</div>
                        <div class="text-xs text-slate-500 mt-2 font-bold">Completed task hours</div>
                    </div>
                    <div class="glass bouncy-card rounded-3xl p-7 border-l-4 border-rose-500">
                        <h3 class="text-sm uppercase text-slate-500 font-extrabold tracking-wider">Days to Exam</h3>
                        <div class="text-4xl font-extrabold text-rose-600 mt-3" id="statDays">0</div>
                        <div class="text-xs text-slate-500 mt-2 font-bold">Until 20 Mar 2026</div>
                    </div>
                </div>

                <div class="glass bouncy-card rounded-3xl p-8 mb-7">
                    <h3 class="text-xl font-extrabold text-slate-800 mb-3">üìã Preparation Summary</h3>
                    <p class="text-slate-700 text-base">Target Date: <strong class="text-indigo-700" style="text-decoration: underline;">20 March 2026 (Preliminary)</strong></p>
                    <p class="text-slate-600 mt-2 text-sm">Your plan includes comprehensive GS coverage with regular mock tests and rescheduling support per user.</p>
                </div>

                <div class="glass bouncy-card rounded-3xl p-8 mb-7">
                    <div class="flex items-center justify-between gap-3 mb-4">
                        <h3 class="text-xl font-extrabold text-slate-800">üìå Daily Focus</h3>
                        <div id="todayDateChip" class="date-chip">Today</div>
                    </div>
                    <div id="todayMeta" class="text-sm text-slate-600 font-bold mb-3"></div>
                    <div id="todaySchedule" class="divide-y divide-black/5"></div>
                </div>

                <h2 class="text-xl font-extrabold text-slate-800 mb-4">üìö Quick Subject Access</h2>
                <div id="subjectCards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </div>

            <!-- Weekday Tab -->
            <div id="tab-weekday" class="tab-content">
                <h2 class="text-2xl font-extrabold text-slate-800 mb-4">üìÖ Weekday Routine</h2>
                <div class="glass rounded-3xl overflow-hidden">
                    <table class="w-full">
                        <thead class="text-white" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                            <tr>
                                <th class="p-3 text-left">Time</th>
                                <th class="p-3 text-left">Activity</th>
                                <th class="p-3 text-left">Details</th>
                                <th class="p-3 text-left">Duration</th>
                            </tr>
                        </thead>
                        <tbody id="weekdayTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Weekend Tab -->
            <div id="tab-weekend" class="tab-content">
                <h2 class="text-2xl font-extrabold text-slate-800 mb-4">üåÖ Weekend Routine</h2>
                <h3 class="text-lg font-bold text-slate-700 mb-2">Saturday</h3>
                <div class="glass rounded-3xl overflow-hidden mb-6">
                    <table class="w-full">
                        <thead class="text-white" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                            <tr><th class="p-3 text-left">Time</th><th class="p-3 text-left">Activity</th><th class="p-3 text-left">Details</th><th class="p-3 text-left">Duration</th></tr>
                        </thead>
                        <tbody id="saturdayTable"></tbody>
                    </table>
                </div>
                <h3 class="text-lg font-bold text-slate-700 mb-2">Sunday</h3>
                <div class="glass rounded-3xl overflow-hidden">
                    <table class="w-full">
                        <thead class="text-white" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                            <tr><th class="p-3 text-left">Time</th><th class="p-3 text-left">Activity</th><th class="p-3 text-left">Details</th><th class="p-3 text-left">Duration</th></tr>
                        </thead>
                        <tbody id="sundayTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Monthly Tabs (Dynamic) -->
            <div id="monthlyTabs"></div>

            <!-- Subjects Tab (Manage + Overview) -->
            <div id="tab-subjects" class="tab-content">
                <div class="flex flex-wrap items-end justify-between gap-3 mb-4">
                    <div>
                        <h2 class="text-2xl font-extrabold text-slate-800">üìö Subjects</h2>
                        <p class="text-slate-600 mt-1">Add subjects, track progress, and open a subject to schedule/reschedule topics.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="createNewSubject()" class="px-4 py-2 rounded-2xl text-sm font-extrabold text-white btn-glow" style="background: linear-gradient(135deg, #22c55e, #10b981);">‚ûï Add Subject</button>
                    </div>
                </div>

                <div class="glass rounded-3xl overflow-hidden">
                    <table class="w-full">
                        <thead class="text-white" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                            <tr>
                                <th class="p-3 text-left">Subject</th>
                                <th class="p-3 text-left">Progress</th>
                                <th class="p-3 text-left">Topics</th>
                                <th class="p-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subjectsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Subject View Tab -->
            <div id="tab-subject-view" class="tab-content">
                <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
                    <h2 class="text-2xl font-extrabold" id="subjectViewTitle">Subject</h2>
                    <button onclick="deleteCurrentSubject()" class="px-4 py-2 rounded-2xl text-sm font-extrabold text-white btn-glow" style="background: linear-gradient(135deg, #ef4444, #f43f5e);">üóëÔ∏è Delete Subject</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="text-white" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                            <tr>
                                <th class="p-3 text-left">Topic</th>
                                <th class="p-3 text-left">Date (editable)</th>
                                <th class="p-3 text-left">Day</th>
                                <th class="p-3 text-left">Hours</th>
                                <th class="p-3 text-left">Status</th>
                                <th class="p-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subjectTopicsTable"></tbody>
                    </table>
                </div>
                <button onclick="addTopicToSubject()" class="mt-4 px-4 py-2 rounded-2xl font-extrabold text-white btn-glow" style="background: linear-gradient(135deg, #22c55e, #10b981);">‚ûï Add Topic</button>
            </div>

            <!-- Tests Tab -->
            <div id="tab-tests" class="tab-content">
                <div class="flex flex-wrap items-end justify-between gap-3 mb-4">
                    <div>
                        <h2 class="text-2xl font-extrabold text-slate-800">‚úÖ Test Tracker</h2>
                        <p class="text-slate-600 mt-1">Reschedule blueprint tests per-user, or add your own subject/mixed/full mock tests (stored in your Firestore profile).</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="openAddPersonalTestModal()" class="px-4 py-2 rounded-2xl text-sm font-extrabold text-white btn-glow" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">‚ûï Add Personal Test</button>
                    </div>
                </div>

                <div class="glass rounded-3xl overflow-x-auto">
                    <table class="w-full">
                        <thead class="text-white" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                            <tr>
                                <th class="p-3 text-left">Test</th>
                                <th class="p-3 text-left">Date (editable)</th>
                                <th class="p-3 text-left">Type</th>
                                <th class="p-3 text-left">MCQs</th>
                                <th class="p-3 text-left">Focus</th>
                                <th class="p-3 text-left">Target</th>
                                <th class="p-3 text-left">Score</th>
                                <th class="p-3 text-left">%</th>
                                <th class="p-3 text-left">Status</th>
                                <th class="p-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="testsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="tab-analytics" class="tab-content">
                <h2 class="text-2xl font-extrabold text-slate-800 mb-4">üìà Progress Analytics</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass rounded-3xl p-6">
                        <h3 class="text-lg font-extrabold text-slate-800 mb-4">Subject Progress</h3>
                        <div id="subjectAnalytics"></div>
                    </div>
                    <div class="glass rounded-3xl p-6">
                        <h3 class="text-lg font-extrabold text-slate-800 mb-4">Weekly Study Hours</h3>
                        <div id="weeklyChart" class="h-48 flex items-end gap-2"></div>
                    </div>
                </div>
            </div>

            <!-- Cutoff Analytics Tab -->
            <div id="tab-cutoff" class="tab-content">
                <div class="flex flex-wrap items-end justify-between gap-3 mb-4">
                    <div>
                        <h2 class="text-2xl font-extrabold text-slate-800">üéØ Cutoff Analytics</h2>
                        <p class="text-slate-600 mt-1">Set your target cutoffs by test type and instantly see which tests are above/below cutoff.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveCutoffs()" class="px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #22c55e, #10b981);">üíæ Save Cutoffs</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="glass rounded-3xl p-6">
                        <h3 class="text-lg font-extrabold text-slate-800 mb-3">Cutoff Settings</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-extrabold text-slate-700 mb-1">Subject cutoff (out of 75)</label>
                                <input id="cutoffSubject" type="number" min="0" max="75" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="e.g., 55">
                            </div>
                            <div>
                                <label class="block text-sm font-extrabold text-slate-700 mb-1">Mixed cutoff (out of 75)</label>
                                <input id="cutoffMixed" type="number" min="0" max="75" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="e.g., 60">
                            </div>
                            <div>
                                <label class="block text-sm font-extrabold text-slate-700 mb-1">Full cutoff (out of 100)</label>
                                <input id="cutoffFull" type="number" min="0" max="100" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="e.g., 80">
                            </div>
                            <div>
                                <label class="block text-sm font-extrabold text-slate-700 mb-1">Full Mock / Final Mock cutoff (out of 200)</label>
                                <input id="cutoffFullMock" type="number" min="0" max="200" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="e.g., 150">
                            </div>
                        </div>
                        <div class="text-xs text-slate-500 mt-3">Saved per-user in Firestore.</div>
                    </div>

                    <div class="glass rounded-3xl p-6 lg:col-span-2">
                        <h3 class="text-lg font-extrabold text-slate-800 mb-3">Cutoff Summary</h3>
                        <div id="cutoffSummary" class="text-sm text-slate-600 font-bold"></div>
                        <div class="mt-4 overflow-x-auto">
                            <table class="w-full">
                                <thead class="text-white" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                                    <tr>
                                        <th class="p-3 text-left">Test</th>
                                        <th class="p-3 text-left">Date</th>
                                        <th class="p-3 text-left">Type</th>
                                        <th class="p-3 text-left">Score</th>
                                        <th class="p-3 text-left">Cutoff</th>
                                        <th class="p-3 text-left">Result</th>
                                    </tr>
                                </thead>
                                <tbody id="cutoffTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Tab -->
            <div id="tab-admin" class="tab-content">
                <h2 class="text-2xl font-extrabold text-slate-800 mb-4">‚öôÔ∏è Admin - Manage Blueprints</h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Manage Routines -->
                    <div class="glass rounded-3xl p-6">
                        <h3 class="text-lg font-extrabold text-slate-800 mb-4">üìÖ Manage Routines</h3>
                        <div class="space-y-2">
                            <button onclick="editRoutine('weekday')" class="w-full px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">Edit Weekday Routine</button>
                            <button onclick="editRoutine('saturday')" class="w-full px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">Edit Saturday Routine</button>
                            <button onclick="editRoutine('sunday')" class="w-full px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">Edit Sunday Routine</button>
                        </div>
                    </div>

                    <!-- Manage Subjects -->
                    <div class="glass rounded-3xl p-6">
                        <h3 class="text-lg font-extrabold text-slate-800 mb-4">üìö Manage Subjects</h3>
                        <div id="adminSubjectList" class="space-y-2 mb-4"></div>
                        <button onclick="adminAddSubject()" class="w-full px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #22c55e, #10b981);">‚ûï Add New Subject</button>
                    </div>
                </div>

                <!-- Manage Monthly Blueprint -->
                <div class="glass rounded-3xl p-6 mb-6">
                    <h3 class="text-lg font-extrabold text-slate-800 mb-4">üìÜ Manage Monthly Blueprints</h3>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <select id="adminMonthSelect" class="px-4 py-2 border rounded-2xl bg-white/70">
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                        <button onclick="loadAdminMonthTasks()" class="px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">Load Tasks</button>
                        <button onclick="adminAddTask()" class="px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #22c55e, #10b981);">‚ûï Add Task</button>
                    </div>
                    <div class="text-xs text-slate-500 mb-3">Tip: You can edit task dates inline (admin blueprint update).</div>
                    <div id="adminTasksList" class="overflow-x-auto"></div>
                </div>

                <!-- Manage Tests -->
                <div class="glass rounded-3xl p-6">
                    <h3 class="text-lg font-extrabold text-slate-800 mb-4">‚úÖ Manage Test Schedule</h3>
                    <button onclick="adminAddTest()" class="px-4 py-2 rounded-2xl text-white font-extrabold btn-glow mb-4" style="background: linear-gradient(135deg, #22c55e, #10b981);">‚ûï Add Test</button>
                    <div class="text-xs text-slate-500 mb-3">Tip: You can edit test dates inline (admin blueprint update).</div>
                    <div id="adminTestsList" class="overflow-x-auto"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Generic Modal -->
    <div id="genericModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-strong rounded-3xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-white/50 flex justify-between items-center">
                <h3 id="modalTitle" class="text-xl font-extrabold text-slate-800">Modal</h3>
                <button onclick="closeModal()" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div id="modalBody" class="p-6"></div>
            <div class="p-6 border-t border-white/50 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 rounded-2xl bg-slate-200 text-slate-800 font-bold hover:bg-slate-300 transition">Cancel</button>
                <button id="modalSubmit" class="px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">Save</button>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-strong rounded-3xl shadow-2xl w-full max-w-2xl">
            <div class="p-6 border-b border-white/50 flex justify-between items-center">
                <h3 class="text-xl font-extrabold text-slate-800">üìù Global Study Notes</h3>
                <button onclick="closeNotesModal()" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <textarea id="globalNotes" class="w-full h-64 p-4 border border-slate-200 rounded-2xl resize-none focus:ring-2 focus:ring-indigo-500 bg-white/70" placeholder="Write your study notes here..."></textarea>
            </div>
            <div class="p-6 border-t border-white/50">
                <button onclick="saveNotes()" class="w-full px-4 py-3 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #22c55e, #10b981);">üíæ Save Notes</button>
            </div>
        </div>
    </div>

    <!-- Timer Modal -->
    <div id="timerModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-strong rounded-3xl shadow-2xl w-full max-w-md text-center">
            <div class="p-6 border-b border-white/50 flex justify-between items-center">
                <h3 class="text-xl font-extrabold text-slate-800">‚è±Ô∏è Study Timer</h3>
                <button onclick="closeTimerModal()" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div class="p-8">
                <div id="timerDisplay" class="text-6xl font-mono font-extrabold text-indigo-600 mb-8">00:00:00</div>
                <div class="flex justify-center gap-3">
                    <button onclick="startTimer()" class="px-6 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #22c55e, #10b981);">‚ñ∂ Start</button>
                    <button onclick="pauseTimer()" class="px-6 py-2 rounded-2xl text-slate-900 font-extrabold btn-glow" style="background: linear-gradient(135deg, #fde047, #f59e0b);">‚è∏ Pause</button>
                    <button onclick="resetTimer()" class="px-6 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #ef4444, #f43f5e);">‚èπ Reset</button>
                </div>
                <button onclick="saveSession()" class="mt-6 px-6 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">üíæ Save Session</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal (matches screenshot ‚Äú‚öôÔ∏è‚Äù dock button) -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-strong rounded-3xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b border-white/50 flex justify-between items-center">
                <h3 class="text-xl font-extrabold text-slate-800">‚öôÔ∏è Settings & Tools</h3>
                <button onclick="closeSettingsModal()" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-3">
                <button onclick="syncData(); closeSettingsModal();" class="w-full px-4 py-3 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #22c55e, #10b981);">üîÑ Sync with Cloud</button>
                <button onclick="exportData();" class="w-full px-4 py-3 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">üíæ Download Backup</button>
                <button onclick="importData();" class="w-full px-4 py-3 rounded-2xl font-extrabold btn-glow" style="background: linear-gradient(135deg, #fde047, #f59e0b); color: #0f172a; border-color: rgba(15,23,42,0.10);">‚¨ÜÔ∏è Restore from Backup</button>
                <button onclick="window.print();" class="w-full px-4 py-3 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">üñ®Ô∏è Print</button>
                <button onclick="toggleDarkMode();" class="w-full px-4 py-3 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #334155, #475569);">üåô Toggle Theme</button>
                <button onclick="openNotionModal();" class="w-full px-4 py-3 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #0f766e, #14b8a6);">üß† Notion Sync</button>
                <div class="text-xs text-slate-500 font-bold pt-2">Tip: Your progress is saved per-user in Firestore.</div>
            </div>
        </div>
    </div>

    <!-- Notion Sync Modal -->
    <div id="notionModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-strong rounded-3xl shadow-2xl w-full max-w-xl">
            <div class="p-6 border-b border-white/50 flex justify-between items-center">
                <h3 class="text-xl font-extrabold text-slate-800">üß† Notion Sync</h3>
                <button onclick="closeNotionModal()" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-extrabold text-slate-700 mb-2">Integration Token</label>
                    <input id="notionToken" type="password" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="secret_...">
                </div>
                <div>
                    <label class="block text-sm font-extrabold text-slate-700 mb-2">Notion Database ID</label>
                    <input id="notionDbId" type="text" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="wbcs_preparation_tracker">
                    <div class="text-xs text-slate-500 mt-1">If you don't have a DB yet, create it below.</div>
                </div>
                <div>
                    <label class="block text-sm font-extrabold text-slate-700 mb-2">Parent Page ID (to create DB)</label>
                    <input id="notionParentPage" type="text" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="Paste a Notion page ID">
                    <div class="text-xs text-slate-500 mt-1">The integration must be shared with this page. We'll create a database named <strong>wbcs_preparation_tracker</strong>.</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button onclick="createNotionDatabase()" class="w-full px-4 py-3 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #7c3aed, #a855f7);">‚ûï Create Database</button>
                    <button onclick="syncToNotion(false)" class="w-full px-4 py-3 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">‚¨ÜÔ∏è Sync Now</button>
                </div>
                <div>
                    <label class="block text-sm font-extrabold text-slate-700 mb-2">Sync Scope</label>
                    <select id="notionScope" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                        <option value="all">All schedules (tasks + tests)</option>
                        <option value="tasks">Only tasks</option>
                        <option value="tests">Only tests</option>
                    </select>
                </div>
                <label class="flex items-center gap-2 text-sm font-extrabold text-slate-700">
                    <input id="notionUseProxy" type="checkbox" class="w-4 h-4" checked>
                    Use CORS proxy (recommended for browser)
                </label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button onclick="syncToNotion(true)" class="w-full px-4 py-3 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #22c55e, #10b981);">üîÅ Upsert (create/update)</button>
                    <button onclick="openNotionHelp()" class="w-full px-4 py-3 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #334155, #475569);">‚ùì How to find IDs</button>
                </div>
                <div id="notionStatus" class="text-sm text-slate-600 font-bold"></div>
                <div class="text-xs text-slate-500">
                    Required Notion DB properties: <strong>Name</strong> (title), <strong>Date</strong> (date), <strong>Type</strong> (select), <strong>Subject</strong> (select), <strong>Status</strong> (select), <strong>Notes</strong> (rich text), <strong>Hours</strong> (number). If the sync fails in browser, keep the proxy enabled.
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFile" class="hidden" accept=".json" onchange="handleImport(event)">

    <!-- Firebase (compat SDKs) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // =============================================
        // FIREBASE AUTH CONFIG
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAThe1_F61AYEZtXl6ISwNkd6D0XMSgg3k",
            authDomain: "wbcs-progress-tracker-30fa6.firebaseapp.com",
            projectId: "wbcs-progress-tracker-30fa6",
            storageBucket: "wbcs-progress-tracker-30fa6.firebasestorage.app",
            messagingSenderId: "9259146",
            appId: "1:9259146:web:8fc8523c6040658bf40573"
        };

        let firebaseApp = null;
        let firebaseAuth = null;
        let firestoreDb = null;
        let firebaseReady = false;

        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            firebaseAuth = firebase.auth();
            firestoreDb = firebase.firestore();
            firebaseReady = true;
        } catch (e) {
            console.warn('Firebase init failed. Auth + Firestore will be disabled.', e);
        }

        // =============================================
        // FIRESTORE STORAGE (No backend required)
        // =============================================
        // All app data is stored in Firestore:
        // - Shared blueprint (optional): wbcsApp/shared
        // - Per-user progress: wbcsUsers/{uid}
        //
        // This removes the localhost /api dependency entirely.

        function requireFirestore() {
            if (!firebaseReady || !firestoreDb) {
                throw new Error('Firestore not initialized. Check Firebase config and network.');
            }
        }

        async function fsGetDoc(ref) {
            const snap = await ref.get();
            return snap.exists ? snap.data() : null;
        }

        async function fsSetDoc(ref, data, merge = true) {
            await ref.set(data, { merge });
        }

        // =============================================
        // APP STATE
        // =============================================
        let currentUser = null;
        let activeTabId = 'overview';
        let appData = {
            subjects: [],
            tasks: [],
            tests: [],
            routines: { weekday: [], saturday: [], sunday: [] },
            userProgress: {
                completedTasks: {},
                testScores: {},
                customDates: {},
                customTestDates: {},
                customTests: [],
                dailyNotes: {},
                studySessions: [],
                notes: '',
                darkMode: false
            }
        };
        let activeSubject = null;
        let timerInterval = null;
        let timerSeconds = 0;

        // =============================================
        // SMALL UTILITIES
        // =============================================
        function hashString(str) {
            let h = 0;
            for (let i = 0; i < (str || '').length; i++) {
                h = (h * 31 + str.charCodeAt(i)) >>> 0;
            }
            return h;
        }

        function getSubjectAccent(subject) {
            const hue = hashString(subject) % 360;
            const border = `hsl(${hue} 78% 52%)`;
            const text = document.body.classList.contains('dark-mode')
                ? `hsl(${hue} 80% 78%)`
                : `hsl(${hue} 58% 34%)`;
            const bar = `linear-gradient(90deg, hsl(${hue} 78% 52%), hsl(${(hue + 44) % 360} 78% 52%))`;
            return { hue, border, text, bar };
        }

        // Deterministic "random" font color that stays readable
        function getRandomReadableFontColor(seed) {
            const hue = hashString(seed) % 360;
            const isDark = document.body.classList.contains('dark-mode');
            // Dark mode needs brighter text; light mode needs darker text.
            return isDark
                ? `hsl(${hue} 90% 78%)`
                : `hsl(${hue} 70% 28%)`;
        }

        function clamp(n, min, max) {
            return Math.min(max, Math.max(min, n));
        }

        // Progress palette (0% = red, 100% = green)
        function getProgressPalette(pct) {
            const p = clamp(Number(pct) || 0, 0, 100);
            const hue = (p / 100) * 120; // 0..120 (red‚Üígreen)
            const isDark = document.body.classList.contains('dark-mode');

            // Text must remain readable across light/dark + row highlights.
            const text = isDark
                ? `hsl(${hue} 85% 78%)`
                : `hsl(${hue} 75% 28%)`;

            const mutedText = isDark
                ? `hsl(${hue} 55% 78%)`
                : `hsl(${hue} 55% 26%)`;

            const border = `hsl(${hue} 80% 44%)`;
            const bar = `linear-gradient(90deg, hsl(${clamp(hue - 10, 0, 120)} 85% 50%), hsl(${clamp(hue + 10, 0, 120)} 85% 45%))`;

            // Subtle badges
            const pillBg = isDark
                ? `hsla(${hue}, 80%, 52%, 0.18)`
                : `hsla(${hue}, 85%, 55%, 0.16)`;

            const pillBorder = isDark
                ? `hsla(${hue}, 90%, 70%, 0.22)`
                : `hsla(${hue}, 65%, 38%, 0.22)`;

            // Stronger tints for topic backgrounds (monthly/subject views)
            const cellBg = isDark
                ? `hsla(${hue}, 88%, 60%, 0.22)`
                : `hsla(${hue}, 88%, 55%, 0.18)`;

            const cellBorder = isDark
                ? `hsla(${hue}, 92%, 72%, 0.30)`
                : `hsla(${hue}, 70%, 35%, 0.22)`;

            return { pct: p, hue, text, mutedText, border, bar, pillBg, pillBorder, cellBg, cellBorder };
        }

        function getSubjectProgress(subject) {
            const subjectTasks = (appData.tasks || []).filter(t => t.subject === subject);
            const completed = subjectTasks.filter(t => appData.userProgress?.completedTasks?.[t.id]).length;
            const total = subjectTasks.length;
            const pct = total ? Math.round((completed / total) * 100) : 0;
            return { completed, total, pct };
        }

        function getSubjectProgressPalette(subject) {
            return getProgressPalette(getSubjectProgress(subject).pct);
        }

        // =============================================
        // DATE HELPERS (avoid timezone shifts)
        // =============================================
        function parseISODate(dateStr) {
            if (!dateStr) return null;
            return new Date(dateStr + 'T00:00:00');
        }

        function toLocalISODate(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const da = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${da}`;
        }

        function formatDate(dateStr) {
            const d = parseISODate(dateStr);
            if (!d || Number.isNaN(d.getTime())) return '';
            return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
        }

        function getDayName(dateStr) {
            const d = parseISODate(dateStr);
            if (!d || Number.isNaN(d.getTime())) return '';
            return d.toLocaleDateString('en-US', { weekday: 'short' });
        }

        // =============================================
        // DATE HIGHLIGHT HELPERS (Monthly + Subject tables)
        // =============================================
        function getTaskRowHighlightClass(isoDate, isCompleted) {
            if (!isoDate) return '';
            const d = parseISODate(isoDate);
            if (!d || Number.isNaN(d.getTime())) return '';

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const dd = new Date(d);
            dd.setHours(0, 0, 0, 0);

            const ddISO = toLocalISODate(dd);
            const todayISO = toLocalISODate(today);
            const tomorrowISO = toLocalISODate(tomorrow);

            if (ddISO === todayISO) return 'row-today';
            if (ddISO === tomorrowISO) return 'row-tomorrow';

            if (dd < today) {
                return isCompleted ? 'row-past-done' : 'row-past-missed';
            }

            return '';
        }

        // =============================================
        // RESCHEDULING (per-user)
        // =============================================
        function getEffectiveTaskDate(task) {
            return appData.userProgress?.customDates?.[task.id] || task.date;
        }

        function getEffectiveTestDate(test) {
            // Personal tests store their date directly on the test object
            if (test?.origin === 'personal') return test.date;
            return appData.userProgress?.customTestDates?.[test.id] || test.date;
        }

        function updateTaskDate(taskId, newDate) {
            if (!newDate) return;
            appData.userProgress.customDates ||= {};

            const task = appData.tasks.find(t => t.id === taskId);
            if (task && task.date === newDate) {
                delete appData.userProgress.customDates[taskId];
            } else {
                appData.userProgress.customDates[taskId] = newDate;
            }
            saveProgress();
            renderAll();
            showToast('Task date updated (rescheduled)', 'success');
        }

        function updateTestDate(testId, newDate) {
            if (!newDate) return;

            // If it's a personal test, update the test object directly
            const personal = (appData.userProgress.customTests || []).find(t => t.id === testId);
            if (personal) {
                personal.date = newDate;
                // If an override existed, clear it
                if (appData.userProgress.customTestDates) delete appData.userProgress.customTestDates[testId];
                saveProgress();
                renderAll();
                showToast('Personal test date updated', 'success');
                return;
            }

            // Otherwise, per-user override for blueprint tests
            appData.userProgress.customTestDates ||= {};
            const test = appData.tests.find(t => t.id === testId);
            if (test && test.date === newDate) {
                delete appData.userProgress.customTestDates[testId];
            } else {
                appData.userProgress.customTestDates[testId] = newDate;
            }
            saveProgress();
            renderAll();
            showToast('Test date updated (rescheduled)', 'success');
        }

        // Admin blueprint inline updates
        function adminUpdateTaskDate(taskId, newDate) {
            if (!currentUser?.isAdmin) return;
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            task.date = newDate;
            saveAppData();
            loadAdminMonthTasks();
            renderAll();
            showToast('Blueprint task date updated', 'success');
        }

        function adminUpdateTestDate(testId, newDate) {
            if (!currentUser?.isAdmin) return;
            const test = appData.tests.find(t => t.id === testId);
            if (!test) return;
            test.date = newDate;
            saveAppData();
            renderAll();
            showToast('Blueprint test date updated', 'success');
        }

        // =============================================
        // FIRESTORE FUNCTIONS (No backend required)
        // =============================================
        async function getBearerToken() {
            // Still useful for future, but not required for Firestore reads/writes
            if (firebaseReady && firebaseAuth?.currentUser) {
                try {
                    return await firebaseAuth.currentUser.getIdToken();
                } catch (e) {
                    // ignore
                }
            }
            return null;
        }

        // (Deprecated) apiCall kept for backward compatibility of older code paths.
        // We no longer call /api at all; this always returns null.
        async function apiCall() {
            return null;
        }

        // =============================================
        // AUTHENTICATION
        // =============================================
        function showAuthTab(tab) {
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');

            const loginBtn = document.getElementById('loginTab');
            const regBtn = document.getElementById('registerTab');

            if (tab === 'login') {
                loginBtn.className = "py-2.5 rounded-xl bg-gradient-to-r from-indigo-500 to-fuchsia-500 text-white font-bold transition btn-glow";
                regBtn.className = "py-2.5 rounded-xl text-slate-700 font-bold transition";
            } else {
                regBtn.className = "py-2.5 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold transition btn-glow";
                loginBtn.className = "py-2.5 rounded-xl text-slate-700 font-bold transition";
            }
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value?.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }

            if (!firebaseReady || !firebaseAuth) {
                showAuthError('Firebase Authentication is not initialized. Check firebaseConfig and network.');
                return;
            }

            document.getElementById('authError').classList.add('hidden');
            document.getElementById('authLoader').classList.remove('hidden');

            try {
                const cred = await firebaseAuth.signInWithEmailAndPassword(email, password);
                const u = cred.user;
                const idToken = await u.getIdToken();

                // store for compatibility (apiCall prefers firebase token anyway)
                localStorage.setItem('wbcs_token', idToken);

                currentUser = {
                    email: u.email,
                    name: u.displayName || (u.email ? u.email.split('@')[0] : 'User'),
                    isAdmin: false,
                    uid: u.uid,
                    authProvider: 'firebase'
                };
                localStorage.setItem('wbcs_user', JSON.stringify(currentUser));

                document.getElementById('authLoader').classList.add('hidden');
                await initializeApp();
            } catch (e) {
                document.getElementById('authLoader').classList.add('hidden');
                const msg = e?.message || 'Login failed';
                showAuthError(msg);
            }
        }

        async function handleRegister() {
            const name = document.getElementById('regName').value?.trim();
            const email = document.getElementById('regEmail').value?.trim();
            const password = document.getElementById('regPassword').value;

            if (!name || !email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }

            if (password.length < 6) {
                showAuthError('Password must be at least 6 characters');
                return;
            }

            if (!firebaseReady || !firebaseAuth) {
                showAuthError('Firebase Authentication is not initialized. Check firebaseConfig and network.');
                return;
            }

            document.getElementById('authError').classList.add('hidden');
            document.getElementById('authLoader').classList.remove('hidden');

            try {
                const cred = await firebaseAuth.createUserWithEmailAndPassword(email, password);
                const u = cred.user;
                if (u && name) {
                    await u.updateProfile({ displayName: name });
                }
                const idToken = await u.getIdToken();

                localStorage.setItem('wbcs_token', idToken);

                currentUser = {
                    email: u.email,
                    name: name,
                    isAdmin: false,
                    uid: u.uid,
                    authProvider: 'firebase'
                };
                localStorage.setItem('wbcs_user', JSON.stringify(currentUser));

                document.getElementById('authLoader').classList.add('hidden');
                await initializeApp();
            } catch (e) {
                document.getElementById('authLoader').classList.add('hidden');
                const msg = e?.message || 'Registration failed';
                showAuthError(msg);
            }
        }

        async function handleLogout() {
            try {
                if (firebaseReady && firebaseAuth?.currentUser) {
                    await firebaseAuth.signOut();
                }
            } catch (e) {
                // ignore
            }

            localStorage.removeItem('wbcs_token');
            localStorage.removeItem('wbcs_user');

            // stop timer if running
            pauseTimer();
            timerSeconds = 0;
            updateTimerDisplay();

            showToast('Signed out. Reloading‚Ä¶', 'info');
            setTimeout(() => location.reload(), 350);
        }

        function showAuthError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3500);
        }

        // =============================================
        // DATA LOADING & SAVING
        // =============================================
        function normalizeUserProgress() {
            appData.userProgress ||= {};
            appData.userProgress.completedTasks ||= {};
            appData.userProgress.testScores ||= {};
            appData.userProgress.customDates ||= {};
            appData.userProgress.customTestDates ||= {};
            appData.userProgress.customTests ||= [];
            appData.userProgress.dailyNotes ||= {};
            appData.userProgress.studySessions ||= [];
            appData.userProgress.notes ||= '';
            appData.userProgress.darkMode ||= false;
            appData.userProgress.cutoffs ||= {
                subject: 55,
                mixed: 60,
                full: 80,
                fullMock: 150
            };
        }

        async function loadAppData() {
            // Firestore-first
            try {
                if (firebaseReady && firestoreDb && currentUser?.uid) {
                    // Shared blueprint (optional). If it doesn't exist, we use defaults.
                    const sharedRef = firestoreDb.collection('wbcsApp').doc('shared');
                    const shared = await fsGetDoc(sharedRef);

                    // Per-user
                    const userRef = firestoreDb.collection('wbcsUsers').doc(currentUser.uid);
                    const userDoc = await fsGetDoc(userRef);

                    // 1) Pick a base blueprint (shared ‚Üí local ‚Üí default)
                    let base = null;
                    if (shared && (shared.subjects || shared.tasks || shared.tests || shared.routines)) {
                        base = shared;
                    } else {
                        const localData = localStorage.getItem('wbcs_appData');
                        base = localData ? JSON.parse(localData) : getDefaultAppData();
                    }

                    // 2) If the user has their own editable copy of the blueprint, use it
                    //    (This makes the demo/default data editable per-user in Firestore.)
                    if (userDoc && userDoc.userAppData) {
                        appData = { ...appData, ...base, ...userDoc.userAppData };
                    } else {
                        appData = { ...appData, ...base };
                    }

                    // 3) Merge per-user progress
                    if (userDoc && userDoc.userProgress) {
                        appData.userProgress = { ...appData.userProgress, ...userDoc.userProgress };
                    } else {
                        const localProgress = localStorage.getItem('wbcs_progress_' + (currentUser.email || currentUser.uid));
                        if (localProgress) {
                            appData.userProgress = { ...appData.userProgress, ...JSON.parse(localProgress) };
                        }
                    }

                    normalizeUserProgress();

                    // Save local cache for offline use
                    localStorage.setItem('wbcs_appData', JSON.stringify(appData));
                    return;
                }
            } catch (e) {
                console.warn('Firestore load failed, using local fallback:', e?.message || e);
            }

            // Local fallback
            const localData = localStorage.getItem('wbcs_appData');
            appData = localData ? JSON.parse(localData) : getDefaultAppData();

            const localProgress = localStorage.getItem('wbcs_progress_' + (currentUser?.email || 'local'));
            if (localProgress) {
                appData.userProgress = { ...appData.userProgress, ...JSON.parse(localProgress) };
            }

            normalizeUserProgress();
        }

        async function saveProgress() {
            normalizeUserProgress();

            // Local always
            localStorage.setItem('wbcs_progress_' + (currentUser?.email || currentUser?.uid || 'local'), JSON.stringify(appData.userProgress));
            localStorage.setItem('wbcs_appData', JSON.stringify(appData));

            // Firestore if available
            try {
                if (firebaseReady && firestoreDb && currentUser?.uid) {
                    const userRef = firestoreDb.collection('wbcsUsers').doc(currentUser.uid);
                    await fsSetDoc(userRef, {
                        email: currentUser.email || null,
                        name: currentUser.name || null,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        userProgress: appData.userProgress
                    }, true);
                }
            } catch (e) {
                console.warn('Firestore save failed (progress):', e?.message || e);
            }
        }

        async function saveUserAppData() {
            // Save an editable copy of the blueprint per-user.
            // This lets "demo/default" tasks/tests/subjects be edited without admin rights.
            try {
                if (firebaseReady && firestoreDb && currentUser?.uid) {
                    const userRef = firestoreDb.collection('wbcsUsers').doc(currentUser.uid);
                    await fsSetDoc(userRef, {
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        userAppData: {
                            subjects: appData.subjects,
                            tasks: appData.tasks,
                            tests: appData.tests,
                            routines: appData.routines
                        }
                    }, true);
                }
            } catch (e) {
                console.warn('Firestore save failed (user app data):', e?.message || e);
            }
        }

        async function saveAppData() {
            // Always store locally
            localStorage.setItem('wbcs_appData', JSON.stringify(appData));

            // If admin, also update shared blueprint
            if (currentUser?.isAdmin) {
                try {
                    if (firebaseReady && firestoreDb) {
                        const sharedRef = firestoreDb.collection('wbcsApp').doc('shared');
                        await fsSetDoc(sharedRef, {
                            subjects: appData.subjects,
                            tasks: appData.tasks,
                            tests: appData.tests,
                            routines: appData.routines,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, true);
                    }
                } catch (e) {
                    console.warn('Firestore save failed (shared app data):', e?.message || e);
                }
            } else {
                // Non-admin users keep an editable copy in their own profile
                await saveUserAppData();
            }
        }

        function getDefaultAppData() {
            return {
                subjects: ['Polity', 'History', 'Geography', 'Economy', 'Science', 'Environment', 'Current Affairs'],
                tasks: getDefaultTasks(),
                tests: getDefaultTests(),
                routines: getDefaultRoutines(),
                userProgress: {
                    completedTasks: {},
                    testScores: {},
                    customDates: {},
                    customTestDates: {},
                    customTests: [],
                    dailyNotes: {},
                    studySessions: [],
                    notes: '',
                    darkMode: false,
                    cutoffs: { subject: 55, mixed: 60, full: 80, fullMock: 150 }
                }
            };
        }

        function getDefaultTasks() {
            const tasks = [];
            const janData = [
                { date: '2026-01-01', morning: 'Polity: Constitution Basics, Preamble', evening: 'Polity MCQs (50)', test: 'New Year Holiday', subject: 'Polity', hours: 3.75 },
                { date: '2026-01-02', morning: 'History: 1857 Revolt - Causes & Course', evening: '1857 MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-03', morning: 'Geography: Earth, Solar System', evening: 'Geography MCQs', test: 'Weekend Study', subject: 'Geography', hours: 8.5 },
                { date: '2026-01-04', morning: 'Economy: National Income Concepts', evening: 'Economy MCQs', test: 'TEST 1: 50 MCQs', subject: 'Economy', hours: 8 },
                { date: '2026-01-05', morning: 'Polity: Fundamental Rights (Art 12-35)', evening: 'FR MCQs + Case laws', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-01-06', morning: 'History: Social Reform Movements', evening: 'Reformers MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-07', morning: 'Geography: Indian Physiography', evening: 'Mountain ranges MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-01-08', morning: 'Economy: Money, Banking, RBI Functions', evening: 'Banking MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-01-09', morning: 'Science: Physics - Motion, Work, Energy', evening: 'Physics MCQs', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-01-10', morning: 'Science: Heat, Light, Sound waves', evening: 'Science comp MCQs', test: 'Weekend Study', subject: 'Science', hours: 8.5 },
                { date: '2026-01-11', morning: 'Current Affairs: Dec 2025 Wrap-up', evening: 'CA MCQs', test: 'TEST 2: 50 MCQs', subject: 'Current Affairs', hours: 8 },
                { date: '2026-01-12', morning: 'Polity: DPSP (Art 36-51) & FD', evening: 'Directives MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-01-13', morning: 'History: INC Formation, Moderate Phase', evening: 'Early Congress MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-14', morning: 'Geography: Indian Drainage - Rivers', evening: 'Rivers Map Marking', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-01-15', morning: 'Economy: Fiscal Policy, Budget', evening: 'Budget Terms MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-01-16', morning: 'Science: Atomic Structure', evening: 'Chemistry Elements', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-01-17', morning: 'History: National Movement Timeline', evening: 'Chronology Practice', test: 'Weekend Study', subject: 'History', hours: 8.5 },
                { date: '2026-01-18', morning: 'Polity: Union Executive', evening: 'Executive MCQs', test: 'TEST 3: 75 MCQs', subject: 'Polity', hours: 8 },
                { date: '2026-01-19', morning: 'Polity: Parliament Basics', evening: 'Legislature MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-01-20', morning: 'History: Partition of Bengal 1905', evening: 'Swadeshi Movement MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-21', morning: 'Geography: Climate & Monsoon', evening: 'Monsoon patterns MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-01-22', morning: 'Economy: Agriculture Sector', evening: 'Green Revolution MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-01-23', morning: 'Science: Acids, Bases, Salts', evening: 'pH scale reactions', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-01-24', morning: 'Geography: Indian Map Comprehensive', evening: 'Map locations drill', test: 'Weekend Study', subject: 'Geography', hours: 8.5 },
                { date: '2026-01-25', morning: 'Economy: Full Economy Marathon', evening: 'Economy comprehensive MCQs', test: 'TEST 4: 75 MCQs', subject: 'Economy', hours: 8 },
                { date: '2026-01-26', morning: 'Republic Day: Constitution Deep Study', evening: 'Polity 100 MCQs marathon', test: 'Holiday', subject: 'Polity', hours: 6 },
                { date: '2026-01-27', morning: 'History: Home Rule, Lucknow Pact', evening: '1916-1919 MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-28', morning: 'Geography: Soils & Vegetation', evening: 'Forest types MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-01-29', morning: 'Economy: Industry & MSMEs', evening: 'Manufacturing policies MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-01-30', morning: 'Science: Biology - Cell & Tissues', evening: 'Cell structures MCQs', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-01-31', morning: 'Polity: Full Revision Marathon', evening: 'Polity final drill MCQs', test: 'TEST 5: 75 MCQs', subject: 'Polity', hours: 8.5 }
            ];

            const febData = [
                { date: '2026-02-01', morning: 'Environment: Ecology, Biodiversity', evening: 'Environment comp MCQs', test: 'TEST 6: 75 MCQs', subject: 'Environment', hours: 8 },
                { date: '2026-02-02', morning: 'Polity: Judiciary - SC & High Courts', evening: 'Judicial cases MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-02-03', morning: 'History: Non-Cooperation Movement', evening: 'Gandhi era drill MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-02-04', morning: 'Geography: Minerals & Energy', evening: 'Resource maps MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-02-05', morning: 'Economy: Planning & NITI Aayog', evening: 'Plan objectives MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-02-06', morning: 'Science: Human Body Systems', evening: 'Human diseases MCQs', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-02-07', morning: 'History: 1857-1947 Final Chronology', evening: 'Timeline marathon drill', test: 'TEST 7: 75 MCQs', subject: 'History', hours: 8.5 },
                { date: '2026-02-08', morning: 'Polity + Geography Integration', evening: 'Combined mock MCQs', test: 'TEST 8: 75 MCQs', subject: 'Polity', hours: 8 },
                { date: '2026-02-09', morning: 'Polity: Local Government (73rd/74th)', evening: 'Panchayat MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-02-10', morning: 'History: Civil Disobedience', evening: 'Dandi March MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-02-11', morning: 'Geography WB: Physical Features', evening: 'WB district maps MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-02-12', morning: 'Economy: Govt Schemes Review', evening: 'Central/State welfare MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-02-13', morning: 'Science: Environment Pollution', evening: 'Climate treaties MCQs', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-02-14', morning: 'Mixed Revision: All Weak Areas', evening: 'Problem topic intensive', test: 'TEST 9: 75 MCQs', subject: 'General', hours: 8.5 },
                { date: '2026-02-15', morning: 'Full Science Revision Marathon', evening: 'Science comprehensive MCQs', test: 'TEST 10: 100 MCQs', subject: 'Science', hours: 8 },
                { date: '2026-02-16', morning: 'Polity: Emergency Provisions', evening: 'Emergency history MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-02-17', morning: 'History: Quit India & INA', evening: 'Final phase leaders MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-02-18', morning: 'Geography WB: Economy & Industry', evening: 'WB agriculture MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-02-19', morning: 'Reasoning: Logical Patterns', evening: 'Reasoning speed practice', test: '-', subject: 'General', hours: 3.75 },
                { date: '2026-02-20', morning: 'Quant: Perc, Ratio, Shortcuts', evening: 'Speed math MCQs', test: '-', subject: 'General', hours: 3.75 },
                { date: '2026-02-21', morning: 'Complete GS Syllabus Revision', evening: 'Full mock test simulation', test: 'TEST 11: 100 MCQs', subject: 'General', hours: 8.5 },
                { date: '2026-02-22', morning: 'Current Affairs: Jan-Feb 2026', evening: 'Recent events mock MCQs', test: 'TEST 12: 100 MCQs', subject: 'Current Affairs', hours: 8 },
                { date: '2026-02-23', morning: 'English Basics & Vocabulary', evening: 'English comp MCQs', test: '-', subject: 'General', hours: 3 },
                { date: '2026-02-24', morning: 'Formulas & Facts Final Look', evening: 'Quick recall MCQs', test: '-', subject: 'General', hours: 2.5 },
                { date: '2026-02-25', morning: 'Timeline & Events Final Review', evening: 'Chronology final check', test: '-', subject: 'History', hours: 2.5 },
                { date: '2026-02-26', morning: 'Maps & Diagrams Final Review', evening: 'Visual memory drill', test: '-', subject: 'Geography', hours: 2.5 },
                { date: '2026-02-27', morning: 'Error Log Final Revision', evening: 'Mistake pattern analysis', test: '-', subject: 'General', hours: 2 },
                { date: '2026-02-28', morning: 'Rest & Mental Relaxation', evening: 'Final simulation mock', test: 'FULL MOCK: 200 MCQs', subject: 'General', hours: 3 }
            ];

            const marData = [
                { date: '2026-03-01', morning: 'Full Revision: Polity Weak Areas', evening: 'Polity Marathon', test: '-', subject: 'Polity', hours: 6 },
                { date: '2026-03-02', morning: 'Full Revision: History Weak Areas', evening: 'History Marathon', test: '-', subject: 'History', hours: 6 },
                { date: '2026-03-03', morning: 'Full Revision: Geography Weak Areas', evening: 'Geography Marathon', test: '-', subject: 'Geography', hours: 6 },
                { date: '2026-03-04', morning: 'Full Revision: Economy Weak Areas', evening: 'Economy Marathon', test: '-', subject: 'Economy', hours: 6 },
                { date: '2026-03-05', morning: 'Full Revision: Science Weak Areas', evening: 'Science Marathon', test: '-', subject: 'Science', hours: 6 },
                { date: '2026-03-06', morning: 'Current Affairs: Complete Review', evening: 'CA Final Drill', test: '-', subject: 'Current Affairs', hours: 6 },
                { date: '2026-03-07', morning: 'Mock Test Simulation', evening: 'Error Analysis', test: 'TEST 13: FULL MOCK', subject: 'General', hours: 8 },
                { date: '2026-03-08', morning: 'Mock Test Simulation', evening: 'Error Analysis', test: 'TEST 14: FULL MOCK', subject: 'General', hours: 8 },
                { date: '2026-03-09', morning: 'Rapid Revision: All Subjects', evening: 'Quick Facts Review', test: '-', subject: 'General', hours: 6 },
                { date: '2026-03-10', morning: 'Rapid Revision: All Subjects', evening: 'Quick Facts Review', test: '-', subject: 'General', hours: 6 },
                { date: '2026-03-11', morning: 'Focus: Constitution & Amendments', evening: 'Polity Final MCQs', test: '-', subject: 'Polity', hours: 5 },
                { date: '2026-03-12', morning: 'Focus: Freedom Movement Timeline', evening: 'History Final MCQs', test: '-', subject: 'History', hours: 5 },
                { date: '2026-03-13', morning: 'Focus: Maps & Current Affairs', evening: 'Geography + CA MCQs', test: '-', subject: 'Geography', hours: 5 },
                { date: '2026-03-14', morning: 'Final Mock Test', evening: 'Complete Review', test: 'TEST 15: FINAL MOCK', subject: 'General', hours: 8 },
                { date: '2026-03-15', morning: 'Light Revision Only', evening: 'Rest', test: '-', subject: 'General', hours: 3 },
                { date: '2026-03-16', morning: 'Formula Sheet Review', evening: 'Quick Facts', test: '-', subject: 'General', hours: 3 },
                { date: '2026-03-17', morning: 'Current Affairs: Last Week', evening: 'Light Reading', test: '-', subject: 'Current Affairs', hours: 3 },
                { date: '2026-03-18', morning: 'Exam Prep: Admit Card, Center', evening: 'Mental Relaxation', test: 'Preparation Day', subject: 'General', hours: 2 },
                { date: '2026-03-19', morning: 'Complete Rest', evening: 'Early Sleep', test: 'Rest Day', subject: 'General', hours: 1 },
                { date: '2026-03-20', morning: 'WBCS PRELIMINARY EXAM 2026', evening: 'Self Reflection', test: 'D-DAY', subject: 'General', hours: 10 }
            ];

            [...janData, ...febData, ...marData].forEach((t, i) => {
                tasks.push({ ...t, id: `task-${i}` });
            });

            return tasks;
        }

        function getDefaultTests() {
            return [
                { id: 'test-1', number: 1, date: '2026-01-04', type: 'Subject', mcqs: 50, focus: 'Polity + History', target: 40 },
                { id: 'test-2', number: 2, date: '2026-01-11', type: 'Subject', mcqs: 50, focus: 'Geography + Economy', target: 40 },
                { id: 'test-3', number: 3, date: '2026-01-18', type: 'Mixed', mcqs: 75, focus: 'GS Comprehensive', target: 60 },
                { id: 'test-4', number: 4, date: '2026-01-25', type: 'Mixed', mcqs: 75, focus: 'All Subjects', target: 60 },
                { id: 'test-5', number: 5, date: '2026-01-31', type: 'Mixed', mcqs: 75, focus: 'Polity Heavy', target: 60 },
                { id: 'test-6', number: 6, date: '2026-02-01', type: 'Subject', mcqs: 75, focus: 'Environment', target: 60 },
                { id: 'test-7', number: 7, date: '2026-02-07', type: 'Mixed', mcqs: 75, focus: 'History Focus', target: 60 },
                { id: 'test-8', number: 8, date: '2026-02-08', type: 'Mixed', mcqs: 75, focus: 'Polity + Geo', target: 60 },
                { id: 'test-9', number: 9, date: '2026-02-14', type: 'Mixed', mcqs: 75, focus: 'Weak Areas', target: 60 },
                { id: 'test-10', number: 10, date: '2026-02-15', type: 'Full', mcqs: 100, focus: 'Science Focus', target: 80 },
                { id: 'test-11', number: 11, date: '2026-02-21', type: 'Full', mcqs: 100, focus: 'Complete GS', target: 80 },
                { id: 'test-12', number: 12, date: '2026-02-22', type: 'Full', mcqs: 100, focus: 'Current Affairs', target: 80 },
                { id: 'test-13', number: 13, date: '2026-03-07', type: 'Full Mock', mcqs: 200, focus: 'Exam Simulation', target: 160 },
                { id: 'test-14', number: 14, date: '2026-03-08', type: 'Full Mock', mcqs: 200, focus: 'Exam Simulation', target: 160 },
                { id: 'test-15', number: 15, date: '2026-03-14', type: 'Final Mock', mcqs: 200, focus: 'Final Simulation', target: 170 }
            ];
        }

        function getDefaultRoutines() {
            return {
                weekday: [
                    { time: '05:30 - 06:00', activity: 'Wake Up & Freshen', details: 'Morning routine, light exercise', duration: '30 min' },
                    { time: '06:00 - 08:00', activity: 'Morning Study Block', details: 'Theory reading - Primary subject', duration: '2 hrs' },
                    { time: '08:00 - 09:00', activity: 'Breakfast & Break', details: 'News reading, current affairs', duration: '1 hr' },
                    { time: '09:00 - 18:00', activity: 'Office/Work', details: 'Professional commitments', duration: '9 hrs' },
                    { time: '18:00 - 19:00', activity: 'Evening Break', details: 'Rest, snacks, light walk', duration: '1 hr' },
                    { time: '19:00 - 21:00', activity: 'Evening Study Block', details: 'MCQ practice, revision', duration: '2 hrs' },
                    { time: '21:00 - 22:00', activity: 'Dinner & Relaxation', details: 'Light reading, family time', duration: '1 hr' },
                    { time: '22:00 - 22:30', activity: 'Quick Revision', details: 'Day recap, next day planning', duration: '30 min' }
                ],
                saturday: [
                    { time: '06:00 - 08:00', activity: 'Morning Theory', details: 'Subject deep dive', duration: '2 hrs' },
                    { time: '08:00 - 09:00', activity: 'Breakfast', details: 'Current affairs reading', duration: '1 hr' },
                    { time: '09:00 - 12:00', activity: 'Intensive Study', details: 'Primary subject completion', duration: '3 hrs' },
                    { time: '12:00 - 14:00', activity: 'Lunch & Break', details: 'Rest and refresh', duration: '2 hrs' },
                    { time: '14:00 - 17:00', activity: 'MCQ Practice', details: 'Subject-wise practice', duration: '3 hrs' },
                    { time: '17:00 - 19:00', activity: 'Revision', details: 'Week summary revision', duration: '2 hrs' },
                    { time: '19:00 onwards', activity: 'Free Time', details: 'Relaxation, light study', duration: '~' }
                ],
                sunday: [
                    { time: '07:00 - 09:00', activity: 'Light Morning Study', details: 'Weak area focus', duration: '2 hrs' },
                    { time: '09:00 - 11:00', activity: 'Mock Test', details: 'Weekly assessment', duration: '2 hrs' },
                    { time: '11:00 - 13:00', activity: 'Test Analysis', details: 'Error log, learning', duration: '2 hrs' },
                    { time: '13:00 - 16:00', activity: 'Break & Lunch', details: 'Complete rest', duration: '3 hrs' },
                    { time: '16:00 - 18:00', activity: 'Next Week Planning', details: 'Schedule preparation', duration: '2 hrs' },
                    { time: '18:00 onwards', activity: 'Family/Recreation', details: 'Mental refresh', duration: '~' }
                ]
            };
        }

        // =============================================
        // APP INITIALIZATION
        // =============================================
        async function initializeApp() {
            await loadAppData();

            // Show main app
            document.getElementById('authScreen')?.classList.add('hidden');
            document.getElementById('mainApp')?.classList.remove('hidden');

            // Apply sidebar pin/collapse preferences (desktop)
            applySidebarPrefs();

            // Persist user
            localStorage.setItem('wbcs_user', JSON.stringify(currentUser));

            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const sidebarUserEmail = document.getElementById('sidebarUserEmail');
            if (userEmailDisplay) userEmailDisplay.textContent = 'üë§ ' + (currentUser.email || 'local@wbcs.app');
            if (sidebarUserEmail) sidebarUserEmail.textContent = (currentUser.email || 'local@wbcs.app');

            if (currentUser.isAdmin) {
                document.getElementById('adminMenuSection')?.classList.remove('hidden');
            }

            if (appData.userProgress.darkMode) {
                document.body.classList.add('dark-mode');
            }

            const notesEl = document.getElementById('globalNotes');
            if (notesEl) notesEl.value = appData.userProgress.notes || '';

            renderAll();
            showToast('Welcome!', 'info');
        }

        // =============================================
        // RENDERING FUNCTIONS
        // =============================================
        function renderAll() {
            renderDashboard();
            renderRoutines();
            renderMonthlySchedules();
            renderSubjects();
            renderSubjectsTab();
            renderTests();
            renderAnalytics();
            renderCutoffAnalytics();
            if (activeSubject) renderSubjectViewTable();
            if (currentUser.isAdmin) renderAdminPanel();
            setActiveTab(activeTabId, true);
        }

        function renderDashboard() {
            const tasks = appData.tasks;
            const completed = Object.keys(appData.userProgress.completedTasks).filter(k => appData.userProgress.completedTasks[k]).length;
            const progress = tasks.length ? Math.round((completed / tasks.length) * 100) : 0;

            document.getElementById('statProgress').textContent = progress + '%';
            document.getElementById('progressBar').style.width = progress + '%';

            const examDate = new Date('2026-03-20T00:00:00');
            const today = new Date();
            const daysLeft = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
            document.getElementById('statDays').textContent = Math.max(0, daysLeft);

            let totalHours = 0;
            tasks.forEach(t => {
                if (appData.userProgress.completedTasks[t.id]) totalHours += t.hours || 0;
            });
            document.getElementById('statHours').textContent = totalHours.toFixed(1) + 'h';

            document.getElementById('statStreak').textContent = calculateStreak() + ' days';

            // -----------------------------
            // Daily Focus (Today)
            // -----------------------------
            const todayISO = toLocalISODate(new Date());

            const todayTasks = (appData.tasks || [])
                .filter(t => getEffectiveTaskDate(t) === todayISO)
                .slice()
                .sort((a, b) => (a.subject || '').localeCompare(b.subject || '') || (a.morning || '').localeCompare(b.morning || ''));

            const todayTests = getAllTestsMerged()
                .filter(t => getEffectiveTestDate(t) === todayISO)
                .slice()
                .sort((a, b) => (a.number || 0) - (b.number || 0));

            const todayDone = todayTasks.filter(t => appData.userProgress.completedTasks[t.id]).length;
            const todayHours = todayTasks
                .filter(t => appData.userProgress.completedTasks[t.id])
                .reduce((s, t) => s + (t.hours || 0), 0);

            const chip = document.getElementById('todayDateChip');
            if (chip) chip.textContent = `${formatDate(todayISO)} ‚Ä¢ ${getDayName(todayISO)}`;

            const meta = document.getElementById('todayMeta');
            if (meta) {
                if (!todayTasks.length && !todayTests.length) {
                    meta.textContent = `No tasks or tests scheduled for today.`;
                } else {
                    const parts = [];
                    if (todayTasks.length) parts.push(`${todayTasks.length} tasks`);
                    if (todayTests.length) parts.push(`${todayTests.length} tests`);
                    parts.push(`${todayDone} completed ‚Ä¢ ${todayHours.toFixed(1)}h logged`);
                    meta.textContent = parts.join(' ‚Ä¢ ');
                }
            }

            const todayList = document.getElementById('todaySchedule');
            if (todayList) {
                if (!todayTasks.length && !todayTests.length) {
                    todayList.innerHTML = `<div class="py-3 text-slate-500">Use Monthly Schedules to reschedule tasks/tests to today, or add a topic under a subject.</div>`;
                } else {
                    const tasksHtml = todayTasks.map(t => {
                        const isCompleted = !!appData.userProgress.completedTasks[t.id];
                        const pal = getSubjectProgressPalette(t.subject || 'General');
                        const subjColor = getRandomReadableFontColor('today-subj-' + (t.subject || 'General'));

                        return `
                            <div class="py-3 flex flex-wrap items-start justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <span class="px-2 py-1 rounded-xl text-[11px] font-extrabold" style="background: ${pal.pillBg}; border: 1px solid ${pal.pillBorder}; color: ${subjColor};">
                                            ${t.subject || 'General'}
                                        </span>
                                        <span class="font-extrabold text-slate-800" style="text-decoration: ${isCompleted ? 'line-through' : 'none'}; opacity: ${isCompleted ? '0.75' : '1'};">
                                            ${t.morning || '-'}
                                        </span>
                                    </div>
                                    <div class="text-sm text-slate-600 mt-1" style="text-decoration: ${isCompleted ? 'line-through' : 'none'}; opacity: ${isCompleted ? '0.75' : '1'};">
                                        ${t.evening || ''}
                                    </div>
                                    <div class="text-xs text-slate-500 font-bold mt-1">${t.test && t.test !== '-' ? `üß™ ${t.test} ‚Ä¢ ` : ''}${t.hours || 0}h</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleTask('${t.id}')" class="w-5 h-5 accent-indigo-500 cursor-pointer">
                                </div>
                            </div>
                        `;
                    }).join('');

                    const testsHtml = todayTests.length ? `
                        <div class="pt-4 pb-2 text-xs font-extrabold text-slate-500 tracking-wider uppercase">Tests scheduled today</div>
                        <div class="space-y-2">
                            ${todayTests.map(t => {
                                const effDate = getEffectiveTestDate(t);
                                const badge = t.origin === 'personal'
                                    ? `<span class="px-2 py-1 rounded-xl text-[11px] font-extrabold" style="background: rgba(34,197,94,0.14); border: 1px solid rgba(34,197,94,0.18); color: rgb(21,128,61);">Personal</span>`
                                    : `<span class="px-2 py-1 rounded-xl text-[11px] font-extrabold" style="background: rgba(99,102,241,0.12); border: 1px solid rgba(99,102,241,0.18); color: rgb(79,70,229);">Blueprint</span>`;

                                const focusText = t.focus || (t.subject ? `${t.subject} - Subject Test` : '-');
                                return `
                                    <div class="py-2 flex items-start justify-between gap-3">
                                        <div class="min-w-0">
                                            <div class="flex items-center gap-2 flex-wrap">
                                                <div class="font-extrabold text-slate-800">üß™ Test ${t.number || ''}</div>
                                                ${badge}
                                                <div class="text-xs font-extrabold text-slate-500">${t.type || '-'} ‚Ä¢ ${t.mcqs ?? '-'} marks</div>
                                            </div>
                                            <div class="text-sm text-slate-600 mt-1">${focusText}</div>
                                        </div>
                                        <button onclick="switchTab('tests')" class="px-3 py-2 rounded-2xl text-xs font-extrabold text-white btn-glow" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">Open</button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : '';

                    todayList.innerHTML = tasksHtml + testsHtml;
                }
            }

            // -----------------------------
            // Subject cards
            // -----------------------------
            const cardsHtml = appData.subjects.map(s => {
                const { completed: subjectCompleted, total: subjectTotal, pct: subjectProgress } = getSubjectProgress(s);
                const pal = getProgressPalette(subjectProgress);

                // Pastel tile background (subject-based) + progress badge
                const hue = (hashString(s) % 360);
                const isDark = document.body.classList.contains('dark-mode');
                const tileBg = isDark
                    ? `linear-gradient(135deg, hsla(${hue}, 70%, 55%, 0.18), rgba(17,24,39,0.92))`
                    : `linear-gradient(135deg, hsla(${hue}, 85%, 70%, 0.35), rgba(255,255,255,0.98))`;

                const titleColor = getRandomReadableFontColor('tile-title-' + s);
                const pctRing = `hsl(${hue} 78% 48%)`;

                return `
                    <div onclick="viewSubject('${s}')" class="glass bouncy-card subject-tile p-5 cursor-pointer transition" style="background: ${tileBg}; border-color: var(--border);">
                        <div class="flex items-start justify-between gap-3">
                            <h4 class="font-extrabold text-lg md:text-xl" style="color: ${titleColor};">${s}</h4>
                            <div class="w-10 h-10 rounded-full grid place-items-center text-[11px] font-black" style="background: rgba(255,255,255,0.72); border: 2px solid ${pctRing}; color: ${titleColor};">
                                ${subjectProgress}%
                            </div>
                        </div>
                        <div class="text-sm font-bold mt-1" style="color: rgba(15,23,42,0.65);">${subjectCompleted}/${subjectTotal} topics</div>
                        <div class="h-2 bg-white/70 rounded-full mt-3 overflow-hidden">
                            <div class="h-full" style="width: ${subjectProgress}%; background: ${pal.bar};"></div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('subjectCards').innerHTML = cardsHtml;
        }

        function calculateStreak() {
            const completedDates = new Set();
            appData.tasks.forEach(t => {
                if (appData.userProgress.completedTasks[t.id]) completedDates.add(getEffectiveTaskDate(t));
            });

            let streak = 0;
            let checkDate = new Date();
            checkDate.setHours(0, 0, 0, 0);

            let dateStr = toLocalISODate(checkDate);
            if (!completedDates.has(dateStr)) checkDate.setDate(checkDate.getDate() - 1);

            while (true) {
                dateStr = toLocalISODate(checkDate);
                if (completedDates.has(dateStr)) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else break;
                if (streak > 365) break;
            }
            return streak;
        }

        function renderRoutines() {
            const renderTable = (data, tableId) => {
                document.getElementById(tableId).innerHTML = data.map(r => `
                    <tr class="border-b border-black/5 table-row-hover">
                        <td class="p-3 font-bold">${r.time}</td>
                        <td class="p-3">${r.activity}</td>
                        <td class="p-3 text-slate-600">${r.details}</td>
                        <td class="p-3">${r.duration}</td>
                    </tr>
                `).join('');
            };

            renderTable(appData.routines.weekday, 'weekdayTable');
            renderTable(appData.routines.saturday, 'saturdayTable');
            renderTable(appData.routines.sunday, 'sundayTable');
        }

        function renderMonthlySchedules() {
            const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            let menuHtml = '';
            let tabsHtml = '';

            months.forEach((month, idx) => {
                const monthNum = String(idx + 1).padStart(2, '0');
                const monthTasks = appData.tasks
                    .filter(t => (getEffectiveTaskDate(t) || '').split('-')[1] === monthNum)
                    .slice()
                    .sort((a, b) => getEffectiveTaskDate(a).localeCompare(getEffectiveTaskDate(b)));

                const monthTests = getAllTestsMerged()
                    .filter(t => (getEffectiveTestDate(t) || '').split('-')[1] === monthNum)
                    .slice()
                    .sort((a, b) => (getEffectiveTestDate(a) || '').localeCompare(getEffectiveTestDate(b) || '') || ((a.number || 0) - (b.number || 0)));

                if (monthTasks.length > 0 || monthTests.length > 0) {
                    menuHtml += `
                        <div class="sidebar-subitem cursor-pointer text-sm" data-tip="${monthNames[idx]} 2026" onclick="switchTab('${month}')">
                            <span class="subitem-icon">üìÜ</span>
                            <span class="subitem-label font-extrabold">${monthNames[idx]} 2026</span>
                        </div>
                    `;

                    const tasksTableHtml = monthTasks.length ? `
                        <table class="w-full">
                            <thead class="text-white" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                                <tr>
                                    <th class="p-3 text-left">Date</th>
                                    <th class="p-3 text-left">Day</th>
                                    <th class="p-3 text-left">Morning</th>
                                    <th class="p-3 text-left">Evening</th>
                                    <th class="p-3 text-left">Test</th>
                                    <th class="p-3 text-left">Subject</th>
                                    <th class="p-3 text-left">Hrs</th>
                                    <th class="p-3 text-left">‚úì</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${monthTasks.map(t => {
                                    const isCompleted = appData.userProgress.completedTasks[t.id];
                                    const effDate = getEffectiveTaskDate(t);
                                    const displayDate = formatDate(effDate);
                                    const dayName = getDayName(effDate);
                                    const highlightClass = getTaskRowHighlightClass(effDate, isCompleted);
                                    const pal = getSubjectProgressPalette(t.subject || 'General');
                                    return `
                                        <tr class="${highlightClass} ${isCompleted ? 'completed-row' : ''} border-b border-black/5 table-row-hover">
                                            <td class="p-3">
                                                <div class="date-chip bounceable">${displayDate} ‚Ä¢ ${dayName}</div>
                                                <div class="mt-2">
                                                    <input type="date" value="${effDate}" onchange="updateTaskDate('${t.id}', this.value)" class="input-mini bg-white/70">
                                                </div>
                                            </td>
                                            <td class="p-3 font-bold">${dayName}</td>
                                            <td class="p-3"><div class="hover-bounce topic-inline">${t.morning}</div></td>
                                            <td class="p-3"><div class="hover-bounce topic-inline">${t.evening}</div></td>
                                            <td class="p-3">${t.test}</td>
                                            <td class="p-3">
                                                <div class="subject-chip">
                                                    <span class="subj-dot" style="background:${pal.border};"></span>
                                                    <span class="subject-plain">${t.subject || 'General'}</span>
                                                    <span class="subj-pct" style="color:${pal.text};">${pal.pct}%</span>
                                                </div>
                                            </td>
                                            <td class="p-3 font-bold">${t.hours}</td>
                                            <td class="p-3"><input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleTask('${t.id}')" class="w-5 h-5 accent-indigo-500 cursor-pointer"></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : `<div class="text-slate-500 font-bold py-4">No study tasks scheduled for this month.</div>`;

                    const testsTableHtml = monthTests.length ? `
                        <table class="w-full">
                            <thead class="text-white" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">
                                <tr>
                                    <th class="p-3 text-left">Test</th>
                                    <th class="p-3 text-left">Date (editable)</th>
                                    <th class="p-3 text-left">Day</th>
                                    <th class="p-3 text-left">Type</th>
                                    <th class="p-3 text-left">Marks</th>
                                    <th class="p-3 text-left">Focus</th>
                                    <th class="p-3 text-left">Target</th>
                                    <th class="p-3 text-left">Score</th>
                                    <th class="p-3 text-left">%</th>
                                    <th class="p-3 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${monthTests.map(t => {
                                    const effDate = getEffectiveTestDate(t);
                                    const dayName = getDayName(effDate);
                                    const scoreRaw = appData.userProgress?.testScores?.[t.id];
                                    const hasScore = (scoreRaw === 0 || scoreRaw) ? Number.isFinite(Number(scoreRaw)) : false;
                                    const highlightClass = getTaskRowHighlightClass(effDate, hasScore);

                                    const score = hasScore ? Number(scoreRaw) : null;
                                    const percentage = (score !== null) ? Math.round((score / (t.mcqs || 1)) * 100) : null;

                                    const badge = t.origin === 'personal'
                                        ? `<span class="ml-2 px-2 py-1 rounded-xl text-[11px] font-extrabold" style="background: rgba(34,197,94,0.14); border: 1px solid rgba(34,197,94,0.18); color: rgb(21,128,61);">Personal</span>`
                                        : `<span class="ml-2 px-2 py-1 rounded-xl text-[11px] font-extrabold" style="background: rgba(99,102,241,0.12); border: 1px solid rgba(99,102,241,0.18); color: rgb(79,70,229);">Blueprint</span>`;

                                    const actions = t.origin === 'personal'
                                        ? `<button onclick="deletePersonalTest('${t.id}')" class="px-3 py-1.5 rounded-2xl text-white font-extrabold text-xs btn-glow" style="background: linear-gradient(135deg, #ef4444, #f43f5e);">üóëÔ∏è</button>`
                                        : `<span class="text-xs text-slate-500">‚Äî</span>`;

                                    return `
                                        <tr class="${highlightClass} border-b border-black/5 table-row-hover">
                                            <td class="p-3 font-extrabold">Test ${t.number || ''} ${badge}</td>
                                            <td class="p-3">
                                                <div class="date-chip bounceable">${formatDate(effDate)} ‚Ä¢ ${dayName}</div>
                                                <div class="mt-2">
                                                    <input type="date" value="${effDate || ''}" onchange="updateTestDate('${t.id}', this.value)" class="input-mini bg-white/70">
                                                </div>
                                            </td>
                                            <td class="p-3 font-bold">${dayName}</td>
                                            <td class="p-3 font-bold">${t.type || '-'}</td>
                                            <td class="p-3 font-extrabold">${t.mcqs ?? '-'}</td>
                                            <td class="p-3">${t.focus || (t.subject ? `${t.subject} - Subject Test` : '-') || '-'}</td>
                                            <td class="p-3 font-extrabold">${t.target ?? '-'}</td>
                                            <td class="p-3">
                                                <input type="number" value="${score ?? ''}" min="0" max="${t.mcqs || 999}" placeholder="Score" 
                                                    onchange="updateTestScore('${t.id}', this.value)" 
                                                    class="w-24 px-3 py-2 border rounded-2xl text-center bg-white/70">
                                            </td>
                                            <td class="p-3 font-extrabold">${percentage === null ? '-' : `${percentage}%`}</td>
                                            <td class="p-3">${actions}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    ` : `<div class="text-slate-500 font-bold py-4">No tests scheduled for this month.</div>`;

                    tabsHtml += `
                        <div id="tab-${month}" class="tab-content">
                            <div class="flex items-center justify-between gap-3 mb-4">
                                <h2 class="text-2xl font-extrabold text-slate-800">üìÜ ${monthNames[idx]} 2026</h2>
                            </div>

                            <div class="overflow-x-auto">
                                ${tasksTableHtml}
                            </div>

                            <div class="mt-6">
                                <div class="flex items-center justify-between gap-3 mb-3">
                                    <h3 class="text-lg font-extrabold text-slate-800">üß™ Tests this month</h3>
                                    <button onclick="switchTab('tests')" class="px-3 py-2 rounded-2xl text-xs font-extrabold text-white btn-glow" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">Open Test Tracker</button>
                                </div>
                                <div class="overflow-x-auto">
                                    ${testsTableHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            document.getElementById('monthMenu').innerHTML = menuHtml;
            document.getElementById('monthlyTabs').innerHTML = tabsHtml;
        }

        function renderSubjects() {
            const menuHtml = (appData.subjects || []).map(s => {
                const { pct } = getSubjectProgress(s);
                const pal = getProgressPalette(pct);
                return `
                    <div class="sidebar-subitem cursor-pointer text-sm" data-tip="${s}" onclick="viewSubject('${s}')">
                        <span class="subitem-icon">üìö</span>
                        <span class="subitem-label font-extrabold" style="line-height:1.2;">${s}</span>
                        <span class="subj-dot" style="background:${pal.border};"></span>
                        <span class="subj-pct" style="color:${pal.text};">${pct}%</span>
                    </div>
                `;
            }).join('');
            document.getElementById('subjectMenuList').innerHTML = menuHtml;
        }

        function renderSubjectsTab() {
            const tbody = document.getElementById('subjectsTable');
            if (!tbody) return;

            const rows = (appData.subjects || []).map(s => {
                const { completed, total, pct } = getSubjectProgress(s);
                const pal = getProgressPalette(pct);

                return `
                    <tr class="border-b border-black/5 table-row-hover">
                        <td class="p-3 font-extrabold">${s}</td>
                        <td class="p-3">
                            <div class="flex items-center gap-3">
                                <div class="w-36">
                                    <div class="h-2 bg-white/70 rounded-full overflow-hidden">
                                        <div class="h-full" style="width:${pct}%; background:${pal.bar};"></div>
                                    </div>
                                </div>
                                <div class="font-extrabold" style="color:${pal.text};">${pct}%</div>
                            </div>
                        </td>
                        <td class="p-3 font-bold text-slate-600">${completed}/${total}</td>
                        <td class="p-3">
                            <button onclick="viewSubject('${s}')" class="px-3 py-2 rounded-2xl text-white font-extrabold text-xs btn-glow" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">Open</button>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows || `<tr><td class="p-4 text-slate-500" colspan="4">No subjects yet. Click ‚ÄúAdd Subject‚Äù.</td></tr>`;
        }

        function getAllTestsMerged() {
            const blueprint = (appData.tests || []).map(t => ({ ...t, origin: 'blueprint' }));
            const personal = (appData.userProgress.customTests || []).map(t => ({ ...t, origin: 'personal' }));
            return [...blueprint, ...personal];
        }

        function renderTests() {
            const tests = getAllTestsMerged()
                .slice()
                .sort((a, b) => (getEffectiveTestDate(a) || '').localeCompare(getEffectiveTestDate(b) || '') || ((a.number || 0) - (b.number || 0)));

            const html = tests.map(t => {
                const score = appData.userProgress.testScores[t.id];
                const focusText = t.focus || (t.subject ? `${t.subject} - Subject Test` : '-');
                const percentage = (score !== undefined && score !== null && Number.isFinite(Number(score))) ? Math.round((Number(score) / t.mcqs) * 100) : null;
                const status = (percentage === null)
                    ? '‚è≥ Pending'
                    : (percentage >= 80 ? '‚úÖ Excellent' : percentage >= 60 ? 'üëç Good' : '‚ö†Ô∏è Improve');

                const effDate = getEffectiveTestDate(t);
                const badge = t.origin === 'personal'
                    ? `<span class="ml-2 px-2 py-1 rounded-xl text-[11px] font-extrabold" style="background: rgba(34,197,94,0.14); border: 1px solid rgba(34,197,94,0.18); color: rgb(21,128,61);">Personal</span>`
                    : `<span class="ml-2 px-2 py-1 rounded-xl text-[11px] font-extrabold" style="background: rgba(99,102,241,0.12); border: 1px solid rgba(99,102,241,0.18); color: rgb(79,70,229);">Blueprint</span>`;

                const pctText = percentage === null ? '-' : `${percentage}%`;
                const pctClass = percentage === null ? '' : (percentage >= 80 ? 'text-emerald-600' : percentage >= 60 ? 'text-amber-600' : 'text-rose-600');

                const actions = t.origin === 'personal'
                    ? `<button onclick="deletePersonalTest('${t.id}')" class="px-3 py-1.5 rounded-2xl text-white font-extrabold text-xs btn-glow" style="background: linear-gradient(135deg, #ef4444, #f43f5e);">üóëÔ∏è Delete</button>`
                    : `<span class="text-xs text-slate-500">‚Äî</span>`;

                return `
                    <tr class="border-b border-black/5 table-row-hover">
                        <td class="p-3 font-extrabold">Test ${t.number || ''} ${badge}</td>
                        <td class="p-3">
                            <div class="date-chip">${formatDate(effDate)}</div>
                            <div class="mt-2">
                                <input type="date" value="${effDate || ''}" onchange="updateTestDate('${t.id}', this.value)" class="input-mini bg-white/70">
                            </div>
                        </td>
                        <td class="p-3 font-bold">${t.type}</td>
                        <td class="p-3">${t.mcqs}</td>
                        <td class="p-3">${focusText}</td>
                        <td class="p-3 font-bold">${t.target ?? '-'}</td>
                        <td class="p-3">
                            <input type="number" value="${score ?? ''}" placeholder="Score" min="0" max="${t.mcqs}" 
                                onchange="updateTestScore('${t.id}', this.value)"
                                class="w-24 px-3 py-2 border rounded-2xl text-center bg-white/70">
                        </td>
                        <td class="p-3 font-extrabold ${pctClass}">${pctText}</td>
                        <td class="p-3">${status}</td>
                        <td class="p-3">${actions}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('testsTable').innerHTML = html || `
                <tr><td class="p-4 text-slate-500" colspan="10">No tests found. Click ‚ÄúAdd Personal Test‚Äù.</td></tr>
            `;
        }

        function renderAnalytics() {
            const analyticsHtml = appData.subjects.map(s => {
                const subjectTasks = appData.tasks.filter(t => t.subject === s);
                const completed = subjectTasks.filter(t => appData.userProgress.completedTasks[t.id]).length;
                const progress = subjectTasks.length ? Math.round((completed / subjectTasks.length) * 100) : 0;
                const hours = subjectTasks
                    .filter(t => appData.userProgress.completedTasks[t.id])
                    .reduce((sum, t) => sum + (t.hours || 0), 0);

                const pal = getProgressPalette(progress);

                return `
                    <div class="flex items-center justify-between py-3 border-b border-black/5">
                        <div>
                            <div class="font-extrabold" style="color:${pal.text};">${s}</div>
                            <div class="text-sm text-slate-600">${completed}/${subjectTasks.length} topics ‚Ä¢ ${hours.toFixed(1)}h</div>
                        </div>
                        <div class="w-32">
                            <div class="text-right text-sm font-extrabold" style="color:${pal.text}; margin-bottom: 4px;">${progress}%</div>
                            <div class="h-2 bg-white/70 rounded-full overflow-hidden">
                                <div class="h-full" style="width: ${progress}%; background: ${pal.bar};"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('subjectAnalytics').innerHTML = analyticsHtml;

            const weeklyData = [4, 6, 3, 5, 8, 7, 2];
            const weeklyHtml = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((day, i) => `
                <div class="flex-1 flex flex-col items-center">
                    <div class="rounded-t-2xl w-full" style="height: ${weeklyData[i] * 15}px; background: linear-gradient(180deg, var(--primary), var(--primary-2));"></div>
                    <div class="text-xs text-slate-500 mt-2 font-bold">${day}</div>
                </div>
            `).join('');
            document.getElementById('weeklyChart').innerHTML = weeklyHtml;
        }

        // =============================================
        // CUTOFF ANALYTICS
        // =============================================
        function getCutoffForTest(test) {
            const c = appData.userProgress?.cutoffs || { subject: 55, mixed: 60, full: 80, fullMock: 150 };
            const type = (test?.type || '').toLowerCase();

            if (type.includes('subject')) return c.subject;
            if (type.includes('mixed')) return c.mixed;
            if (type === 'full') return c.full;
            if (type.includes('mock')) return c.fullMock; // Full Mock / Final Mock

            // fallback by mcqs
            if ((test?.mcqs || 0) >= 200) return c.fullMock;
            if ((test?.mcqs || 0) >= 100) return c.full;
            return c.mixed;
        }

        function renderCutoffAnalytics() {
            const tab = document.getElementById('tab-cutoff');
            if (!tab) return;

            // Populate inputs
            const c = appData.userProgress?.cutoffs || { subject: 55, mixed: 60, full: 80, fullMock: 150 };
            const elSubject = document.getElementById('cutoffSubject');
            const elMixed = document.getElementById('cutoffMixed');
            const elFull = document.getElementById('cutoffFull');
            const elFullMock = document.getElementById('cutoffFullMock');
            if (elSubject) elSubject.value = c.subject;
            if (elMixed) elMixed.value = c.mixed;
            if (elFull) elFull.value = c.full;
            if (elFullMock) elFullMock.value = c.fullMock;

            const tests = getAllTestsMerged()
                .slice()
                .sort((a, b) => (getEffectiveTestDate(a) || '').localeCompare(getEffectiveTestDate(b) || '') || ((a.number || 0) - (b.number || 0)));

            let attempted = 0;
            let met = 0;

            const rows = tests.map(t => {
                const scoreRaw = appData.userProgress?.testScores?.[t.id];
                const score = (scoreRaw === 0 || scoreRaw) ? Number(scoreRaw) : null;
                const cutoff = getCutoffForTest(t);
                const hasScore = Number.isFinite(score);
                if (hasScore) attempted++;
                const pass = hasScore ? score >= cutoff : null;
                if (pass) met++;

                const effDate = getEffectiveTestDate(t);

                const resultBadge = (pass === null)
                    ? `<span class="px-2 py-1 rounded-xl text-[11px] font-extrabold" style="background: rgba(100,116,139,0.12); border: 1px solid rgba(100,116,139,0.18); color: rgba(51,65,85,0.95);">Pending</span>`
                    : pass
                        ? `<span class="px-2 py-1 rounded-xl text-[11px] font-extrabold" style="background: rgba(34,197,94,0.14); border: 1px solid rgba(34,197,94,0.18); color: rgb(21,128,61);">Above cutoff</span>`
                        : `<span class="px-2 py-1 rounded-xl text-[11px] font-extrabold" style="background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.18); color: rgb(185,28,28);">Below cutoff</span>`;

                return `
                    <tr class="border-b border-black/5 table-row-hover">
                        <td class="p-3 font-extrabold">Test ${t.number || ''}</td>
                        <td class="p-3">
                            <div class="date-chip">${formatDate(effDate)}</div>
                        </td>
                        <td class="p-3 font-bold">${t.type || '-'}</td>
                        <td class="p-3 font-extrabold">${hasScore ? score : '-'}</td>
                        <td class="p-3 font-extrabold">${cutoff}</td>
                        <td class="p-3">${resultBadge}</td>
                    </tr>
                `;
            }).join('');

            const tbl = document.getElementById('cutoffTable');
            if (tbl) tbl.innerHTML = rows || `<tr><td class="p-4 text-slate-500" colspan="6">No tests found.</td></tr>`;

            const summary = document.getElementById('cutoffSummary');
            if (summary) {
                summary.textContent = attempted
                    ? `${met}/${attempted} attempted tests are above cutoff.`
                    : `No attempted tests yet. Enter scores in Test Tracker to see cutoff results.`;
            }
        }

        function saveCutoffs() {
            appData.userProgress.cutoffs ||= { subject: 55, mixed: 60, full: 80, fullMock: 150 };
            const s = Number(document.getElementById('cutoffSubject')?.value);
            const m = Number(document.getElementById('cutoffMixed')?.value);
            const f = Number(document.getElementById('cutoffFull')?.value);
            const fm = Number(document.getElementById('cutoffFullMock')?.value);

            if (Number.isFinite(s)) appData.userProgress.cutoffs.subject = s;
            if (Number.isFinite(m)) appData.userProgress.cutoffs.mixed = m;
            if (Number.isFinite(f)) appData.userProgress.cutoffs.full = f;
            if (Number.isFinite(fm)) appData.userProgress.cutoffs.fullMock = fm;

            saveProgress();
            renderCutoffAnalytics();
            showToast('Cutoffs saved!', 'success');
        }

        function renderAdminPanel() {
            const subjectListHtml = appData.subjects.map(s => `
                <div class="flex items-center justify-between bg-white/50 px-3 py-2 rounded-2xl border border-white/60">
                    <span class="font-bold">${s}</span>
                    <button onclick="adminDeleteSubject('${s}')" class="text-rose-500 hover:text-rose-700">üóëÔ∏è</button>
                </div>
            `).join('');
            document.getElementById('adminSubjectList').innerHTML = subjectListHtml;

            const testsHtml = appData.tests.length ? `
                <table class="w-full">
                    <thead class="bg-white/60">
                        <tr>
                            <th class="p-2 text-left">#</th>
                            <th class="p-2 text-left">Date</th>
                            <th class="p-2 text-left">Type</th>
                            <th class="p-2 text-left">MCQs</th>
                            <th class="p-2 text-left">Focus</th>
                            <th class="p-2 text-left">Target</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appData.tests
                            .slice()
                            .sort((a, b) => a.number - b.number)
                            .map(t => `
                            <tr class="border-b border-black/5 table-row-hover">
                                <td class="p-2 font-extrabold">${t.number}</td>
                                <td class="p-2">
                                    <input type="date" class="px-3 py-2 border rounded-2xl text-xs w-40 bg-white/70" value="${t.date}" onchange="adminUpdateTestDate('${t.id}', this.value)">
                                    <div class="text-xs text-slate-500 mt-1">${formatDate(t.date)}</div>
                                </td>
                                <td class="p-2">${t.type}</td>
                                <td class="p-2">${t.mcqs}</td>
                                <td class="p-2">${t.focus}</td>
                                <td class="p-2">${t.target}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p class="text-slate-500 text-center py-8">No tests configured.</p>';

            const adminTestsListEl = document.getElementById('adminTestsList');
            if (adminTestsListEl) adminTestsListEl.innerHTML = testsHtml;
        }

        // =============================================
        // SUBJECT VIEW RENDER
        // =============================================
        function renderSubjectViewTable() {
            if (!activeSubject) return;
            const titleEl = document.getElementById('subjectViewTitle');
            titleEl.textContent = 'üìö ' + activeSubject;
            titleEl.style.color = '';

            const subjectTasks = appData.tasks
                .filter(t => t.subject === activeSubject)
                .slice()
                .sort((a, b) => getEffectiveTaskDate(a).localeCompare(getEffectiveTaskDate(b)));

            const html = subjectTasks.map(t => {
                const isCompleted = appData.userProgress.completedTasks[t.id];
                const effDate = getEffectiveTaskDate(t);
                const dayName = getDayName(effDate);
                const highlightClass = getTaskRowHighlightClass(effDate, isCompleted);
                return `
                    <tr class="${highlightClass} ${isCompleted ? 'completed-row' : ''} border-b border-black/5 table-row-hover">
                        <td class="p-3">
                            <div class="hover-bounce topic-inline"><div class="font-extrabold">${t.morning}</div></div>
                            <div class="mt-2 hover-bounce topic-inline" style="font-size: 12px;">${t.evening}</div>
                        </td>
                        <td class="p-3">
                            <div class="date-chip bounceable">${formatDate(effDate)} ‚Ä¢ ${dayName}</div>
                            <div class="mt-2">
                                <input type="date" value="${effDate}" onchange="updateTaskDate('${t.id}', this.value)" class="input-mini bg-white/70">
                            </div>
                        </td>
                        <td class="p-3 font-bold">${dayName}</td>
                        <td class="p-3 font-bold">${t.hours}h</td>
                        <td class="p-3">
                            <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleTask('${t.id}')" class="w-5 h-5 accent-indigo-500 cursor-pointer">
                        </td>
                        <td class="p-3">
                            <button onclick="editTask('${t.id}')" class="text-indigo-600 hover:text-indigo-800 font-bold mr-2">‚úèÔ∏è</button>
                            <button onclick="deleteTask('${t.id}')" class="text-rose-500 hover:text-rose-700 font-bold">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('subjectTopicsTable').innerHTML = html || `
                <tr><td class="p-3 text-slate-500" colspan="6">No tasks found for ${activeSubject}. Add a topic to start tracking.</td></tr>
            `;
        }

        // =============================================
        // UI INTERACTIONS
        // =============================================
        function applySidebarPrefs() {
            const pinned = localStorage.getItem('wbcs_sidebar_pinned') === '1';
            const collapsed = localStorage.getItem('wbcs_sidebar_collapsed') === '1';

            document.body.classList.toggle('sidebar-pinned', pinned);
            const sb = document.getElementById('appSidebar');
            if (sb) sb.classList.toggle('collapsed', pinned && collapsed);

            // If pinned, keep it open; overlay should be off.
            if (pinned) {
                sb?.classList.add('active');
                document.querySelector('.overlay')?.classList.remove('active');
            }
        }

        function toggleSidebarPin() {
            const currentlyPinned = document.body.classList.contains('sidebar-pinned');
            const next = !currentlyPinned;
            localStorage.setItem('wbcs_sidebar_pinned', next ? '1' : '0');

            // If unpinning, also uncollapse (so drawer returns normal)
            if (!next) {
                localStorage.setItem('wbcs_sidebar_collapsed', '0');
            }

            applySidebarPrefs();
            showToast(next ? 'Sidebar pinned' : 'Sidebar unpinned', 'info');
        }

        function toggleSidebarCollapse() {
            const pinned = document.body.classList.contains('sidebar-pinned');
            if (!pinned) {
                // If not pinned, pin first (collapse is a desktop feature)
                localStorage.setItem('wbcs_sidebar_pinned', '1');
            }
            const current = localStorage.getItem('wbcs_sidebar_collapsed') === '1';
            localStorage.setItem('wbcs_sidebar_collapsed', current ? '0' : '1');
            applySidebarPrefs();
        }

        function toggleSidebar() {
            // If pinned on desktop, don't toggle off.
            if (document.body.classList.contains('sidebar-pinned')) return;
            document.querySelector('.sidebar')?.classList.toggle('active');
            document.querySelector('.overlay')?.classList.toggle('active');
        }

        function toggleSubmenu(id) {
            const menu = document.getElementById(id);
            const arrow = document.getElementById(id + 'Arrow');
            menu.classList.toggle('hidden');
            arrow.textContent = menu.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
        }

        function setActiveTab(tabId, silent = false) {
            const target = document.getElementById('tab-' + tabId);
            const fallback = document.getElementById('tab-overview');

            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            if (target) {
                target.classList.add('active');
                activeTabId = tabId;
            } else {
                fallback?.classList.add('active');
                activeTabId = 'overview';
            }

            const st = document.getElementById('statusActiveTab');
            if (st) st.textContent = activeTabId;

            // sidebar active highlight
            try {
                document.querySelectorAll('.sidebar nav .menu-item').forEach(el => el.classList.remove('active'));
                const map = {
                    overview: "üìä",
                    weekday: "üìÖ",
                    weekend: "üåÖ",
                    tests: "‚úÖ",
                    analytics: "üìà",
                    cutoff: "üéØ"
                };
                const icon = map[activeTabId];
                if (icon) {
                    const item = Array.from(document.querySelectorAll('.sidebar nav .menu-item')).find(n => (n.textContent || '').includes(icon));
                    if (item) item.classList.add('active');
                }
            } catch (e) {}

            if (!silent) toggleSidebar();
        }

        function switchTab(tabId) {
            setActiveTab(tabId, false);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            appData.userProgress.darkMode = document.body.classList.contains('dark-mode');
            saveProgress();
        }

        // =============================================
        // TASK OPERATIONS
        // =============================================
        function toggleTask(taskId) {
            appData.userProgress.completedTasks[taskId] = !appData.userProgress.completedTasks[taskId];
            saveProgress();
            renderAll();
        }

        function updateTestScore(testId, score) {
            const n = parseInt(score);
            appData.userProgress.testScores[testId] = Number.isFinite(n) ? n : null;
            saveProgress();
            renderAll();
        }

        // =============================================
        // PERSONAL TESTS (per-user)
        // =============================================
        function getNextTestNumber() {
            const all = getAllTestsMerged();
            const maxN = all.reduce((m, t) => Math.max(m, Number(t.number) || 0), 0);
            return maxN + 1;
        }

        function parseTestTypeOption(raw) {
            const s = String(raw || '').trim();
            let baseType = s;
            let marks = null;

            const m = s.match(/\((\d+)\)/);
            if (m) {
                marks = parseInt(m[1], 10);
                baseType = s.split('(')[0].trim();
            }

            // Normalize common variants
            if (/^full mock/i.test(baseType)) baseType = 'Full Mock';
            if (/^final mock/i.test(baseType)) baseType = 'Final Mock';
            if (/^mixed/i.test(baseType)) baseType = 'Mixed';
            if (/^subject/i.test(baseType)) baseType = 'Subject';
            if (/^full/i.test(baseType)) baseType = 'Full';

            // Default marks per type
            if (!Number.isFinite(marks)) {
                if (baseType === 'Full Mock' || baseType === 'Final Mock') marks = 200;
                else if (baseType === 'Full') marks = 100;
                else if (baseType === 'Subject') marks = 75;
                else if (baseType === 'Mixed') marks = 75;
            }

            // Default targets (roughly 80% goal; final mock ~85%)
            let target = null;
            if (Number.isFinite(marks)) {
                target = Math.round(marks * (baseType === 'Final Mock' ? 0.85 : 0.8));
            }

            return { type: baseType, marks, target };
        }

        function updatePersonalTestTypeUI() {
            const typeEl = document.getElementById('personalTestType');
            const subjectWrap = document.getElementById('personalSubjectWrap');
            const subjectEl = document.getElementById('personalSubject');
            const focusEl = document.getElementById('personalFocus');
            const marksEl = document.getElementById('personalTestMcqs');
            const targetEl = document.getElementById('personalTestTarget');

            if (!typeEl || !subjectWrap || !subjectEl || !focusEl || !marksEl || !targetEl) return;

            const parsed = parseTestTypeOption(typeEl.value);
            const isSubject = parsed.type === 'Subject';
            subjectWrap.classList.toggle('hidden', !isSubject);

            // Smart defaults (only if user hasn't already typed custom values)
            const marksWasEmpty = !marksEl.dataset.userEdited;
            const targetWasEmpty = !targetEl.dataset.userEdited;

            if (marksWasEmpty && Number.isFinite(parsed.marks)) marksEl.value = parsed.marks;
            if (targetWasEmpty && Number.isFinite(parsed.target)) targetEl.value = parsed.target;

            if (isSubject) {
                const subj = subjectEl.value;
                if (!focusEl.value) focusEl.value = `${subj} - Subject Test`;
            }
        }

        function openAddPersonalTestModal() {
            const nextNum = getNextTestNumber();
            const todayISO = toLocalISODate(new Date());

            openModal('‚ûï Add Personal Test', `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block font-extrabold mb-2 text-slate-700">Test Number</label>
                            <input type="number" id="personalTestNumber" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${nextNum}">
                        </div>
                        <div>
                            <label class="block font-extrabold mb-2 text-slate-700">Date</label>
                            <input type="date" id="personalTestDate" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${todayISO}">
                        </div>
                    </div>

                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Type</label>
                        <select id="personalTestType" class="w-full px-4 py-3 border rounded-2xl bg-white/70" onchange="updatePersonalTestTypeUI()">
                            <option>Subject</option>
                            <option>Mixed (20)</option>
                            <option>Mixed (30)</option>
                            <option>Mixed (50)</option>
                            <option>Mixed (100)</option>
                            <option>Full (100)</option>
                            <option>Full Mock (200)</option>
                            <option>Final Mock (200)</option>
                        </select>
                    </div>

                    <div id="personalSubjectWrap">
                        <label class="block font-extrabold mb-2 text-slate-700">Subject</label>
                        <select id="personalSubject" class="w-full px-4 py-3 border rounded-2xl bg-white/70" onchange="updatePersonalTestTypeUI()">
                            ${(appData.subjects || []).map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block font-extrabold mb-2 text-slate-700">Marks</label>
                            <input type="number" id="personalTestMcqs" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="75" min="1" oninput="this.dataset.userEdited='1'">
                        </div>
                        <div>
                            <label class="block font-extrabold mb-2 text-slate-700">Target Score</label>
                            <input type="number" id="personalTestTarget" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="60" min="0" oninput="this.dataset.userEdited='1'">
                        </div>
                    </div>

                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Focus / Notes</label>
                        <input type="text" id="personalFocus" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="e.g., Polity (FR + DPSP) + 50 MCQs">
                    </div>

                    <div class="text-xs text-slate-500">
                        Personal tests are saved only for your account and synced to Firestore under <code>wbcsUsers/{uid}.userProgress.customTests</code>.
                    </div>
                </div>
            `, () => {
                const id = 'ptest-' + Date.now();
                const number = parseInt(document.getElementById('personalTestNumber').value) || getNextTestNumber();
                const date = document.getElementById('personalTestDate').value;
                const rawType = document.getElementById('personalTestType').value;
                const parsed = parseTestTypeOption(rawType);
                const marks = parseInt(document.getElementById('personalTestMcqs').value) || parsed.marks || 75;
                const target = parseInt(document.getElementById('personalTestTarget').value) || parsed.target || 0;
                const focus = (document.getElementById('personalFocus').value || '').trim();

                let finalFocus = focus;
                let subject = null;
                if (parsed.type === 'Subject') {
                    subject = document.getElementById('personalSubject').value;
                    if (!finalFocus) finalFocus = `${subject} - Subject Test`;
                }

                appData.userProgress.customTests ||= [];
                appData.userProgress.customTests.push({
                    id,
                    number,
                    date,
                    type: parsed.type,
                    mcqs: marks,
                    focus: finalFocus,
                    target,
                    subject
                });

                saveProgress();
                renderAll();
                showToast('Personal test added!', 'success');
            });

            setTimeout(updatePersonalTestTypeUI, 0);
        }

        function deletePersonalTest(testId) {
            if (!confirm('Delete this personal test?')) return;
            appData.userProgress.customTests = (appData.userProgress.customTests || []).filter(t => t.id !== testId);
            if (appData.userProgress.testScores) delete appData.userProgress.testScores[testId];
            if (appData.userProgress.customTestDates) delete appData.userProgress.customTestDates[testId];
            saveProgress();
            renderAll();
            showToast('Personal test removed', 'info');
        }

        // =============================================
        // SUBJECT OPERATIONS
        // =============================================
        function viewSubject(name) {
            activeSubject = name;
            renderSubjectViewTable();
            setActiveTab('subject-view');
        }

        function createNewSubject() {
            openModal('Add New Subject', `
                <div class="mb-2">
                    <label class="block font-extrabold mb-2 text-slate-700">Subject Name</label>
                    <input type="text" id="newSubjectName" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="e.g., Physics">
                </div>
            `, async () => {
                const name = document.getElementById('newSubjectName').value.trim();
                if (name && !appData.subjects.includes(name)) {
                    appData.subjects.push(name);
                    await saveAppData();
                    await saveProgress();
                    renderAll();
                    showToast('Subject added!', 'success');
                }
            });
        }

        function deleteCurrentSubject() {
            if (!activeSubject) return;
            if (confirm(`Delete subject "${activeSubject}"? This won't delete tasks.`)) {
                appData.subjects = appData.subjects.filter(s => s !== activeSubject);
                saveAppData();
                activeSubject = null;
                renderAll();
                setActiveTab('overview');
                showToast('Subject deleted', 'info');
            }
        }

        function addTopicToSubject() {
            if (!activeSubject) return;
            openModal('Add Topic to ' + activeSubject, `
                <div class="space-y-4">
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Morning Topic</label>
                        <input type="text" id="topicMorning" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="Theory topic...">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Evening Practice</label>
                        <input type="text" id="topicEvening" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="MCQs, practice...">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block font-extrabold mb-2 text-slate-700">Date</label>
                            <input type="date" id="topicDate" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${toLocalISODate(new Date())}">
                        </div>
                        <div>
                            <label class="block font-extrabold mb-2 text-slate-700">Hours</label>
                            <input type="number" id="topicHours" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="3" step="0.5">
                        </div>
                    </div>
                </div>
            `, async () => {
                const newTask = {
                    id: 'task-' + Date.now(),
                    morning: document.getElementById('topicMorning').value,
                    evening: document.getElementById('topicEvening').value,
                    date: document.getElementById('topicDate').value,
                    hours: parseFloat(document.getElementById('topicHours').value) || 3,
                    subject: activeSubject,
                    test: '-'
                };
                appData.tasks.push(newTask);
                await saveAppData();
                renderAll();
                setActiveTab('subject-view');
                showToast('Topic added!', 'success');
            });
        }

        // =============================================
        // ADMIN FUNCTIONS
        // =============================================
        function adminAddSubject() { createNewSubject(); }

        function adminDeleteSubject(name) {
            if (confirm(`Delete subject "${name}"?`)) {
                appData.subjects = appData.subjects.filter(s => s !== name);
                saveAppData();
                renderAll();
                showToast('Subject deleted', 'info');
            }
        }

        function loadAdminMonthTasks() {
            const month = document.getElementById('adminMonthSelect').value;
            const monthTasks = appData.tasks
                .filter(t => (t.date || '').split('-')[1] === month)
                .slice()
                .sort((a, b) => (a.date || '').localeCompare(b.date || ''));

            const html = monthTasks.length ? `
                <table class="w-full">
                    <thead class="bg-white/60">
                        <tr>
                            <th class="p-2 text-left">Date</th>
                            <th class="p-2 text-left">Morning</th>
                            <th class="p-2 text-left">Evening</th>
                            <th class="p-2 text-left">Subject</th>
                            <th class="p-2 text-left">Hours</th>
                            <th class="p-2 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${monthTasks.map(t => `
                            <tr class="border-b border-black/5 table-row-hover">
                                <td class="p-2">
                                    <input type="date" value="${t.date}" onchange="adminUpdateTaskDate('${t.id}', this.value)" class="px-3 py-2 border rounded-2xl text-xs w-40 bg-white/70">
                                    <div class="text-xs text-slate-500 mt-1">${formatDate(t.date)}</div>
                                </td>
                                <td class="p-2">${t.morning}</td>
                                <td class="p-2">${t.evening}</td>
                                <td class="p-2">${t.subject}</td>
                                <td class="p-2">${t.hours}</td>
                                <td class="p-2">
                                    <button onclick="editTask('${t.id}')" class="text-indigo-600 font-bold mr-2">‚úèÔ∏è</button>
                                    <button onclick="deleteTask('${t.id}')" class="text-rose-600 font-bold">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p class="text-slate-500 text-center py-8">No tasks for this month.</p>';

            document.getElementById('adminTasksList').innerHTML = html;
        }

        function adminAddTask() {
            const month = document.getElementById('adminMonthSelect').value;
            openModal('Add New Task', `
                <div class="space-y-4">
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Date</label>
                        <input type="date" id="taskDate" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="2026-${month}-01">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Morning Topic</label>
                        <input type="text" id="taskMorning" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Evening Practice</label>
                        <input type="text" id="taskEvening" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Test/Activity</label>
                        <input type="text" id="taskTest" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="-">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Subject</label>
                        <select id="taskSubject" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                            ${appData.subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Hours</label>
                        <input type="number" id="taskHours" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="3.75" step="0.25">
                    </div>
                </div>
            `, () => {
                const newTask = {
                    id: 'task-' + Date.now(),
                    date: document.getElementById('taskDate').value,
                    morning: document.getElementById('taskMorning').value,
                    evening: document.getElementById('taskEvening').value,
                    test: document.getElementById('taskTest').value,
                    subject: document.getElementById('taskSubject').value,
                    hours: parseFloat(document.getElementById('taskHours').value)
                };
                appData.tasks.push(newTask);
                saveAppData();
                loadAdminMonthTasks();
                renderAll();
                showToast('Task added!', 'success');
            });
        }

        function editTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;

            openModal('Edit Task', `
                <div class="space-y-4">
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Date</label>
                        <input type="date" id="editDate" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${task.date}">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Morning Topic</label>
                        <input type="text" id="editMorning" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${task.morning}">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Evening Practice</label>
                        <input type="text" id="editEvening" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${task.evening}">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Test/Activity</label>
                        <input type="text" id="editTest" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${task.test}">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Subject</label>
                        <select id="editSubject" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                            ${appData.subjects.map(s => `<option value="${s}" ${s === task.subject ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Hours</label>
                        <input type="number" id="editHours" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${task.hours}" step="0.25">
                    </div>
                </div>
            `, async () => {
                task.date = document.getElementById('editDate').value;
                task.morning = document.getElementById('editMorning').value;
                task.evening = document.getElementById('editEvening').value;
                task.test = document.getElementById('editTest').value;
                task.subject = document.getElementById('editSubject').value;
                task.hours = parseFloat(document.getElementById('editHours').value);
                await saveAppData();
                renderAll();
                showToast('Task updated!', 'success');
            });
        }

        function deleteTask(taskId) {
            if (confirm('Delete this task?')) {
                appData.tasks = appData.tasks.filter(t => t.id !== taskId);
                if (appData.userProgress?.completedTasks) delete appData.userProgress.completedTasks[taskId];
                if (appData.userProgress?.customDates) delete appData.userProgress.customDates[taskId];

                saveAppData();
                saveProgress();
                renderAll();
                showToast('Task deleted', 'info');
            }
        }

        function adminAddTest() {
            const nextNum = appData.tests.length + 1;
            openModal('Add New Test (Blueprint)', `
                <div class="space-y-4">
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Test Number</label>
                        <input type="number" id="testNumber" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${nextNum}">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Date</label>
                        <input type="date" id="testDate" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Type</label>
                        <select id="testType" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                            <option>Subject</option>
                            <option>Mixed</option>
                            <option>Full</option>
                            <option>Full Mock</option>
                            <option>Final Mock</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">MCQs</label>
                        <input type="number" id="testMcqs" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="75">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Focus Area</label>
                        <input type="text" id="testFocus" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Target Score</label>
                        <input type="number" id="testTarget" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="60">
                    </div>
                </div>
            `, () => {
                const newTest = {
                    id: 'test-' + Date.now(),
                    number: parseInt(document.getElementById('testNumber').value),
                    date: document.getElementById('testDate').value,
                    type: document.getElementById('testType').value,
                    mcqs: parseInt(document.getElementById('testMcqs').value),
                    focus: document.getElementById('testFocus').value,
                    target: parseInt(document.getElementById('testTarget').value)
                };
                appData.tests.push(newTest);
                appData.tests.sort((a, b) => a.number - b.number);
                saveAppData();
                renderAll();
                showToast('Blueprint test added!', 'success');
            });
        }

        function editRoutine(type) {
            const routine = appData.routines[type];
            const html = routine.map((r, i) => `
                <div class="border border-white/60 rounded-2xl p-3 mb-2 bg-white/40">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" value="${r.time}" placeholder="Time" class="routine-time px-3 py-2 border rounded-2xl bg-white/70" data-index="${i}">
                        <input type="text" value="${r.duration}" placeholder="Duration" class="routine-duration px-3 py-2 border rounded-2xl bg-white/70" data-index="${i}">
                    </div>
                    <input type="text" value="${r.activity}" placeholder="Activity" class="routine-activity w-full px-3 py-2 border rounded-2xl bg-white/70 mb-2" data-index="${i}">
                    <input type="text" value="${r.details}" placeholder="Details" class="routine-details w-full px-3 py-2 border rounded-2xl bg-white/70" data-index="${i}">
                </div>
            `).join('');

            openModal('Edit ' + type.charAt(0).toUpperCase() + type.slice(1) + ' Routine', html, () => {
                routine.forEach((r, i) => {
                    r.time = document.querySelector(`.routine-time[data-index="${i}"]`).value;
                    r.activity = document.querySelector(`.routine-activity[data-index="${i}"]`).value;
                    r.details = document.querySelector(`.routine-details[data-index="${i}"]`).value;
                    r.duration = document.querySelector(`.routine-duration[data-index="${i}"]`).value;
                });
                saveAppData();
                renderRoutines();
                showToast('Routine updated!', 'success');
            });
        }

        // =============================================
        // MODAL FUNCTIONS
        // =============================================
        function openModal(title, bodyHtml, onSubmit) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = bodyHtml;
            document.getElementById('modalSubmit').onclick = () => {
                onSubmit();
                closeModal();
            };
            document.getElementById('genericModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('genericModal').classList.add('hidden');
        }

        function openNotesModal() {
            document.getElementById('notesModal').classList.remove('hidden');
        }

        function closeNotesModal() {
            document.getElementById('notesModal').classList.add('hidden');
        }

        function saveNotes() {
            appData.userProgress.notes = document.getElementById('globalNotes').value;
            saveProgress();
            showToast('Notes saved!', 'success');
        }

        // =============================================
        // TIMER FUNCTIONS
        // =============================================
        function openTimerModal() {
            document.getElementById('timerModal').classList.remove('hidden');
        }

        function closeTimerModal() {
            document.getElementById('timerModal').classList.add('hidden');
        }

        function openSettingsModal() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function openNotionModal() {
            document.getElementById('notionModal').classList.remove('hidden');
            document.getElementById('notionStatus').textContent = '';
            const savedToken = localStorage.getItem('wbcs_notion_token');
            const savedDb = localStorage.getItem('wbcs_notion_db');
            const savedParent = localStorage.getItem('wbcs_notion_parent');
            if (savedToken) document.getElementById('notionToken').value = savedToken;
            if (savedDb) document.getElementById('notionDbId').value = savedDb;
            if (savedParent) document.getElementById('notionParentPage').value = savedParent;
        }

        function closeNotionModal() {
            document.getElementById('notionModal').classList.add('hidden');
        }

        function openNotionHelp() {
            const msg = `To get IDs:\n\n1) Open the Notion page you want to use as the parent.\n2) Copy the page URL and extract the 32‚Äëchar ID after the last slash.\n3) For a database ID, open the DB and copy the URL (same 32‚Äëchar ID).\n\nMake sure the page/database is shared with your integration.`;
            alert(msg);
        }

        function normalizeNotionId(raw) {
            if (!raw) return '';
            const clean = raw.trim().replace(/[-]/g, '');
            const match = clean.match(/([a-f0-9]{32})/i);
            return match ? match[1] : clean;
        }

        function buildNotionDatabaseSchema() {
            return {
                Name: { title: {} },
                Date: { date: {} },
                Type: { select: { options: [
                    { name: 'Task' },
                    { name: 'Test' }
                ]}},
                Subject: { select: {} },
                Status: { select: { options: [
                    { name: 'Pending' },
                    { name: 'Completed' }
                ]}},
                Notes: { rich_text: {} },
                Hours: { number: { format: 'number' } }
            };
        }

        async function createNotionDatabase() {
            const token = document.getElementById('notionToken').value.trim();
            const parentRaw = document.getElementById('notionParentPage').value.trim();
            const statusEl = document.getElementById('notionStatus');
            const useProxy = document.getElementById('notionUseProxy')?.checked;

            if (!token || !parentRaw) {
                statusEl.textContent = 'Please provide Integration Token and Parent Page ID.';
                return;
            }

            const parentId = normalizeNotionId(parentRaw);
            const endpoint = useProxy
                ? 'https://cors.isomorphic-git.org/https://api.notion.com/v1/databases'
                : 'https://api.notion.com/v1/databases';

            statusEl.textContent = 'Creating Notion database...';
            localStorage.setItem('wbcs_notion_token', token);
            localStorage.setItem('wbcs_notion_parent', parentId);

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Notion-Version': '2022-06-28',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        parent: { type: 'page_id', page_id: parentId },
                        title: [{ type: 'text', text: { content: 'wbcs_preparation_tracker' } }],
                        properties: buildNotionDatabaseSchema()
                    })
                });

                if (!res.ok) {
                    const text = await res.text();
                    statusEl.textContent = `Create failed: ${text || res.status}`;
                    return;
                }

                const data = await res.json();
                const dbId = data?.id || '';
                if (dbId) {
                    const normalized = normalizeNotionId(dbId);
                    document.getElementById('notionDbId').value = normalized;
                    localStorage.setItem('wbcs_notion_db', normalized);
                    statusEl.textContent = 'Database created! ID auto-filled above.';
                    showToast('Notion DB created', 'success');
                } else {
                    statusEl.textContent = 'Database created but no ID returned. Check Notion.';
                }
            } catch (e) {
                statusEl.textContent = 'Create failed. Browser CORS may be blocking Notion. Keep proxy enabled.';
            }
        }

        function buildNotionPayload(item, type = 'Task') {
            const title = item.title || item.morning || item.name || `Test ${item.number || ''}`.trim();
            const date = item.date || item.effDate || item.scheduledDate || '';
            const subject = item.subject || item.topics || 'General';
            const status = item.status || (item.completed ? 'Completed' : 'Pending');
            const notes = item.notes || item.evening || item.focus || item.test || '';
            const hours = Number(item.hours || 0);

            return {
                Name: { title: [{ text: { content: title || 'Untitled' } }] },
                Date: date ? { date: { start: date } } : undefined,
                Type: { select: { name: type } },
                Subject: { select: { name: subject || 'General' } },
                Status: { select: { name: status } },
                Notes: { rich_text: notes ? [{ text: { content: notes } }] : [] },
                Hours: hours ? { number: hours } : undefined
            };
        }

        async function syncToNotion(upsert = false) {
            const token = document.getElementById('notionToken').value.trim();
            const dbIdRaw = document.getElementById('notionDbId').value.trim();
            const scope = document.getElementById('notionScope').value;
            const useProxy = document.getElementById('notionUseProxy')?.checked;
            const statusEl = document.getElementById('notionStatus');

            const dbId = normalizeNotionId(dbIdRaw);
            if (!token || !dbId) {
                statusEl.textContent = 'Please provide both Integration Token and Database ID.';
                return;
            }

            localStorage.setItem('wbcs_notion_token', token);
            localStorage.setItem('wbcs_notion_db', dbId);

            statusEl.textContent = 'Syncing with Notion...';

            const tasks = (scope === 'tests') ? [] : appData.tasks.map(t => ({
                ...t,
                date: getEffectiveTaskDate(t),
                completed: !!appData.userProgress?.completedTasks?.[t.id]
            }));

            const tests = (scope === 'tasks') ? [] : getAllTestsMerged().map(t => ({
                ...t,
                date: getEffectiveTestDate(t),
                completed: Number.isFinite(Number(appData.userProgress?.testScores?.[t.id]))
            }));

            const items = [
                ...tasks.map(t => ({ type: 'Task', props: buildNotionPayload(t, 'Task') })),
                ...tests.map(t => ({ type: 'Test', props: buildNotionPayload(t, 'Test') }))
            ];

            const endpoint = useProxy
                ? 'https://cors.isomorphic-git.org/https://api.notion.com/v1/pages'
                : 'https://api.notion.com/v1/pages';

            let success = 0;
            let fail = 0;

            try {
                for (const item of items) {
                    const res = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Notion-Version': '2022-06-28',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            parent: { database_id: dbId },
                            properties: item.props
                        })
                    });

                    if (res.ok) {
                        success++;
                    } else {
                        fail++;
                    }
                }
            } catch (e) {
                statusEl.textContent = 'Sync failed. Browser CORS may be blocking Notion. Keep proxy enabled or use a backend proxy.';
                return;
            }

            statusEl.textContent = `Sync complete. Success: ${success}, Failed: ${fail}`;
            showToast('Notion sync completed', 'success');
        }

        function startTimer() {
            if (timerInterval) return;
            timerInterval = setInterval(() => {
                timerSeconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        function resetTimer() {
            pauseTimer();
            timerSeconds = 0;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const hrs = Math.floor(timerSeconds / 3600);
            const mins = Math.floor((timerSeconds % 3600) / 60);
            const secs = timerSeconds % 60;
            const full = `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            const el = document.getElementById('timerDisplay');
            if (el) el.textContent = full;

            // Bottom bar mini timer (show minutes if any, else seconds)
            const mini = document.getElementById('statusMiniTimer');
            if (mini) {
                if (hrs > 0) mini.textContent = `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
                else if (mins > 0) mini.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                else mini.textContent = String(secs).padStart(2, '0');
            }
        }

        function saveSession() {
            const hours = timerSeconds / 3600;
            appData.userProgress.studySessions.push({
                date: new Date().toISOString(),
                duration: hours
            });
            saveProgress();
            resetTimer();
            showToast(`Session saved: ${hours.toFixed(2)} hours`, 'success');
        }

        // =============================================
        // DATA IMPORT/EXPORT
        // =============================================
        function exportData() {
            const data = {
                appData,
                exportDate: new Date().toISOString(),
                user: currentUser.email
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wbcs-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup downloaded!', 'success');
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.appData) {
                        appData = imported.appData;
                        normalizeUserProgress();
                        saveAppData();
                        saveProgress();
                        renderAll();
                        showToast('Data restored successfully!', 'success');
                    }
                } catch (err) {
                    showToast('Invalid backup file', 'error');
                }
            };
            reader.readAsText(file);
        }

        async function syncData() {
            showToast('Syncing with cloud...', 'info');
            await saveProgress();
            await loadAppData();
            renderAll();
            showToast('Synced!', 'success');
        }

        // =============================================
        // TOAST NOTIFICATIONS
        // =============================================
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // =============================================
        // Fancy glow cursor tracking for .btn-glow
        // =============================================
        document.addEventListener('pointermove', (e) => {
            const target = e.target.closest('.btn-glow');
            if (!target) return;
            const rect = target.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            target.style.setProperty('--x', `${x}%`);
            target.style.setProperty('--y', `${y}%`);
        });

        // =============================================
        // INITIALIZATION
        // =============================================
        window.onload = () => {
            // Firebase-auth-first boot:
            // - If signed in with Firebase: show app
            // - Otherwise: show auth screen

            const savedUser = localStorage.getItem('wbcs_user');
            currentUser = savedUser ? JSON.parse(savedUser) : null;

            const showAuth = () => {
                document.getElementById('mainApp')?.classList.add('hidden');
                document.getElementById('authScreen')?.classList.remove('hidden');
                document.getElementById('authScreen')?.setAttribute('aria-hidden', 'false');
            };

            const showApp = async () => {
                document.getElementById('authScreen')?.classList.add('hidden');
                document.getElementById('authScreen')?.setAttribute('aria-hidden', 'true');
                document.getElementById('mainApp')?.classList.remove('hidden');
                await initializeApp();
            };

            if (!firebaseReady || !firebaseAuth) {
                // If Firebase isn't available, fallback to local mode without blocking.
                currentUser = currentUser || { email: 'local@wbcs.app', name: 'Local User', isAdmin: false };
                showApp();
                return;
            }

            firebaseAuth.onAuthStateChanged(async (u) => {
                if (u) {
                    const idToken = await u.getIdToken().catch(() => null);
                    if (idToken) localStorage.setItem('wbcs_token', idToken);

                    currentUser = {
                        email: u.email,
                        name: u.displayName || (u.email ? u.email.split('@')[0] : 'User'),
                        isAdmin: false,
                        uid: u.uid,
                        authProvider: 'firebase'
                    };
                    localStorage.setItem('wbcs_user', JSON.stringify(currentUser));
                    await showApp();
                } else {
                    localStorage.removeItem('wbcs_token');
                    localStorage.removeItem('wbcs_user');
                    showAuth();
                }
            });
        };
    </script>

</body>
</html>
