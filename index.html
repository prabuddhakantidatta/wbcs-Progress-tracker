<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBCS 2026 - Interactive Prep Tracker</title>
    <style>
        /* CSS variables for theme consistency */
        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --dark-bg: #1a1a2e;
            --dark-card: #16213e;
            --text-main: #333;
            --text-light: #eee;
        }

        @media print {
            .no-print { display: none !important; }
            body { font-size: 10pt !important; color: #000 !important; background: white !important; }
            .container { padding: 0 !important; box-shadow: none !important; margin: 0 !important; max-width: 100% !important; }
            table { font-size: 8pt !important; border: 1px solid #ddd !important; }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; line-height: 1.6; color: var(--text-main); background: #f5f7fa; transition: 0.3s; }
        body.dark-mode { background: var(--dark-bg); color: var(--text-light); }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px 20px 20px 80px; transition: margin-left 0.3s; }
        @media (max-width: 768px) { .container { padding-left: 20px; padding-top: 80px; } }

        /* Sidebar */
        .sidebar { position: fixed; left: -280px; top: 0; width: 280px; height: 100%; background: #16213e; color: white; transition: 0.3s; z-index: 2000; overflow-y: auto; padding: 20px 0; box-shadow: 4px 0 15px rgba(0,0,0,0.3); }
        .sidebar.active { left: 0; }
        .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .menu-item { padding: 12px 25px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; border-left: 4px solid transparent; font-weight: 500; }
        .menu-item:hover { background: rgba(255,255,255,0.1); border-left-color: var(--primary); }
        .menu-item.active { background: var(--primary); border-left-color: var(--primary-dark); }
        .menu-submenu { background: rgba(0,0,0,0.2); display: none; padding: 5px 0; }
        .menu-submenu.active { display: block; }
        .submenu-item { padding: 10px 45px; font-size: 14px; cursor: pointer; opacity: 0.8; transition: 0.2s; }
        .submenu-item:hover { opacity: 1; color: var(--primary); background: rgba(255,255,255,0.05); }
        .submenu-item.active { color: var(--primary); font-weight: bold; }

        .sidebar-toggle { position: fixed; left: 20px; top: 20px; z-index: 1500; background: var(--primary); color: white; width: 45px; height: 45px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1999; }
        .sidebar-overlay.active { display: block; }

        /* UI Components */
        .app-header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; }
        .controls-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; align-items: center; }
        body.dark-mode .controls-bar { background: var(--dark-card); }

        .btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: #333; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }

        /* Stats Dashboard */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stats-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); }
        body.dark-mode .stats-card { background: var(--dark-card); border-color: var(--primary); }
        .stats-card h3 { font-size: 12px; text-transform: uppercase; color: #888; margin-bottom: 10px; }
        .stats-card .value { font-size: 28px; font-weight: bold; color: var(--primary); }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        body.dark-mode table { background: var(--dark-card); color: var(--text-light); }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; font-size: 14px; }
        td { padding: 10px; border: 1px solid #eee; font-size: 13px; vertical-align: middle; }
        body.dark-mode td { border-color: rgba(255,255,255,0.05); }
        tr:nth-child(even) { background: #fafafa; }
        body.dark-mode tr:nth-child(even) { background: rgba(255,255,255,0.02); }
        .completed-row { background: #d4edda !important; opacity: 0.7; }
        body.dark-mode .completed-row { background: #1a4d2e !important; }
        .completed-row td { text-decoration: line-through; }

        /* Inputs */
        .date-edit-input { border: 1px solid transparent; background: transparent; font-family: inherit; font-size: inherit; color: inherit; cursor: pointer; padding: 4px; border-radius: 4px; width: 100%; max-width: 130px; }
        .date-edit-input:hover { border-color: var(--primary); background: rgba(102, 126, 234, 0.1); }
        .task-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary); }
        .score-input { width: 60px; padding: 4px; text-align: center; border-radius: 4px; border: 1px solid #ddd; }

        /* Tabs */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { background: white; margin: 10vh auto; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        body.dark-mode .modal-content { background: var(--dark-card); color: white; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { font-size: 24px; cursor: pointer; color: #888; }
        .modal-body input, .modal-body textarea, .modal-body select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; }
        body.dark-mode .modal-body input, body.dark-mode .modal-body textarea { background: #0a2647; color: white; border-color: #333; }

        /* Progress Bar */
        .progress-bar-container { height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; background: var(--primary); transition: 0.5s; width: 0%; }

        .summary-box { border: 1px solid var(--primary); background: rgba(102, 126, 234, 0.05); padding: 20px; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <button class="sidebar-toggle no-print" onclick="toggleSidebar()">â˜°</button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar no-print" id="sidebar">
        <div class="sidebar-header">
            <h2 style="color: var(--primary); font-size: 20px;">ğŸ¯ WBCS 2026</h2>
            <p style="font-size: 11px; opacity: 0.6;">Interactive Study Portal</p>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active" onclick="switchTab('overview')">ğŸ“Š Dashboard Overview</div>
            <div class="menu-item" onclick="switchTab('weekday')">ğŸ“… Weekday Routine</div>
            <div class="menu-item" onclick="switchTab('weekend')">ğŸŒ… Weekend Routine</div>
            
            <div class="menu-item" onclick="toggleSubmenu('monthSubmenu')">
                ğŸ“† Monthly Schedules <span style="margin-left: auto;">â–¼</span>
            </div>
            <div id="monthSubmenu" class="menu-submenu"></div>

            <div class="menu-item" onclick="toggleSubmenu('subjectSubmenu')">
                ğŸ“š Subjects <span style="margin-left: auto;">â–¼</span>
            </div>
            <div id="subjectSubmenu" class="menu-submenu">
                <div class="submenu-item" onclick="createNewSubject()" style="color: var(--success); font-weight: bold;">â• Add Subject</div>
                <div id="subjectList"></div>
            </div>

            <div class="menu-item" onclick="switchTab('tests')">âœ… Test Tracker</div>
            <div class="menu-item" onclick="switchTab('analytics')">ğŸ“ˆ Progress Analytics</div>
            <div class="menu-item" onclick="showModal('notesModal')">ğŸ“ Global Notes</div>
            <div class="menu-item" onclick="showModal('timerModal')">â±ï¸ Session Timer</div>
        </div>
    </div>

    <div class="container">
        <div class="app-header no-print">
            <h1>ğŸ¯ WBCS Exam Preparation 2026 - Interactive Tracker</h1>
            <p class="subtitle">Complete Study Blueprint & Rescheduling Engine</p>
        </div>

        <div class="controls-bar no-print">
            <button class="btn btn-secondary" onclick="toggleDarkMode()">ğŸŒ™ Theme</button>
            <button class="btn btn-info" onclick="exportData()">ğŸ’¾ Backup</button>
            <button class="btn btn-warning" onclick="importData()">ğŸ“¥ Restore</button>
            <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ Print</button>
            <button class="btn btn-danger" onclick="secureReset()">ğŸ”„ Reset</button>
            <button class="btn btn-secondary" onclick="logoutUser()">ğŸ”’ Logout</button>
            <span id="userEmailDisplay" style="margin-left: auto; font-weight: bold; color: var(--primary);"></span>
        </div>

        <!-- Dashboard -->
        <div id="tab-overview" class="tab-content active">
            <div class="dashboard no-print">
                <div class="stats-card"><h3>Overall Progress</h3><div class="value" id="overallProgress">0%</div><div class="progress-bar-container"><div class="progress-bar" id="overallProgressBar"></div></div></div>
                <div class="stats-card"><h3>Study Streak</h3><div class="value" id="studyStreak">0</div></div>
                <div class="stats-card"><h3>Total Hours</h3><div class="value" id="totalHours">0.0h</div></div>
                <div class="stats-card"><h3>Days to Exam</h3><div class="value" id="daysRemaining">0</div></div>
            </div>
            
            <div class="summary-box">
                <h3>ğŸ“‹ Preparation Summary</h3>
                <p>Target Date: <strong>20 March 2026 (Preliminary)</strong></p>
                <p>Plan includes 16 full tests and comprehensive GS coverage.</p>
            </div>

            <h2>ğŸ“š Quick Subject Access</h2>
            <div id="subjectQuickCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;"></div>
        </div>

        <!-- Routines -->
        <div id="tab-weekday" class="tab-content"><h2>ğŸ“… Weekday Routine</h2><table id="weekdayTable"><thead><tr><th>Time</th><th>Activity</th><th>Details</th><th>Duration</th><th>âœ“</th></tr></thead><tbody id="weekdaySchedule"></tbody></table></div>
        <div id="tab-weekend" class="tab-content"><h2>ğŸŒ… Weekend Routine</h2><h3>Saturday</h3><table id="saturdayTable"><thead><tr><th>Time</th><th>Activity</th><th>Details</th><th>Duration</th><th>âœ“</th></tr></thead><tbody id="saturdaySchedule"></tbody></table><h3>Sunday</h3><table id="sundayTable"><thead><tr><th>Time</th><th>Activity</th><th>Details</th><th>Duration</th><th>âœ“</th></tr></thead><tbody id="sundaySchedule"></tbody></table></div>

        <!-- Dynamic Month Containers (Jan-Dec) -->
        <div id="tab-january" class="tab-content"><h2>ğŸ“† January 2026</h2><table class="month-table"><thead><tr><th width="15%">Date</th><th width="5%">Day</th><th width="20%">Morning</th><th width="20%">Evening</th><th width="15%">Test/Activity</th><th width="15%">Topic</th><th width="5%">Hrs</th><th width="5%">Note</th><th width="5%">âœ“</th></tr></thead><tbody id="januarySchedule"></tbody></table></div>
        <div id="tab-february" class="tab-content"><h2>ğŸ“† February 2026</h2><table class="month-table"><thead><tr><th>Date</th><th>Day</th><th>Morning</th><th>Evening</th><th>Test</th><th>Topic</th><th>Hrs</th><th>Note</th><th>âœ“</th></tr></thead><tbody id="februarySchedule"></tbody></table></div>
        <div id="tab-march" class="tab-content"><h2>ğŸ“† March 2026</h2><table class="month-table"><thead><tr><th>Date</th><th>Day</th><th>Morning</th><th>Evening</th><th>Test</th><th>Topic</th><th>Hrs</th><th>Note</th><th>âœ“</th></tr></thead><tbody id="marchSchedule"></tbody></table></div>
        <div id="tab-april" class="tab-content"><h2>ğŸ“† April 2026</h2><table class="month-table"><thead><tr><th>Date</th><th>Day</th><th>Morning</th><th>Evening</th><th>Test</th><th>Topic</th><th>Hrs</th><th>Note</th><th>âœ“</th></tr></thead><tbody id="aprilSchedule"></tbody></table></div>
        <div id="tab-may" class="tab-content"><h2>ğŸ“† May 2026</h2><table class="month-table"><thead><tr><th>Date</th><th>Day</th><th>Morning</th><th>Evening</th><th>Test</th><th>Topic</th><th>Hrs</th><th>Note</th><th>âœ“</th></tr></thead><tbody id="maySchedule"></tbody></table></div>
        <div id="tab-june" class="tab-content"><h2>ğŸ“† June 2026</h2><table class="month-table"><thead><tr><th>Date</th><th>Day</th><th>Morning</th><th>Evening</th><th>Test</th><th>Topic</th><th>Hrs</th><th>Note</th><th>âœ“</th></tr></thead><tbody id="juneSchedule"></tbody></table></div>
        <div id="tab-july" class="tab-content"><h2>ğŸ“† July 2026</h2><table class="month-table"><thead><tr><th>Date</th><th>Day</th><th>Morning</th><th>Evening</th><th>Test</th><th>Topic</th><th>Hrs</th><th>Note</th><th>âœ“</th></tr></thead><tbody id="julySchedule"></tbody></table></div>
        <div id="tab-august" class="tab-content"><h2>ğŸ“† August 2026</h2><table class="month-table"><thead><tr><th>Date</th><th>Day</th><th>Morning</th><th>Evening</th><th>Test</th><th>Topic</th><th>Hrs</th><th>Note</th><th>âœ“</th></tr></thead><tbody id="augustSchedule"></tbody></table></div>
        <div id="tab-september" class="tab-content"><h2>ğŸ“† September 2026</h2><table class="month-table"><thead><tr><th>Date</th><th>Day</th><th>Morning</th><th>Evening</th><th>Test</th><th>Topic</th><th>Hrs</th><th>Note</th><th>âœ“</th></tr></thead><tbody id="septemberSchedule"></tbody></table></div>
        <div id="tab-october" class="tab-content"><h2>ğŸ“† October 2026</h2><table class="month-table"><thead><tr><th>Date</th><th>Day</th><th>Morning</th><th>Evening</th><th>Test</th><th>Topic</th><th>Hrs</th><th>Note</th><th>âœ“</th></tr></thead><tbody id="octoberSchedule"></tbody></table></div>
        <div id="tab-november" class="tab-content"><h2>ğŸ“† November 2026</h2><table class="month-table"><thead><tr><th>Date</th><th>Day</th><th>Morning</th><th>Evening</th><th>Test</th><th>Topic</th><th>Hrs</th><th>Note</th><th>âœ“</th></tr></thead><tbody id="novemberSchedule"></tbody></table></div>
        <div id="tab-december" class="tab-content"><h2>ğŸ“† December 2026</h2><table class="month-table"><thead><tr><th>Date</th><th>Day</th><th>Morning</th><th>Evening</th><th>Test</th><th>Topic</th><th>Hrs</th><th>Note</th><th>âœ“</th></tr></thead><tbody id="decemberSchedule"></tbody></table></div>

        <!-- Subject View -->
        <div id="tab-subject-view" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="currentSubjectTitle">Subject Detail</h2>
                <button class="btn btn-danger" onclick="deleteCurrentSubject()">ğŸ—‘ï¸ Delete Subject</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th width="35%">Topic Title</th>
                        <th width="20%">Scheduled Date</th>
                        <th width="10%">Day</th>
                        <th width="15%">Category</th>
                        <th width="10%">Hrs</th>
                        <th width="5%">âœ“</th>
                        <th width="5%">Action</th>
                    </tr>
                </thead>
                <tbody id="subjectTopicTable"></tbody>
            </table>
            <button class="btn btn-success" onclick="addTopicToCurrentSubject()">â• Add Custom Topic Row</button>
        </div>

        <div id="tab-tests" class="tab-content"><h2>âœ… Test Performance</h2><table><thead><tr><th>Test #</th><th>Date</th><th>Type</th><th>MCQs</th><th>Focus</th><th>Target</th><th>Score</th><th>%</th><th>Status</th></tr></thead><tbody id="testScheduleTable"></tbody></table></div>
        <div id="tab-analytics" class="tab-content"><h2>ğŸ“ˆ Analytics</h2><div class="summary-box"><h3>Performance History</h3><div id="performanceChart" style="height: 300px; display: flex; align-items: flex-end; gap: 5px; padding: 20px; background: #f8f9fa;"></div></div><table id="subjectAnalyticsTable"><thead><tr><th>Subject</th><th>Sessions</th><th>Hours</th><th>Progress</th></tr></thead><tbody></tbody></table></div>
    </div>

    <!-- Modals -->
    <div id="inputModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modalTitle">Input</h3><span class="close" onclick="closeModal('inputModal')">&times;</span></div>
            <div class="modal-body" id="modalBody"></div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('inputModal')">Cancel</button>
                <button class="btn btn-primary" id="modalSubmit">Submit</button>
            </div>
        </div>
    </div>

    <div id="notesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>ğŸ“ Global Study Notes</h3><span class="close" onclick="closeModal('notesModal')">&times;</span></div>
            <textarea id="userNotes" style="width: 100%; height: 300px; padding: 15px; border-radius: 8px; border: 1px solid #ddd;"></textarea>
            <button class="btn btn-success" style="width: 100%; margin-top: 15px;" onclick="saveNotes()">ğŸ’¾ Save Global Notes</button>
        </div>
    </div>

    <div id="timerModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header"><h3>â±ï¸ Study Session Timer</h3><span class="close" onclick="closeModal('timerModal')">&times;</span></div>
            <div style="font-size: 64px; font-weight: bold; font-family: monospace; margin: 30px 0;" id="timerDisplay">00:00:00</div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-success" onclick="startTimer()">Start</button>
                <button class="btn btn-warning" onclick="pauseTimer()">Pause</button>
                <button class="btn btn-danger" onclick="resetTimer()">Reset</button>
                <button class="btn btn-primary" onclick="saveStudySession()">Save Session</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAThe1_F61AYEZtXl6ISwNkd6D0XMSgg3k",
            authDomain: "wbcs-progress-tracker-30fa6.firebaseapp.com",
            projectId: "wbcs-progress-tracker-30fa6",
            storageBucket: "wbcs-progress-tracker-30fa6.firebasestorage.app",
            messagingSenderId: "9259146",
            appId: "1:9259146:web:7f5a5f23f655ea1bf40573"
        };
        
        let firebaseApp, auth, db, currentUser = null;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (e) { console.error("Firebase init failed", e); }

        // Master Blueprint
        const janBlueprint = [
            { date: "1 Jan", morning: "Polity: Constitution Basics, Preamble", evening: "Polity MCQs (50)", test: "New Year Holiday", topics: "Polity", hours: 3.75 },
            { date: "2 Jan", morning: "History: 1857 Revolt - Causes & Course", evening: "1857 MCQs", test: "-", topics: "History", hours: 3.75 },
            { date: "3 Jan", morning: "Geography: Earth, Solar System", evening: "Geography MCQs", test: "Weekend Study", topics: "Geography", hours: 8.5 },
            { date: "4 Jan", morning: "Economy: National Income Concepts", evening: "Economy MCQs", test: "TEST 1: 50 MCQs", topics: "Economy", hours: 8 },
            { date: "5 Jan", morning: "Polity: Fundamental Rights (Art 12-35)", evening: "FR MCQs + Case laws", test: "Rescheduled", topics: "Polity", hours: 3.75 },
            { date: "6 Jan", morning: "History: Social Reform Movements", evening: "Reformers MCQs", test: "-", topics: "History", hours: 3.75 },
            { date: "7 Jan", morning: "Geography: Indian Physiography", evening: "Mountain ranges MCQs", test: "-", topics: "Geography", hours: 3.75 },
            { date: "8 Jan", morning: "Economy: Money, Banking, RBI Functions", evening: "Banking MCQs", test: "Rescheduled", topics: "Economy", hours: 3.75 },
            { date: "9 Jan", morning: "Science: Physics - Motion, Work, Energy", evening: "Physics MCQs", test: "-", topics: "Science", hours: 3.75 },
            { date: "10 Jan", morning: "Science: Heat, Light, Sound waves", evening: "Science comp MCQs", test: "Rescheduled", topics: "Science", hours: 8.5 },
            { date: "11 Jan", morning: "Current Affairs: Dec 2025 Wrap-up", evening: "CA MCQs", test: "Rescheduled", topics: "Current Affairs", hours: 8 },
            { date: "12 Jan", morning: "Polity: DPSP (Art 36-51) & FD", evening: "Directives MCQs", test: "Rescheduled", topics: "Polity", hours: 3.75 },
            { date: "13 Jan", morning: "History: INC Formation, Moderate Phase", evening: "Early Congress MCQs", test: "-", topics: "History", hours: 3.75 },
            { date: "14 Jan", morning: "Geography: Indian Drainage - Rivers", evening: "Rivers Map Marking", test: "Rescheduled", topics: "Geography", hours: 3.75 },
            { date: "15 Jan", morning: "Economy: Fiscal Policy, Budget", evening: "Budget Terms MCQs", test: "Rescheduled", topics: "Economy", hours: 3.75 },
            { date: "16 Jan", morning: "Science: Atomic Structure", evening: "Chemistry Elements", test: "Rescheduled", topics: "Science", hours: 3.75 },
            { date: "17 Jan", morning: "History: National Movement Timeline", evening: "Chronology Practice", test: "Rescheduled", topics: "History", hours: 8.5 },
            { date: "18 Jan", morning: "Polity: Union Executive", evening: "Executive MCQs", test: "Rescheduled", topics: "Polity", hours: 8 },
            { date: "19 Jan", morning: "Polity: Parliament Basics", evening: "Legislature MCQs", test: "Rescheduled", topics: "Polity", hours: 3.75 },
            { date: "20 Jan", morning: "History: Partition of Bengal 1905", evening: "Swadeshi Movement MCQs", test: "Rescheduled", topics: "History", hours: 3.75 },
            { date: "21 Jan", morning: "Geography: Climate & Monsoon", evening: "Monsoon patterns MCQs", test: "Rescheduled", topics: "Geography", hours: 3.75 },
            { date: "22 Jan", morning: "Economy: Agriculture Sector", evening: "Green Revolution MCQs", test: "Rescheduled", topics: "Economy", hours: 3.75 },
            { date: "23 Jan", morning: "Science: Acids, Bases, Salts", evening: "pH scale reactions", test: "Rescheduled", topics: "Science", hours: 3.75 },
            { date: "24 Jan", morning: "Geography: Indian Map Comprehensive", evening: "Map locations drill", test: "Rescheduled", topics: "Geography", hours: 8.5 },
            { date: "25 Jan", morning: "Economy: Full Economy Marathon", evening: "Economy comprehensive MCQs", test: "Rescheduled", topics: "Economy", hours: 8 },
            { date: "26 Jan", morning: "Republic Day: Constitution Deep Study", evening: "Polity 100 MCQs marathon", test: "-", topics: "Polity", hours: 3.75 },
            { date: "27 Jan", morning: "History: Home Rule, Lucknow Pact", evening: "1916-1919 MCQs", test: "-", topics: "History", hours: 3.75 },
            { date: "28 Jan", morning: "Geography: Soils & Vegetation", evening: "Forest types MCQs", test: "-", topics: "Geography", hours: 3.75 },
            { date: "29 Jan", morning: "Economy: Industry & MSMEs", evening: "Manufacturing policies MCQs", test: "-", topics: "Economy", hours: 3.75 },
            { date: "30 Jan", morning: "Science: Biology - Cell & Tissues", evening: "Cell structures MCQs", test: "-", topics: "Science", hours: 3.75 },
            { date: "31 Jan", morning: "Polity: Full Revision Marathon", evening: "Polity final drill MCQs", test: "TEST 7: 75 MCQs", topics: "Polity", hours: 8.5 }
        ];

        const febBlueprint = [
            { date: "1 Feb", morning: "Environment: Ecology, Biodiversity", evening: "Environment comp MCQs", test: "TEST 8: 75 MCQs", topics: "Environment", hours: 8 },
            { date: "2 Feb", morning: "Polity: Judiciary - SC & High Courts", evening: "Judicial cases MCQs", test: "-", topics: "Polity", hours: 3.75 },
            { date: "3 Feb", morning: "History: Non-Cooperation Movement", evening: "Gandhi era drill MCQs", test: "-", topics: "History", hours: 3.75 },
            { date: "4 Feb", morning: "Geography: Minerals & Energy", evening: "Resource maps MCQs", test: "-", topics: "Geography", hours: 3.75 },
            { date: "5 Feb", morning: "Economy: Planning & NITI Aayog", evening: "Plan objectives MCQs", test: "-", topics: "Economy", hours: 3.75 },
            { date: "6 Feb", morning: "Science: Human Body Systems", evening: "Human diseases MCQs", test: "-", topics: "Science", hours: 3.75 },
            { date: "7 Feb", morning: "History: 1857-1947 Final Chronology", evening: "Timeline marathon drill", test: "TEST 9: 75 MCQs", topics: "History", hours: 8.5 },
            { date: "8 Feb", morning: "Polity + Geography Integration", evening: "Combined mock MCQs", test: "TEST 10: 75 MCQs", topics: "Polity", hours: 8 },
            { date: "9 Feb", morning: "Polity: Local Government (73rd/74th)", evening: "Panchayat MCQs", test: "-", topics: "Polity", hours: 3.75 },
            { date: "10 Feb", morning: "History: Civil Disobedience", evening: "Dandi March MCQs", test: "-", topics: "History", hours: 3.75 },
            { date: "11 Feb", morning: "Geography WB: Physical Features", evening: "WB district maps MCQs", test: "-", topics: "Geography", hours: 3.75 },
            { date: "12 Feb", morning: "Economy: Govt Schemes Review", evening: "Central/State welfare MCQs", test: "-", topics: "Economy", hours: 3.75 },
            { date: "13 Feb", morning: "Science: Environment Pollution", evening: "Climate treaties MCQs", test: "-", topics: "Science", hours: 3.75 },
            { date: "14 Feb", morning: "Mixed Revision: All Weak Areas", evening: "Problem topic intensive", test: "TEST 11: 75 MCQs", topics: "General", hours: 8.5 },
            { date: "15 Feb", morning: "Full Science Revision Marathon", evening: "Science comprehensive MCQs", test: "TEST 12: 100 MCQs", topics: "Science", hours: 8 },
            { date: "16 Feb", morning: "Polity: Emergency Provisions", evening: "Emergency history MCQs", test: "-", topics: "Polity", hours: 3.75 },
            { date: "17 Feb", morning: "History: Quit India & INA", evening: "Final phase leaders MCQs", test: "-", topics: "History", hours: 3.75 },
            { date: "18 Feb", morning: "Geography WB: Economy & Industry", evening: "WB agriculture MCQs", test: "-", topics: "Geography", hours: 3.75 },
            { date: "19 Feb", morning: "Reasoning: Logical Patterns", evening: "Reasoning speed practice", test: "-", topics: "General", hours: 3.75 },
            { date: "20 Feb", morning: "Quant: Perc, Ratio, Shortcuts", evening: "Speed math MCQs", test: "-", topics: "General", hours: 3.75 },
            { date: "21 Feb", morning: "Complete GS Syllabus Revision", evening: "Full mock test simulation", test: "TEST 13: 100 MCQs", topics: "General", hours: 8.5 },
            { date: "22 Feb", morning: "Current Affairs: Jan-Feb 2026", evening: "Recent events mock MCQs", test: "TEST 14: 100 MCQs", topics: "Current Affairs", hours: 8 },
            { date: "23 Feb", morning: "English Basics & Vocabulary", evening: "English comp MCQs", test: "-", topics: "General", hours: 3 },
            { date: "24 Feb", morning: "Formulas & Facts Final Look", evening: "Quick recall MCQs", test: "-", topics: "General", hours: 2.5 },
            { date: "25 Feb", morning: "Timeline & Events Final Review", evening: "Chronology final check", test: "-", topics: "History", hours: 2.5 },
            { date: "26 Feb", morning: "Maps & Diagrams Final Review", evening: "Visual memory drill", test: "-", topics: "Geography", hours: 2.5 },
            { date: "27 Feb", morning: "Error Log Final Revision", evening: "Mistake pattern analysis", test: "-", topics: "General", hours: 2 },
            { date: "28 Feb", morning: "Rest & Mental Relaxation", evening: "Final simulation mock", test: "FULL MOCK: 200 MCQs", topics: "General", hours: 3 }
        ];

        const marBlueprint = [
            { date: "1 Mar", morning: "Makeup: Fundamental Rights (Missed Jan 5)", evening: "FR Case Laws", test: "Makeup Session", topics: "Polity", hours: 4 },
            { date: "2 Mar", morning: "Makeup: Money & Banking (Missed Jan 8)", evening: "RBI MCQs", test: "Makeup Session", topics: "Economy", hours: 4 },
            { date: "3 Mar", morning: "Makeup: Heat, Light, Sound (Missed Jan 10)", evening: "Waves MCQs", test: "Makeup Session", topics: "Science", hours: 4 },
            { date: "4 Mar", morning: "Makeup: Indian Drainage (Missed Jan 14)", evening: "River Maps", test: "Makeup Session", topics: "Geography", hours: 4 },
            { date: "5 Mar", morning: "Makeup: Fiscal Policy & Budget (Missed Jan 15)", evening: "Taxation MCQs", test: "Makeup Session", topics: "Economy", hours: 4 },
            { date: "6 Mar", morning: "Makeup: Atomic Structure (Missed Jan 16)", evening: "Chem MCQs", test: "Makeup Session", topics: "Science", hours: 4 },
            { date: "7 Mar", morning: "Makeup: National Movement Timeline (Missed Jan 17)", evening: "Chronology Drills", test: "Makeup Session", topics: "History", hours: 4 },
            { date: "8 Mar", morning: "Makeup: Union Executive (Missed Jan 18)", evening: "President/PM MCQs", test: "Makeup Session", topics: "Polity", hours: 4 },
            { date: "9 Mar", morning: "Makeup: Parliament (Missed Jan 19)", evening: "Bills/Procedures", test: "Makeup Session", topics: "Polity", hours: 4 },
            { date: "10 Mar", morning: "Makeup: Partition of Bengal (Missed Jan 20)", evening: "Swadeshi MCQs", test: "Makeup Session", topics: "History", hours: 4 },
            { date: "11 Mar", morning: "Makeup: Climate & Monsoon (Missed Jan 21)", evening: "Weather Maps", test: "Makeup Session", topics: "Geography", hours: 4 },
            { date: "12 Mar", morning: "Makeup: Agriculture (Missed Jan 22)", evening: "Agri Schemes", test: "Makeup Session", topics: "Economy", hours: 4 },
            { date: "13 Mar", morning: "Makeup: Acids, Bases, Salts (Missed Jan 23)", evening: "Chem Practice", test: "Makeup Session", topics: "Science", hours: 4 },
            { date: "14 Mar", morning: "Makeup: Map Comprehensive (Missed Jan 24)", evening: "Location Drills", test: "Makeup Session", topics: "Geography", hours: 4 },
            { date: "15 Mar", morning: "Makeup: Economy Marathon (Missed Jan 25)", evening: "Economy Final MCQs", test: "Makeup Session", topics: "Economy", hours: 6 },
            { date: "16 Mar", morning: "Current Affairs: 1-15 March 2026", evening: "CA MCQs", test: "-", topics: "Current Affairs", hours: 4 },
            { date: "17 Mar", morning: "Full Revision: Weak Areas", evening: "Rapid Fire MCQs", test: "-", topics: "General", hours: 6 },
            { date: "18 Mar", morning: "Final Simulation Mock", evening: "Mistake Log Review", test: "TEST 15: FINAL SIM", topics: "General", hours: 8 },
            { date: "19 Mar", morning: "Mental Prep & Exam Instructions", evening: "Rest", test: "Relaxation Day", topics: "General", hours: 2 },
            { date: "20 Mar", morning: "WBCS PRELIMINARY EXAM 2026", evening: "Self Reflection", test: "D-DAY", topics: "General", hours: 10 }
        ];

        let appState = {
            completedTasks: {}, testScores: {}, studyHours: {}, customDates: {}, dailyNotes: {},
            modifiedTasks: {}, // Track edits to blueprint tasks
            deletedTasks: [],  // Track deleted blueprint IDs
            subjects: ["Polity", "History", "Geography", "Economy", "Science", "Environment", "Current Affairs"],
            customTasks: [], 
            darkMode: false, 
            notes: "", 
            activeSubject: null
        };

        function toggleSidebar() { 
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }
        function toggleSubmenu(id) { document.getElementById(id).classList.toggle('active'); }

        function showModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function openInputModal(title, callback, fields) {
            const modal = document.getElementById('inputModal');
            document.getElementById('modalTitle').textContent = title;
            const body = document.getElementById('modalBody');
            body.innerHTML = fields.map(f => `
                <label style="display:block;margin-bottom:5px;font-weight:600;">${f.label}</label>
                ${f.type==='textarea' ? `<textarea id="inp-${f.id}" placeholder="${f.placeholder}"></textarea>` : `<input type="${f.type}" id="inp-${f.id}" placeholder="${f.placeholder}" value="${f.value||''}">`}
            `).join('');
            showModal('inputModal');
            document.getElementById('modalSubmit').onclick = () => {
                const values = {};
                fields.forEach(f => values[f.id] = document.getElementById(`inp-${f.id}`).value);
                callback(values);
                closeModal('inputModal');
            };
        }

        // European Date Helper
        function formatEuro(dateStr) { if(!dateStr) return ""; const [y,m,d] = dateStr.split('-'); return `${d}/${m}/${y}`; }
        function getDayOfWeek(dateStr) { const d = new Date(dateStr); return d.toLocaleDateString('en-US', {weekday:'short'}); }

        function getMasterSchedule() {
            let master = [];
            
            // 1. Process Blueprint
            const rawBlueprint = [
                ...janBlueprint.map((t, i) => ({...t, id: `jan-${i}`})),
                ...febBlueprint.map((t, i) => ({...t, id: `feb-${i}`})),
                ...marBlueprint.map((t, i) => ({...t, id: `mar-${i}`}))
            ];

            rawBlueprint.forEach(t => {
                // Skip if deleted
                if (appState.deletedTasks.includes(t.id)) return;
                
                // Apply modifications
                let task = {...t, origin: 'blueprint'};
                if (appState.modifiedTasks[t.id]) {
                    task = {...task, ...appState.modifiedTasks[t.id]};
                }
                master.push(task);
            });

            // 2. Add Custom Tasks
            appState.customTasks.forEach(t => master.push({...t, origin: 'custom'}));

            // 3. Normalize dates and sort
            return master.map(t => {
                let d = appState.customDates[t.id] || t.date;
                // Convert "1 Jan" to "2026-01-01" if needed
                if(!d.includes('-')) {
                    const parts = d.split(' ');
                    const monthMap = {Jan:'01', Feb:'02', Mar:'03'};
                    const day = parts[0].padStart(2, '0');
                    const month = monthMap[parts[1]] || '01';
                    d = `2026-${month}-${day}`;
                }
                return {...t, currentFullDate: d};
            }).sort((a, b) => a.currentFullDate.localeCompare(b.currentFullDate));
        }

        function addTask(monthHint) {
            const defaultDate = `2026-${monthHint}-01`;
            openInputModal("Add New Task", (v) => {
                const newTask = {
                    id: 'task-' + Date.now(),
                    morning: v.morning,
                    evening: v.evening,
                    test: v.test,
                    topics: v.topics,
                    hours: parseFloat(v.hours) || 2,
                    date: v.date
                };
                appState.customTasks.push(newTask);
                saveState();
                renderAll();
            }, [
                {id:'morning', label:'Morning/Theory', type:'text', placeholder:'Topic name...'},
                {id:'evening', label:'Evening/Practice', type:'text', placeholder:'Practice details...'},
                {id:'test', label:'Test/Activity', type:'text', placeholder:'e.g. Test 1'},
                {id:'topics', label:'Subject (Categorization)', type:'text', placeholder:'e.g. History'},
                {id:'hours', label:'Hours', type:'number', value: 3.75},
                {id:'date', label:'Date', type:'date', value: defaultDate}
            ]);
        }

        function editTask(id) {
            const master = getMasterSchedule();
            const task = master.find(t => t.id === id);
            if (!task) return;

            openInputModal("Edit Task", (v) => {
                const updates = {
                    morning: v.morning,
                    evening: v.evening,
                    test: v.test,
                    topics: v.topics,
                    hours: parseFloat(v.hours) || 0
                };
                
                if (task.origin === 'blueprint') {
                    appState.modifiedTasks[id] = updates;
                } else {
                    const idx = appState.customTasks.findIndex(t => t.id === id);
                    appState.customTasks[idx] = {...appState.customTasks[idx], ...updates};
                }
                
                appState.customDates[id] = v.date;
                saveState();
                renderAll();
                if (appState.activeSubject) viewSubject(appState.activeSubject);
            }, [
                {id:'morning', label:'Morning/Theory', type:'text', value: task.morning},
                {id:'evening', label:'Evening/Practice', type:'text', value: task.evening},
                {id:'test', label:'Test/Activity', type:'text', value: task.test},
                {id:'topics', label:'Subject', type:'text', value: task.topics},
                {id:'hours', label:'Hours', type:'number', value: task.hours},
                {id:'date', label:'Date', type:'date', value: task.currentFullDate}
            ]);
        }

        function deleteTask(id) {
            if (!confirm("Are you sure you want to remove this task?")) return;
            
            const task = getMasterSchedule().find(t => t.id === id);
            if (task.origin === 'blueprint') {
                appState.deletedTasks.push(id);
            } else {
                appState.customTasks = appState.customTasks.filter(t => t.id !== id);
            }
            
            saveState();
            renderAll();
            if (appState.activeSubject) viewSubject(appState.activeSubject);
        }

        function renderAll() {
            const master = getMasterSchedule();
            const months = ["january","february","march","april","may","june","july","august","september","october","november","december"];
            const menu = document.getElementById('monthSubmenu'); menu.innerHTML = '';
            
            months.forEach((m, idx) => {
                const mNum = String(idx + 1).padStart(2,'0');
                const filtered = master.filter(t => t.currentFullDate.split('-')[1] === mNum);
                const container = document.getElementById(`${m}Schedule`);
                if(container) {
                    if(filtered.length > 0) {
                        menu.innerHTML += `<div class="submenu-item" onclick="switchTab('${m}')">${m.charAt(0).toUpperCase()+m.slice(1)} 2026</div>`;
                        container.innerHTML = filtered.map(t => `
                            <tr class="${appState.completedTasks[t.id]?'completed-row':''}">
                                <td><div style="font-size:10px;color:var(--primary);">${formatEuro(t.currentFullDate)}</div><input type="date" class="date-edit-input" value="${t.currentFullDate}" onchange="updateDate('${t.id}', this.value)"></td>
                                <td>${getDayOfWeek(t.currentFullDate)}</td>
                                <td onclick="editTask('${t.id}')" style="cursor:pointer">${t.morning || '-'}</td>
                                <td onclick="editTask('${t.id}')" style="cursor:pointer">${t.evening || '-'}</td>
                                <td onclick="editTask('${t.id}')" style="cursor:pointer">${t.test || '-'}</td>
                                <td onclick="editTask('${t.id}')" style="cursor:pointer">${t.topics}</td>
                                <td>${t.hours || 0}</td>
                                <td style="display:flex;gap:5px;">
                                    <button class="btn btn-info" style="padding:4px 8px" onclick="openDailyNote('${t.id}')">âœï¸</button>
                                    <button class="btn btn-danger" style="padding:4px 8px" onclick="deleteTask('${t.id}')">ğŸ—‘ï¸</button>
                                </td>
                                <td><input type="checkbox" class="task-checkbox" ${appState.completedTasks[t.id]?'checked':''} onchange="toggleTask('${t.id}', this.checked)"></td>
                            </tr>
                        `).join('') + `<tr><td colspan="9"><button class="btn btn-success" style="width:100%" onclick="addTask('${mNum}')">â• Add Topic to ${m.charAt(0).toUpperCase()+m.slice(1)}</button></td></tr>`;
                    } else { container.innerHTML = '<tr><td colspan="9" style="text-align:center;opacity:0.5;">No tasks scheduled for this month.</td></tr>'; }
                }
            });
            updateSubjectSidebar();
            updateDashboard();
            updateAnalytics();
        }

        function updateDate(id, val) { appState.customDates[id] = val; saveState(); renderAll(); }
        function toggleTask(id, val) { appState.completedTasks[id] = val; saveState(); renderAll(); }

        function updateSubjectSidebar() {
            const list = document.getElementById('subjectList');
            const quick = document.getElementById('subjectQuickCards');
            list.innerHTML = appState.subjects.map(s => `<div class="submenu-item" onclick="viewSubject('${s}')">ğŸ“š ${s}</div>`).join('');
            quick.innerHTML = appState.subjects.map(s => `<div class="stats-card" style="cursor:pointer;" onclick="viewSubject('${s}')"><h3>${s}</h3><div class="value" style="font-size:14px;">View Topics â†’</div></div>`).join('');
        }

        function createNewSubject() {
            openInputModal("Create New Subject", (v) => {
                if(v.name && !appState.subjects.includes(v.name)) {
                    appState.subjects.push(v.name); saveState(); renderAll(); viewSubject(v.name);
                }
            }, [{id:'name', label:'Subject Name', type:'text', placeholder:'e.g. Physics'}]);
        }

        function viewSubject(name) {
            appState.activeSubject = name;
            document.getElementById('currentSubjectTitle').textContent = `ğŸ“š Subject: ${name}`;
            const master = getMasterSchedule();
            const topics = master.filter(t => t.topics.toLowerCase().includes(name.toLowerCase()));
            const tbody = document.getElementById('subjectTopicTable');
            tbody.innerHTML = topics.map(t => `
                <tr class="${appState.completedTasks[t.id]?'completed-row':''}">
                    <td onclick="editTask('${t.id}')" style="cursor:pointer"><strong>${t.morning || t.title || 'Untitled'}</strong><br><small style="opacity:0.6">${t.evening || ''}</small></td>
                    <td><input type="date" class="date-edit-input" value="${t.currentFullDate}" onchange="updateDate('${t.id}', this.value)"></td>
                    <td>${getDayOfWeek(t.currentFullDate)}</td>
                    <td>${t.origin === 'blueprint' ? 'System' : 'User'}</td>
                    <td>${t.hours || 0}</td>
                    <td><input type="checkbox" class="task-checkbox" ${appState.completedTasks[t.id]?'checked':''} onchange="toggleTask('${t.id}', this.checked)"></td>
                    <td>
                        <button class="btn btn-danger" style="padding:4px 8px" onclick="deleteTask('${t.id}')">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('');
            switchTab('subject-view');
        }

        function addTopicToCurrentSubject() {
            openInputModal("Add Topic to " + appState.activeSubject, (v) => {
                appState.customTasks.push({
                    id: 'task-' + Date.now(),
                    morning: v.title,
                    evening: v.evening || '',
                    test: v.test || '-',
                    topics: appState.activeSubject,
                    hours: parseFloat(v.hours) || 2,
                    date: v.date
                });
                saveState(); 
                viewSubject(appState.activeSubject); 
                renderAll();
            }, [
                {id:'title', label:'Topic Title (Morning)', type:'text', placeholder:'Enter topic name...'},
                {id:'evening', label:'Practice (Evening)', type:'text', placeholder:'Practice details...'},
                {id:'test', label:'Test/Activity', type:'text', placeholder:'-'},
                {id:'date', label:'Target Date', type:'date', value: new Date().toISOString().split('T')[0]},
                {id:'hours', label:'Study Hours', type:'number', value: 2}
            ]);
        }

        function deleteCustom(id) { if(confirm("Delete this custom topic?")) { appState.customTasks = appState.customTasks.filter(t => t.id !== id); saveState(); viewSubject(appState.activeSubject); renderAll(); } }
        function deleteCurrentSubject() { if(confirm(`Delete entire subject "${appState.activeSubject}"?`)) { appState.subjects = appState.subjects.filter(s => s !== appState.activeSubject); saveState(); switchTab('overview'); renderAll(); } }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.menu-item, .submenu-item').forEach(m => m.classList.remove('active'));
            const target = document.getElementById(`tab-${id}`);
            if(target) target.classList.add('active');
            toggleSidebar();
        }

        function updateDashboard() {
            const master = getMasterSchedule();
            const done = Object.keys(appState.completedTasks).filter(k => appState.completedTasks[k]).length;
            const perc = master.length ? Math.round((done / master.length)*100) : 0;
            
            const overallP = document.getElementById('overallProgress');
            if (overallP) overallP.textContent = perc + '%';
            
            const overallBar = document.getElementById('overallProgressBar');
            if (overallBar) overallBar.style.width = perc + '%';
            
            // Exam is March 20, 2026
            const exam = new Date('2026-03-20');
            const today = new Date();
            const diff = Math.ceil((exam - today) / (1000 * 60 * 60 * 24));
            const daysRem = document.getElementById('daysRemaining');
            if (daysRem) daysRem.textContent = diff > 0 ? diff : 0;

            let hrs = 0;
            master.forEach(t => { 
                if(appState.completedTasks[t.id]) hrs += (t.hours || 0); 
            });
            const totalH = document.getElementById('totalHours');
            if (totalH) totalH.textContent = hrs.toFixed(1) + 'h';
            
            // Streak calculation
            const streakVal = document.getElementById('studyStreak');
            if (streakVal) streakVal.textContent = calculateStreak();
        }

        function calculateStreak() {
            const master = getMasterSchedule();
            const completedDates = new Set();
            master.forEach(t => {
                if (appState.completedTasks[t.id]) {
                    completedDates.add(t.currentFullDate);
                }
            });

            let streak = 0;
            let checkDate = new Date();
            checkDate.setHours(0,0,0,0);

            // Start from today or yesterday if today isn't done yet
            const todayStr = checkDate.toISOString().split('T')[0];
            if (!completedDates.has(todayStr)) {
                checkDate.setDate(checkDate.getDate() - 1);
            }

            while (true) {
                const dateStr = checkDate.toISOString().split('T')[0];
                if (completedDates.has(dateStr)) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
                if (streak > 365) break; // safety
            }
            return streak;
        }

        function updateAnalytics() {
            const tbody = document.querySelector('#subjectAnalyticsTable tbody');
            const master = getMasterSchedule();
            tbody.innerHTML = appState.subjects.map(s => {
                const subTasks = master.filter(t => t.topics.toLowerCase().includes(s.toLowerCase()));
                const done = subTasks.filter(t => appState.completedTasks[t.id]).length;
                const perc = subTasks.length ? Math.round((done/subTasks.length)*100) : 0;
                return `<tr><td>${s}</td><td>${done}/${subTasks.length}</td><td>-</td><td>${perc}%</td></tr>`;
            }).join('');
        }

        function openDailyNote(id) {
            const old = appState.dailyNotes[id] || "";
            openInputModal("Day Note", (v) => { appState.dailyNotes[id] = v.note; saveState(); }, [{id:'note', label:'Note', type:'textarea', value:old}]);
        }

        function saveNotes() { appState.notes = document.getElementById('userNotes').value; saveState(); alert("Global notes saved!"); }
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); appState.darkMode = document.body.classList.contains('dark-mode'); saveState(); }
        
        function saveState() {
            localStorage.setItem('wbcsTrackerState', JSON.stringify(appState));
            if(currentUser && db) db.collection('users').doc(currentUser.uid).set({appState}, {merge:true});
        }

        function secureReset() { if(confirm("Reset all data?")) { localStorage.removeItem('wbcsTrackerState'); location.reload(); } }
        function logoutUser() { auth.signOut().then(() => location.reload()); }

        window.onload = () => {
            const saved = localStorage.getItem('wbcsTrackerState');
            if(saved) appState = {...appState, ...JSON.parse(saved)};
            if(appState.darkMode) document.body.classList.add('dark-mode');
            document.getElementById('userNotes').value = appState.notes || "";
            
            auth.onAuthStateChanged(user => {
                if(user) {
                    currentUser = user; document.getElementById('userEmailDisplay').textContent = "ğŸ‘¤ " + user.email;
                    db.collection('users').doc(user.uid).get().then(doc => { if(doc.exists) { appState = {...appState, ...doc.data().appState}; renderAll(); } });
                } else { renderAll(); }
            });
        };
    </script>
</body>
</html>
