<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBCS 2026 - Interactive Prep Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #667eea;
            --primary-2: #8b5cf6;
            --primary-dark: #4c1d95;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;

            --dark-bg: #070a16;
            --dark-card: rgba(22, 33, 62, 0.72);

            --card: rgba(255, 255, 255, 0.82);
            --card-border: rgba(255, 255, 255, 0.55);
            --shadow: 0 18px 45px rgba(2, 6, 23, 0.18);
            --shadow-strong: 0 25px 80px rgba(2, 6, 23, 0.38);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body { height: 100%; }

        body {
            background:
                radial-gradient(1000px 600px at 10% 10%, rgba(102,126,234,0.35), transparent 60%),
                radial-gradient(1000px 700px at 90% 20%, rgba(139,92,246,0.35), transparent 55%),
                radial-gradient(900px 700px at 40% 95%, rgba(34,197,94,0.18), transparent 55%),
                linear-gradient(180deg, #f8fafc, #eef2ff);
            color: #0f172a;
        }

        /* Smooth scroll + better selection */
        ::selection { background: rgba(102,126,234,0.25); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.35); border-radius: 999px; border: 2px solid rgba(255,255,255,0.6); }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.35); }

        .glass {
            background: var(--card);
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        .glass-strong {
            background: rgba(255,255,255,0.78);
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: var(--shadow-strong);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
        }

        .gradient-text {
            background: linear-gradient(90deg, var(--primary), var(--primary-2));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .soft-ring {
            box-shadow:
                0 0 0 1px rgba(99,102,241,0.18),
                0 12px 38px rgba(2, 6, 23, 0.14);
        }

        .loader {
            border: 4px solid rgba(255,255,255,0.55);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            animation: spin 0.9s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 14px;
            color: white;
            font-weight: 700;
            z-index: 9999;
            animation: toastIn 0.25s ease;
            box-shadow: 0 18px 40px rgba(2, 6, 23, 0.25);
            border: 1px solid rgba(255,255,255,0.25);
            backdrop-filter: blur(10px);
        }
        .toast.success { background: linear-gradient(135deg, rgba(34,197,94,0.95), rgba(16,185,129,0.95)); }
        .toast.error { background: linear-gradient(135deg, rgba(239,68,68,0.95), rgba(244,63,94,0.95)); }
        .toast.info { background: linear-gradient(135deg, rgba(99,102,241,0.95), rgba(139,92,246,0.95)); }
        @keyframes toastIn { from { transform: translateY(8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .dark-mode {
            background:
                radial-gradient(1000px 600px at 10% 10%, rgba(102,126,234,0.20), transparent 60%),
                radial-gradient(1000px 700px at 90% 20%, rgba(139,92,246,0.20), transparent 55%),
                radial-gradient(900px 700px at 40% 95%, rgba(34,197,94,0.10), transparent 55%),
                linear-gradient(180deg, #060815, #0b1227) !important;
            color: #e5e7eb !important;
        }

        .dark-mode .glass, .dark-mode .glass-strong {
            background: rgba(17, 24, 39, 0.60) !important;
            border-color: rgba(255,255,255,0.10) !important;
            box-shadow: 0 22px 70px rgba(0,0,0,0.45) !important;
        }

        .dark-mode .bg-white { background: rgba(17, 24, 39, 0.58) !important; }
        .dark-mode input, .dark-mode textarea, .dark-mode select {
            background: rgba(2, 6, 23, 0.45) !important;
            color: white !important;
            border-color: rgba(255,255,255,0.15) !important;
        }
        .dark-mode table { background: rgba(17, 24, 39, 0.55) !important; }
        .dark-mode td { border-color: rgba(255,255,255,0.08) !important; }

        /* Sidebar shape (more rectangular, slight rounding) */
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
            overflow: hidden;
        }
        .sidebar.active { transform: translateX(0); }

        /* Sidebar item containers (avoid text hugging curved edges) */
        #monthMenu, #subjectMenu {
            margin: 0 10px 12px;
            padding: 6px 0;
            border-radius: 14px;
            overflow: visible;
        }

        /* Sidebar items: slightly rounded rectangles + better text fit */
        .sidebar nav .menu-item {
            border-radius: 14px;
            margin: 6px 10px;
            padding: 12px 14px; /* ensure text doesn't touch edges */
            line-height: 1.25;
            white-space: normal;
            word-break: break-word;
            overflow: hidden;
        }

        /* Sidebar section headers (the toggle rows for month/subject) */
        .sidebar-section-toggle {
            margin: 6px 10px;
            padding: 12px 14px;
            border-radius: 14px;
            line-height: 1.25;
        }

        /* Sidebar submenu items (month list + subjects list + add subject) */
        .sidebar-subitem {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            margin: 6px 8px;
            line-height: 1.25;
            white-space: normal;
            word-break: break-word;
            overflow: hidden;
        }

        .overlay { display: none; }
        .overlay.active { display: block; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.25s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

        /* Completed styling (keep strike-through, but background is handled by date-highlights) */
        .completed-row { background: transparent !important; }
        .dark-mode .completed-row { background: transparent !important; }
        .completed-row td { text-decoration: line-through; opacity: 0.75; }

        /* Date-based row highlights (Monthly + Subject views)
           - Today: light green
           - Tomorrow: light yellow
           - Past & pending: light red
           - Past & completed: light blue
           - Otherwise: keep default/white
        */
        .row-today { background: rgba(34, 197, 94, 0.14) !important; }
        .row-tomorrow { background: rgba(245, 158, 11, 0.18) !important; }
        .row-past-missed { background: rgba(239, 68, 68, 0.12) !important; }
        .row-past-done { background: rgba(59, 130, 246, 0.12) !important; }

        .dark-mode .row-today { background: rgba(34, 197, 94, 0.18) !important; }
        .dark-mode .row-tomorrow { background: rgba(245, 158, 11, 0.16) !important; }
        .dark-mode .row-past-missed { background: rgba(239, 68, 68, 0.16) !important; }
        .dark-mode .row-past-done { background: rgba(59, 130, 246, 0.16) !important; }

        .progress-bar { transition: width 0.5s ease; }

        .table-row-hover:hover {
            background: rgba(99, 102, 241, 0.06);
            animation: microBounce 360ms cubic-bezier(.34, 1.56, .64, 1);
            transform-origin: center;
        }

        .date-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 12px;
            background: rgba(99,102,241,0.10);
            border: 1px solid rgba(99,102,241,0.18);
            color: rgb(79, 70, 229);
            font-weight: 700;
            font-size: 12px;
        }
        .dark-mode .date-chip {
            background: rgba(99,102,241,0.14);
            border-color: rgba(99,102,241,0.22);
            color: rgba(199, 210, 254, 0.95);
        }

        .input-mini {
            width: 9.8rem;
            padding: 6px 8px;
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.10);
            font-size: 12px;
        }

        .btn-glow {
            position: relative;
            overflow: hidden;
        }
        .btn-glow::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(400px 120px at var(--x, 50%) var(--y, 50%), rgba(255,255,255,0.35), transparent 60%);
            opacity: 0;
            transition: opacity 200ms ease;
        }
        .btn-glow:hover::before { opacity: 1; }

        @media print {
            .no-print { display: none !important; }
            body { font-size: 10pt !important; background: #fff !important; }
        }

        /* =========================================================
           OPTION B (Classic) SKIN OVERRIDES
           Applies a cleaner, more "classic" UI while keeping Option A functionality.
        ========================================================= */
        :root {
            --primary: #667eea;
            --primary-2: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --dark-bg: #1a1a2e;
            --dark-card: #16213e;
            --text-main: #1f2937;
            --text-light: #eef2ff;
        }

        body {
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.6;
            background: #f5f7fa !important;
            color: var(--text-main) !important;
        }

        .dark-mode {
            background: var(--dark-bg) !important;
            color: var(--text-light) !important;
        }

        /* Main content spacing like Option B */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            /* leave room for the right action dock + left sidebar toggle */
            padding: 20px 90px 20px 90px;
        }
        @media (max-width: 768px) {
            /* on mobile the dock becomes a bottom bar */
            .app-container { padding: 84px 20px 20px 20px; }
        }

        /* Cards: more solid and crisp */
        .glass, .glass-strong {
            background: rgba(255,255,255,0.96) !important;
            border: 1px solid rgba(15, 23, 42, 0.08) !important;
            box-shadow: 0 12px 30px rgba(2, 6, 23, 0.08) !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }
        .dark-mode .glass, .dark-mode .glass-strong {
            background: rgba(22, 33, 62, 0.95) !important;
            border-color: rgba(255,255,255,0.08) !important;
            box-shadow: 0 18px 45px rgba(0,0,0,0.35) !important;
        }

        /* Reduce overly-round Tailwind radii for a more rectangular look */
        .rounded-3xl { border-radius: 14px !important; }
        .rounded-2xl { border-radius: 12px !important; }
        .rounded-xl { border-radius: 10px !important; }

        /* Sidebar: classic Option B style */
        .sidebar {
            position: fixed;
            left: -288px;
            top: 0;
            width: 288px;
            height: 100%;
            background: var(--dark-card) !important;
            color: rgba(255,255,255,0.92) !important;
            transition: left 0.28s ease;
            z-index: 2000;
            overflow-y: auto;
            box-shadow: 4px 0 15px rgba(0,0,0,0.35) !important;
            border-right: 1px solid rgba(255,255,255,0.08) !important;
            border-top-right-radius: 14px !important;
            border-bottom-right-radius: 14px !important;
        }
        .sidebar.active { left: 0; }

        .overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55) !important;
            z-index: 1999;
        }
        .overlay.active { display: block; }

        /* Sidebar buttons: ensure text fits and stays readable */
        .sidebar nav .menu-item {
            margin: 6px 12px !important;
            padding: 12px 14px !important;
            border-radius: 12px !important;
            border-left: 4px solid transparent;
            white-space: normal;
            word-break: break-word;
            line-height: 1.25;
            color: rgba(255,255,255,0.92) !important;
        }
        .sidebar nav .menu-item:hover {
            background: rgba(255,255,255,0.08) !important;
            border-left-color: var(--primary) !important;
        }

        .sidebar-section-toggle {
            margin: 6px 12px !important;
            padding: 12px 14px !important;
            border-radius: 12px !important;
            color: rgba(255,255,255,0.92) !important;
        }

        #monthMenu, #subjectMenu {
            margin: 0 12px 14px !important;
            padding: 8px 0 !important;
            border-radius: 12px !important;
            background: rgba(0,0,0,0.22) !important;
        }

        .sidebar-subitem {
            margin: 6px 10px !important;
            padding: 10px 12px !important;
            border-radius: 10px !important;
            color: rgba(255,255,255,0.86) !important;
            white-space: normal;
            word-break: break-word;
            line-height: 1.25;
        }
        .sidebar-subitem:hover { background: rgba(255,255,255,0.08) !important; color: rgba(255,255,255,0.95) !important; }

        /* Tables: more classic (Option B) */
        table { width: 100%; border-collapse: collapse; }
        th { font-size: 13px; letter-spacing: 0.01em; }
        td { border-color: rgba(15, 23, 42, 0.08) !important; }
        .dark-mode td { border-color: rgba(255,255,255,0.08) !important; }
        .table-row-hover:hover { background: rgba(102, 126, 234, 0.08) !important; }

        /* Date chip: keep but tone it to match classic skin */
        .date-chip {
            background: rgba(102, 126, 234, 0.12) !important;
            border-color: rgba(102, 126, 234, 0.22) !important;
            color: rgba(79, 70, 229, 1) !important;
        }
        .dark-mode .date-chip {
            background: rgba(102, 126, 234, 0.18) !important;
            border-color: rgba(102, 126, 234, 0.25) !important;
            color: rgba(224, 231, 255, 0.95) !important;
        }

        /* Modal: slightly more classic */
        #genericModal > div, #notesModal > div, #timerModal > div {
            border-radius: 16px !important;
        }

        /* =========================================================
           RIGHT ACTION DOCK (Icons + Tooltips)
        ========================================================= */
        .action-dock {
            position: fixed;
            right: 16px;
            left: auto;
            top: 78px;
            z-index: 1600;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            border-radius: 16px;
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(15, 23, 42, 0.10);
            box-shadow: 0 12px 30px rgba(2, 6, 23, 0.10);
        }
        .dark-mode .action-dock {
            background: rgba(22, 33, 62, 0.96);
            border-color: rgba(255,255,255,0.10);
            box-shadow: 0 18px 45px rgba(0,0,0,0.35);
        }

        .dock-btn {
            position: relative;
            width: 46px;
            height: 46px;
            border-radius: 14px;
            display: grid;
            place-items: center;
            color: white;
            font-size: 18px;
            font-weight: 800;
            border: 1px solid rgba(255,255,255,0.18);
            box-shadow: 0 10px 22px rgba(2, 6, 23, 0.14);
            transition: transform 140ms ease, filter 140ms ease;
            cursor: pointer;
            user-select: none;
        }
        .dock-btn:hover { transform: translateY(-1px); filter: brightness(1.05); }

        /* Tooltip (shows purpose on hover) */
        .dock-btn::after {
            content: attr(data-tip);
            position: absolute;
            right: calc(100% + 12px);
            left: auto;
            top: 50%;
            transform: translateY(-50%) translateX(4px);
            opacity: 0;
            pointer-events: none;
            white-space: nowrap;
            font-size: 12px;
            font-weight: 800;
            padding: 8px 10px;
            border-radius: 12px;
            color: rgba(255,255,255,0.96);
            background: rgba(15, 23, 42, 0.92);
            border: 1px solid rgba(255,255,255,0.10);
            box-shadow: 0 18px 40px rgba(2, 6, 23, 0.28);
            transition: opacity 120ms ease, transform 120ms ease;
        }
        .dock-btn::before {
            content: '';
            position: absolute;
            right: calc(100% + 6px);
            left: auto;
            top: 50%;
            transform: translateY(-50%) translateX(4px);
            opacity: 0;
            width: 10px;
            height: 10px;
            background: rgba(15, 23, 42, 0.92);
            border-right: 1px solid rgba(255,255,255,0.10);
            border-top: 1px solid rgba(255,255,255,0.10);
            rotate: 45deg;
            transition: opacity 120ms ease, transform 120ms ease;
        }
        .dock-btn:hover::after, .dock-btn:hover::before {
            opacity: 1;
            transform: translateY(-50%) translateX(0);
        }

        .dock-divider {
            height: 1px;
            margin: 2px 4px;
            background: rgba(15, 23, 42, 0.12);
        }
        .dark-mode .dock-divider { background: rgba(255,255,255,0.12); }

        @media (max-width: 768px) {
            .action-dock {
                top: auto;
                bottom: 14px;
                right: auto;
                left: 50%;
                transform: translateX(-50%);
                flex-direction: row;
                border-radius: 18px;
            }
            .dock-btn::after, .dock-btn::before { display: none; }
        }

        /* =========================================================
           USER THEME OVERRIDE (Provided CSS)
           Applies a clean modern "card" design across the app.
        ========================================================= */
        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --primary-2: var(--primary-dark);
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f8f9fa;
            --dark: #343a40;
            --bg: #f4f6fb;
            --card: #ffffff;
            --text: #2d3748;
            --border: #e2e8f0;

            /* compatibility with older styles */
            --dark-bg: #1a202c;
            --dark-card: #2d3748;
        }

        html, body { height: 100%; }
        body {
            background: var(--bg) !important;
            color: var(--text) !important;
            font-family: "Segoe UI", Tahoma, system-ui, -apple-system, Arial, sans-serif !important;
            min-height: 100vh;
        }

        /* Dark mode mapped to your variables */
        body.dark-mode {
            --bg: #1a202c;
            --card: #2d3748;
            --text: #edf2f7;
            --border: #4a5568;
            --light: #111827;
            --dark: #0f172a;

            background: var(--bg) !important;
            color: var(--text) !important;
        }

        /* Main container */
        .app-container {
            max-width: 1280px !important;
            margin: auto !important;
            padding: 24px 104px 28px 104px !important; /* room for dock + sidebar toggle */
        }
        @media (max-width: 768px) {
            .app-container { padding: 88px 16px 20px 16px !important; }
        }

        /* Cards */
        .glass, .glass-strong {
            background: var(--card) !important;
            border: 1px solid var(--border) !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08) !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }

        /* Tables */
        table {
            background: var(--card) !important;
            border: 1px solid var(--border) !important;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
        }
        table thead { background: var(--light) !important; }
        table thead th {
            background: transparent !important;
            color: var(--text) !important;
            font-weight: 800;
        }
        td {
            border-color: var(--border) !important;
            color: var(--text) !important;
        }
        .dark-mode td { border-color: var(--border) !important; }

        /* Inputs */
        input, textarea, select {
            background: var(--card) !important;
            color: var(--text) !important;
            border-color: var(--border) !important;
        }

        /* Sidebar (match page palette + strong contrast) */
        .sidebar {
            /* override inline background */
            background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(248,250,252,0.96)) !important;
            color: var(--text) !important;
            border-right: 1px solid var(--border) !important;
            box-shadow: 8px 0 26px rgba(2, 6, 23, 0.10) !important;
        }

        body.dark-mode .sidebar {
            background: linear-gradient(180deg, rgba(15,23,42,0.96), rgba(2,6,23,0.96)) !important;
            color: rgba(255,255,255,0.92) !important;
            border-right: 1px solid rgba(255,255,255,0.10) !important;
            box-shadow: 8px 0 30px rgba(0,0,0,0.45) !important;
        }

        /* Sidebar typography + readable colors */
        .sidebar h2 { color: rgba(30, 41, 59, 0.95) !important; }
        body.dark-mode .sidebar h2 { color: rgba(224, 231, 255, 0.95) !important; }

        .sidebar nav .menu-item,
        .sidebar-section-toggle,
        .sidebar-subitem {
            color: rgba(15,23,42,0.92) !important;
        }
        body.dark-mode .sidebar nav .menu-item,
        body.dark-mode .sidebar-section-toggle,
        body.dark-mode .sidebar-subitem {
            color: rgba(255,255,255,0.92) !important;
        }

        /* Sub-panels inside sidebar */
        #monthMenu, #subjectMenu {
            background: rgba(15, 23, 42, 0.04) !important;
            border: 1px solid rgba(15, 23, 42, 0.06) !important;
        }
        body.dark-mode #monthMenu, body.dark-mode #subjectMenu {
            background: rgba(255,255,255,0.06) !important;
            border: 1px solid rgba(255,255,255,0.08) !important;
        }

        /* Hover states aligned with theme */
        .sidebar nav .menu-item:hover,
        .sidebar-section-toggle:hover,
        .sidebar-subitem:hover {
            background: rgba(102, 126, 234, 0.12) !important;
        }
        body.dark-mode .sidebar nav .menu-item:hover,
        body.dark-mode .sidebar-section-toggle:hover,
        body.dark-mode .sidebar-subitem:hover {
            background: rgba(255,255,255,0.08) !important;
        }

        /* Date chip */
        .date-chip {
            background: rgba(102, 126, 234, 0.12) !important;
            border-color: rgba(102, 126, 234, 0.25) !important;
            color: var(--text) !important;
        }

        /* Action dock matches cards */
        .action-dock {
            background: var(--card) !important;
            border-color: var(--border) !important;
        }

        /* Buttons (keep existing gradients, but improve base feel) */
        .btn-glow { border-radius: 10px !important; }

        /* =========================================================
           BOUNCY HOVER (Cards/Boxes)
        ========================================================= */
        @keyframes softBounce {
            0% { transform: translateY(0) scale(1); }
            45% { transform: translateY(-4px) scale(1.01); }
            75% { transform: translateY(1px) scale(0.995); }
            100% { transform: translateY(0) scale(1); }
        }

        /* Micro-bounce (for specific table items like date/topic only) */
        @keyframes microBounce {
            0% { transform: translateY(0) scale(1); }
            42% { transform: translateY(-3px) scale(1.01); }
            72% { transform: translateY(1px) scale(0.995); }
            100% { transform: translateY(0) scale(1); }
        }

        .hover-bounce {
            display: inline-block;
            will-change: transform;
        }
        .hover-bounce:hover {
            animation: microBounce 360ms cubic-bezier(.34, 1.56, .64, 1);
        }

        /* Use alongside existing components (e.g., <div class="date-chip bounceable">) */
        .bounceable {
            will-change: transform;
        }
        .bounceable:hover {
            animation: microBounce 360ms cubic-bezier(.34, 1.56, .64, 1);
        }

        .glass, .glass-strong {
            will-change: transform;
            transition: box-shadow 200ms ease, transform 200ms ease;
        }

        /* Card bounce is opt-in (dashboard only). */
        .bouncy-card {
            will-change: transform;
            transition: box-shadow 200ms ease, transform 200ms ease;
        }
        .bouncy-card:hover {
            animation: softBounce 420ms cubic-bezier(.34, 1.56, .64, 1);
            box-shadow: 0 16px 34px rgba(2, 6, 23, 0.12) !important;
        }

        /* Sidebar should NOT bounce as a whole (disable card hover bounce on sidebar container) */
        .sidebar.glass:hover,
        .sidebar.glass-strong:hover,
        .sidebar:hover {
            animation: none !important;
            transform: none !important;
        }

        /* Instead, bounce each individual navigation line item */
        .sidebar nav .menu-item,
        .sidebar-section-toggle,
        .sidebar-subitem {
            will-change: transform;
            transform-origin: left center;
        }
        .sidebar nav .menu-item:hover,
        .sidebar-section-toggle:hover,
        .sidebar-subitem:hover {
            animation: microBounce 360ms cubic-bezier(.34, 1.56, .64, 1);
        }

        /* Disable card hover animation for specific surfaces (login + monthly + subject table cards) */
        .no-hover-card.glass:hover,
        .no-hover-card.glass-strong:hover {
            animation: none !important;
            transform: none !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08) !important;
        }

        .dark-mode .no-hover-card.glass:hover,
        .dark-mode .no-hover-card.glass-strong:hover {
            animation: none !important;
            transform: none !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.22) !important;
        }

        @media (prefers-reduced-motion: reduce) {
            .bouncy-card:hover,
            .hover-bounce:hover,
            .bounceable:hover,
            .table-row-hover:hover {
                animation: none !important;
                transform: none !important;
            }
        }

        /* =========================================================
           UI POLISH: Sizing & Layout Harmony
        ========================================================= */
        #mainApp main h1 { letter-spacing: -0.02em; }
        #mainApp main h2 { letter-spacing: -0.015em; }
        #mainApp main h3 { letter-spacing: -0.01em; }

        /* Buttons: consistent sizing (exclude dock + sidebar toggle) */
        #mainApp button:not(.dock-btn):not(.w-12):not(.h-12) {
            min-height: 44px;
            font-size: 14px;
            line-height: 1.1;
        }
        #authScreen button {
            min-height: 44px;
            font-size: 14px;
            line-height: 1.1;
        }

        /* Action dock: slightly more premium */
        .dock-btn {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            font-size: 18px;
        }

        /* Sidebar navigation sizing */
        .sidebar nav .menu-item,
        .sidebar-section-toggle {
            min-height: 46px;
            font-size: 14px;
        }
        .sidebar-subitem {
            min-height: 40px;
            font-size: 13px;
        }

        /* Tables: improve density/whitespace balance */
        table th.p-3 { padding: 14px 16px !important; }
        table td.p-3 { padding: 12px 16px !important; }
        table th.p-2 { padding: 12px 14px !important; }
        table td.p-2 { padding: 10px 14px !important; }

        /* Dashboard subject cards: more consistent height */
        #subjectCards > div { min-height: 132px; }

        /* Inputs: comfortable tap targets */
        input, select, textarea {
            min-height: 42px;
        }
        textarea { min-height: 120px; }

        /* Print */
        @media print {
            body { background: white !important; color: #000 !important; }
            .glass, .glass-strong, table { box-shadow: none !important; }
        }

        /* =========================================================
           TYPOGRAPHY + SPACING POLISH (Lato)
        ========================================================= */
        html, body {
            font-family: 'Lato', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif !important;
            text-rendering: geometricPrecision;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Stronger hierarchy */
        #mainApp main h1 { font-weight: 900 !important; }
        #mainApp main h2 { font-weight: 900 !important; }
        #mainApp main h3 { font-weight: 800 !important; }
        #mainApp main h4 { font-weight: 800 !important; }

        /* Make small labels readable */
        #mainApp .text-xs { font-weight: 700 !important; letter-spacing: 0.02em; }
        #mainApp .text-sm { font-weight: 700; }

        /* More breathing space inside card-like surfaces */
        .glass.rounded-3xl,
        .glass-strong.rounded-3xl {
            padding: 26px !important;
        }
        /* Don‚Äôt affect cards that already set their own padding strongly */
        .glass.rounded-3xl.p-4,
        .glass.rounded-3xl.p-5,
        .glass.rounded-3xl.p-6,
        .glass-strong.rounded-3xl.p-8,
        .glass-strong.rounded-3xl.p-10 {
            padding: unset !important;
        }

        /* Bigger cards + nicer spacing */
        #tab-overview .grid { gap: 18px !important; }
        #subjectCards { gap: 18px !important; }
        #subjectCards > div {
            min-height: 132px;
            padding: 18px !important;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Dashboard stat tiles: richer typography */
        #statProgress, #statStreak, #statHours, #statDays {
            font-weight: 900 !important;
            letter-spacing: -0.02em;
        }

        /* Tables: a little more editorial */
        table thead th {
            font-weight: 900 !important;
            font-size: 13px !important;
        }
        table td {
            font-weight: 600;
        }

        /* Sidebar titles feel premium */
        .sidebar h2 {
            font-weight: 900 !important;
            letter-spacing: -0.01em;
        }
    </style>
</head>
<body class="min-h-screen antialiased">
    <!-- Auth Screen -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
        <!-- Decorative blobs -->
        <div class="absolute -top-24 -left-24 w-96 h-96 bg-indigo-500/35 blur-3xl rounded-full"></div>
        <div class="absolute -bottom-28 -right-24 w-[28rem] h-[28rem] bg-fuchsia-500/30 blur-3xl rounded-full"></div>
        <div class="absolute top-1/3 left-1/2 -translate-x-1/2 w-[38rem] h-[14rem] bg-emerald-400/15 blur-3xl rounded-full"></div>

        <div class="w-full max-w-md glass-strong no-hover-card rounded-3xl p-8 sm:p-10 relative soft-ring">
            <div class="text-center mb-8">
                <div class="mx-auto w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-500 to-fuchsia-500 text-white flex items-center justify-center text-2xl shadow-lg">üéØ</div>
                <h1 class="text-3xl font-extrabold mt-4 tracking-tight"><span class="gradient-text">WBCS 2026</span></h1>
                <p class="text-slate-600 dark:text-slate-300 mt-2">Interactive Study Portal ‚Ä¢ MongoDB Powered</p>
            </div>

            <div id="authTabs" class="grid grid-cols-2 bg-white/50 rounded-2xl p-1 border border-white/60 shadow-sm">
                <button onclick="showAuthTab('login')" id="loginTab" class="py-2.5 rounded-xl bg-gradient-to-r from-indigo-500 to-fuchsia-500 text-white font-bold transition btn-glow">Login</button>
                <button onclick="showAuthTab('register')" id="registerTab" class="py-2.5 rounded-xl text-slate-700 font-bold transition">Register</button>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="mt-6">
                <div class="mb-4">
                    <label class="block text-slate-700 font-bold mb-2">Email</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white/70" placeholder="you@email.com" autocomplete="username">
                </div>
                <div class="mb-6">
                    <label class="block text-slate-700 font-bold mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white/70" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
                </div>
                <button onclick="handleLogin()" class="w-full py-3 rounded-2xl font-extrabold text-white bg-gradient-to-r from-indigo-500 to-fuchsia-500 hover:brightness-110 transition shadow-lg btn-glow">Sign In</button>
                <p class="text-xs text-slate-500 mt-4 text-center">Tip: use <span class="font-semibold">admin@wbcs.com</span> / <span class="font-semibold">admin123</span> to access admin panel (if server seeded).</p>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden mt-6">
                <div class="mb-4">
                    <label class="block text-slate-700 font-bold mb-2">Full Name</label>
                    <input type="text" id="regName" class="w-full px-4 py-3 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white/70" placeholder="Your Name" autocomplete="name">
                </div>
                <div class="mb-4">
                    <label class="block text-slate-700 font-bold mb-2">Email</label>
                    <input type="email" id="regEmail" class="w-full px-4 py-3 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white/70" placeholder="you@email.com" autocomplete="username">
                </div>
                <div class="mb-6">
                    <label class="block text-slate-700 font-bold mb-2">Password</label>
                    <input type="password" id="regPassword" class="w-full px-4 py-3 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white/70" placeholder="Min 6 characters" autocomplete="new-password">
                </div>
                <button onclick="handleRegister()" class="w-full py-3 rounded-2xl font-extrabold text-white bg-gradient-to-r from-emerald-500 to-teal-500 hover:brightness-110 transition shadow-lg btn-glow">Create Account</button>
            </div>

            <div id="authError" class="mt-4 text-rose-600 text-center hidden font-semibold"></div>
            <div id="authLoader" class="hidden"><div class="loader"></div></div>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="mainApp" class="hidden">
        <!-- Sidebar Toggle -->
        <button onclick="toggleSidebar()" class="fixed left-4 top-4 z-50 text-white w-12 h-12 rounded-2xl shadow-lg flex items-center justify-center text-xl no-print transition btn-glow"
                style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
            ‚ò∞
        </button>

        <!-- Left Action Dock -->
        <div class="action-dock no-print" id="actionDock" aria-label="Quick actions">
            <button class="dock-btn btn-glow" data-tip="Theme" onclick="toggleDarkMode()" style="background: linear-gradient(135deg, #334155, #475569);">üåô</button>
            <button class="dock-btn btn-glow" data-tip="Backup" onclick="exportData()" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">üíæ</button>
            <button class="dock-btn btn-glow" data-tip="Restore" onclick="importData()" style="background: linear-gradient(135deg, #fde047, #f59e0b); color: #0f172a; border-color: rgba(15,23,42,0.10);">üì•</button>
            <button class="dock-btn btn-glow" data-tip="Print" onclick="window.print()" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">üñ®Ô∏è</button>
            <div class="dock-divider"></div>
            <button class="dock-btn btn-glow" data-tip="Sync" onclick="syncData()" style="background: linear-gradient(135deg, #22c55e, #10b981);">üîÑ</button>
            <button class="dock-btn btn-glow" data-tip="Logout" onclick="handleLogout()" style="background: linear-gradient(135deg, #ef4444, #f43f5e);">üîí</button>
        </div>

        <!-- Overlay -->
        <div class="overlay fixed inset-0 bg-black/50 z-40" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside class="sidebar fixed left-0 top-0 w-72 h-full z-50 overflow-y-auto no-print glass"
               style="border-top-right-radius: 18px; border-bottom-right-radius: 18px;">
            <div class="p-6 border-b" style="border-color: rgba(255,255,255,0.10);">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-fuchsia-500 flex items-center justify-center shadow">üéØ</div>
                    <div>
                        <h2 class="text-lg font-extrabold text-indigo-200">WBCS 2026</h2>
                        <p class="text-xs text-slate-300/70">Interactive Study Portal</p>
                    </div>
                </div>
                <p class="text-xs text-indigo-200/90 mt-3" id="sidebarUserEmail"></p>
            </div>

            <nav class="py-4">
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" onclick="switchTab('overview')">
                    <span>üìä</span> Dashboard
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" onclick="switchTab('weekday')">
                    <span>üìÖ</span> Weekday Routine
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" onclick="switchTab('weekend')">
                    <span>üåÖ</span> Weekend Routine
                </div>

                <div class="sidebar-section-toggle cursor-pointer hover:bg-white/10 flex items-center justify-between" onclick="toggleSubmenu('monthMenu')">
                    <span class="flex items-center gap-3"><span>üìÜ</span> Monthly Schedules</span>
                    <span id="monthMenuArrow">‚ñº</span>
                </div>
                <div id="monthMenu" class="hidden" style="background: rgba(2, 6, 23, 0.40);"></div>

                <div class="sidebar-section-toggle cursor-pointer hover:bg-white/10 flex items-center justify-between" onclick="toggleSubmenu('subjectMenu')">
                    <span class="flex items-center gap-3"><span>üìö</span> Subjects</span>
                    <span id="subjectMenuArrow">‚ñº</span>
                </div>
                <div id="subjectMenu" class="hidden" style="background: rgba(2, 6, 23, 0.40);">
                    <div class="sidebar-subitem text-emerald-300 cursor-pointer hover:bg-white/10 text-sm" onclick="createNewSubject()">‚ûï Add Subject</div>
                    <div id="subjectMenuList"></div>
                </div>

                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" onclick="switchTab('tests')">
                    <span>‚úÖ</span> Test Tracker
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" onclick="switchTab('analytics')">
                    <span>üìà</span> Analytics
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" onclick="openNotesModal()">
                    <span>üìù</span> Global Notes
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-indigo-400 transition flex items-center gap-3" onclick="openTimerModal()">
                    <span>‚è±Ô∏è</span> Session Timer
                </div>

                <!-- Admin Menu (visible for admins) -->
                <div id="adminMenuSection" class="hidden border-t mt-4 pt-4" style="border-color: rgba(255,255,255,0.10);">
                    <div class="px-6 py-2 text-xs text-slate-300/70 uppercase">Admin Panel</div>
                    <div class="menu-item px-6 py-3 cursor-pointer hover:bg-white/10 border-l-4 border-transparent hover:border-yellow-400 transition flex items-center gap-3 text-yellow-300" onclick="switchTab('admin')">
                        <span>‚öôÔ∏è</span> Manage Blueprints
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="app-container transition-all">
            <!-- Header -->
            <header class="relative overflow-hidden rounded-3xl mb-6 no-print glass">
                <div class="absolute inset-0" style="background: linear-gradient(135deg, rgba(99,102,241,0.92), rgba(217,70,239,0.78));"></div>
                <div class="absolute -top-20 -right-20 w-72 h-72 bg-white/15 blur-2xl rounded-full"></div>
                <div class="absolute -bottom-24 -left-24 w-72 h-72 bg-white/15 blur-2xl rounded-full"></div>
                <div class="relative p-7 text-white">
                    <div class="flex flex-wrap items-start justify-between gap-3">
                        <div>
                            <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">üéØ WBCS Exam Preparation 2026</h1>
                            <p class="text-white/90 mt-1">A beautiful blueprint + progress system with per-user rescheduling</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-white/80 font-bold">Signed in</div>
                            <div id="userEmailDisplay" class="text-sm font-extrabold text-white/95"></div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Controls moved to left action dock -->

            <!-- Tab Contents -->
            <!-- Overview Tab -->
            <div id="tab-overview" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-7">
                    <div class="glass bouncy-card rounded-3xl p-7 border-l-4 border-indigo-500">
                        <h3 class="text-sm uppercase text-slate-500 font-extrabold tracking-wider">Overall Progress</h3>
                        <div class="text-4xl font-extrabold text-indigo-600 mt-3" id="statProgress">0%</div>
                        <div class="h-3 bg-white/70 rounded-full mt-4 overflow-hidden">
                            <div class="progress-bar h-full" id="progressBar" style="width: 0%; background: linear-gradient(90deg, var(--primary), var(--primary-2));"></div>
                        </div>
                    </div>
                    <div class="glass bouncy-card rounded-3xl p-7 border-l-4 border-emerald-500">
                        <h3 class="text-sm uppercase text-slate-500 font-extrabold tracking-wider">Study Streak</h3>
                        <div class="text-4xl font-extrabold text-emerald-600 mt-3" id="statStreak">0 days</div>
                        <div class="text-xs text-slate-500 mt-2 font-bold">Keep it alive daily</div>
                    </div>
                    <div class="glass bouncy-card rounded-3xl p-7 border-l-4 border-sky-500">
                        <h3 class="text-sm uppercase text-slate-500 font-extrabold tracking-wider">Total Hours</h3>
                        <div class="text-4xl font-extrabold text-sky-600 mt-3" id="statHours">0.0h</div>
                        <div class="text-xs text-slate-500 mt-2 font-bold">Completed task hours</div>
                    </div>
                    <div class="glass bouncy-card rounded-3xl p-7 border-l-4 border-rose-500">
                        <h3 class="text-sm uppercase text-slate-500 font-extrabold tracking-wider">Days to Exam</h3>
                        <div class="text-4xl font-extrabold text-rose-600 mt-3" id="statDays">0</div>
                        <div class="text-xs text-slate-500 mt-2 font-bold">Until 20 Mar 2026</div>
                    </div>
                </div>

                <div class="glass bouncy-card rounded-3xl p-8 mb-7">
                    <h3 class="text-xl font-extrabold text-slate-800 mb-3">üìã Preparation Summary</h3>
                    <p class="text-slate-700 text-base">Target Date: <strong class="text-indigo-700">20 March 2026 (Preliminary)</strong></p>
                    <p class="text-slate-600 mt-2 text-sm">Your plan includes comprehensive GS coverage with regular mock tests and rescheduling support per user.</p>
                </div>

                <h2 class="text-xl font-extrabold text-slate-800 mb-4">üìö Quick Subject Access</h2>
                <div id="subjectCards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </div>

            <!-- Weekday Tab -->
            <div id="tab-weekday" class="tab-content">
                <h2 class="text-2xl font-extrabold text-slate-800 mb-4">üìÖ Weekday Routine</h2>
                <div class="glass rounded-3xl overflow-hidden">
                    <table class="w-full">
                        <thead class="text-white" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                            <tr>
                                <th class="p-3 text-left">Time</th>
                                <th class="p-3 text-left">Activity</th>
                                <th class="p-3 text-left">Details</th>
                                <th class="p-3 text-left">Duration</th>
                            </tr>
                        </thead>
                        <tbody id="weekdayTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Weekend Tab -->
            <div id="tab-weekend" class="tab-content">
                <h2 class="text-2xl font-extrabold text-slate-800 mb-4">üåÖ Weekend Routine</h2>
                <h3 class="text-lg font-bold text-slate-700 mb-2">Saturday</h3>
                <div class="glass rounded-3xl overflow-hidden mb-6">
                    <table class="w-full">
                        <thead class="text-white" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                            <tr><th class="p-3 text-left">Time</th><th class="p-3 text-left">Activity</th><th class="p-3 text-left">Details</th><th class="p-3 text-left">Duration</th></tr>
                        </thead>
                        <tbody id="saturdayTable"></tbody>
                    </table>
                </div>
                <h3 class="text-lg font-bold text-slate-700 mb-2">Sunday</h3>
                <div class="glass rounded-3xl overflow-hidden">
                    <table class="w-full">
                        <thead class="text-white" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                            <tr><th class="p-3 text-left">Time</th><th class="p-3 text-left">Activity</th><th class="p-3 text-left">Details</th><th class="p-3 text-left">Duration</th></tr>
                        </thead>
                        <tbody id="sundayTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Monthly Tabs (Dynamic) -->
            <div id="monthlyTabs"></div>

            <!-- Subject View Tab -->
            <div id="tab-subject-view" class="tab-content">
                <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
                    <h2 class="text-2xl font-extrabold" id="subjectViewTitle">Subject</h2>
                    <button onclick="deleteCurrentSubject()" class="px-4 py-2 rounded-2xl text-sm font-extrabold text-white btn-glow" style="background: linear-gradient(135deg, #ef4444, #f43f5e);">üóëÔ∏è Delete Subject</button>
                </div>
                <div class="glass no-hover-card rounded-3xl overflow-x-auto">
                    <table class="w-full">
                        <thead class="text-white" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                            <tr>
                                <th class="p-3 text-left">Topic</th>
                                <th class="p-3 text-left">Date (editable)</th>
                                <th class="p-3 text-left">Day</th>
                                <th class="p-3 text-left">Hours</th>
                                <th class="p-3 text-left">Status</th>
                                <th class="p-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subjectTopicsTable"></tbody>
                    </table>
                </div>
                <button onclick="addTopicToSubject()" class="mt-4 px-4 py-2 rounded-2xl font-extrabold text-white btn-glow" style="background: linear-gradient(135deg, #22c55e, #10b981);">‚ûï Add Topic</button>
            </div>

            <!-- Tests Tab -->
            <div id="tab-tests" class="tab-content">
                <div class="flex flex-wrap items-end justify-between gap-3 mb-4">
                    <div>
                        <h2 class="text-2xl font-extrabold text-slate-800">‚úÖ Test Tracker</h2>
                        <p class="text-slate-600 mt-1">Reschedule blueprint tests per-user, or add your own subject/mixed/full mock tests (stored in your MongoDB progress).</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="openAddPersonalTestModal()" class="px-4 py-2 rounded-2xl text-sm font-extrabold text-white btn-glow" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">‚ûï Add Personal Test</button>
                    </div>
                </div>

                <div class="glass rounded-3xl overflow-x-auto">
                    <table class="w-full">
                        <thead class="text-white" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                            <tr>
                                <th class="p-3 text-left">Test</th>
                                <th class="p-3 text-left">Date (editable)</th>
                                <th class="p-3 text-left">Type</th>
                                <th class="p-3 text-left">MCQs</th>
                                <th class="p-3 text-left">Focus</th>
                                <th class="p-3 text-left">Target</th>
                                <th class="p-3 text-left">Score</th>
                                <th class="p-3 text-left">%</th>
                                <th class="p-3 text-left">Status</th>
                                <th class="p-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="testsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="tab-analytics" class="tab-content">
                <h2 class="text-2xl font-extrabold text-slate-800 mb-4">üìà Progress Analytics</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass rounded-3xl p-6">
                        <h3 class="text-lg font-extrabold text-slate-800 mb-4">Subject Progress</h3>
                        <div id="subjectAnalytics"></div>
                    </div>
                    <div class="glass rounded-3xl p-6">
                        <h3 class="text-lg font-extrabold text-slate-800 mb-4">Weekly Study Hours</h3>
                        <div id="weeklyChart" class="h-48 flex items-end gap-2"></div>
                    </div>
                </div>
            </div>

            <!-- Admin Tab -->
            <div id="tab-admin" class="tab-content">
                <h2 class="text-2xl font-extrabold text-slate-800 mb-4">‚öôÔ∏è Admin - Manage Blueprints</h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Manage Routines -->
                    <div class="glass rounded-3xl p-6">
                        <h3 class="text-lg font-extrabold text-slate-800 mb-4">üìÖ Manage Routines</h3>
                        <div class="space-y-2">
                            <button onclick="editRoutine('weekday')" class="w-full px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">Edit Weekday Routine</button>
                            <button onclick="editRoutine('saturday')" class="w-full px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">Edit Saturday Routine</button>
                            <button onclick="editRoutine('sunday')" class="w-full px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">Edit Sunday Routine</button>
                        </div>
                    </div>

                    <!-- Manage Subjects -->
                    <div class="glass rounded-3xl p-6">
                        <h3 class="text-lg font-extrabold text-slate-800 mb-4">üìö Manage Subjects</h3>
                        <div id="adminSubjectList" class="space-y-2 mb-4"></div>
                        <button onclick="adminAddSubject()" class="w-full px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #22c55e, #10b981);">‚ûï Add New Subject</button>
                    </div>
                </div>

                <!-- Manage Monthly Blueprint -->
                <div class="glass rounded-3xl p-6 mb-6">
                    <h3 class="text-lg font-extrabold text-slate-800 mb-4">üìÜ Manage Monthly Blueprints</h3>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <select id="adminMonthSelect" class="px-4 py-2 border rounded-2xl bg-white/70">
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                        <button onclick="loadAdminMonthTasks()" class="px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">Load Tasks</button>
                        <button onclick="adminAddTask()" class="px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #22c55e, #10b981);">‚ûï Add Task</button>
                    </div>
                    <div class="text-xs text-slate-500 mb-3">Tip: You can edit task dates inline (admin blueprint update).</div>
                    <div id="adminTasksList" class="overflow-x-auto"></div>
                </div>

                <!-- Manage Tests -->
                <div class="glass rounded-3xl p-6">
                    <h3 class="text-lg font-extrabold text-slate-800 mb-4">‚úÖ Manage Test Schedule</h3>
                    <button onclick="adminAddTest()" class="px-4 py-2 rounded-2xl text-white font-extrabold btn-glow mb-4" style="background: linear-gradient(135deg, #22c55e, #10b981);">‚ûï Add Test</button>
                    <div class="text-xs text-slate-500 mb-3">Tip: You can edit test dates inline (admin blueprint update).</div>
                    <div id="adminTestsList" class="overflow-x-auto"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Generic Modal -->
    <div id="genericModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-strong rounded-3xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-white/50 flex justify-between items-center">
                <h3 id="modalTitle" class="text-xl font-extrabold text-slate-800">Modal</h3>
                <button onclick="closeModal()" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div id="modalBody" class="p-6"></div>
            <div class="p-6 border-t border-white/50 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 rounded-2xl bg-slate-200 text-slate-800 font-bold hover:bg-slate-300 transition">Cancel</button>
                <button id="modalSubmit" class="px-4 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">Save</button>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-strong rounded-3xl shadow-2xl w-full max-w-2xl">
            <div class="p-6 border-b border-white/50 flex justify-between items-center">
                <h3 class="text-xl font-extrabold text-slate-800">üìù Global Study Notes</h3>
                <button onclick="closeNotesModal()" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <textarea id="globalNotes" class="w-full h-64 p-4 border border-slate-200 rounded-2xl resize-none focus:ring-2 focus:ring-indigo-500 bg-white/70" placeholder="Write your study notes here..."></textarea>
            </div>
            <div class="p-6 border-t border-white/50">
                <button onclick="saveNotes()" class="w-full px-4 py-3 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #22c55e, #10b981);">üíæ Save Notes</button>
            </div>
        </div>
    </div>

    <!-- Timer Modal -->
    <div id="timerModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-strong rounded-3xl shadow-2xl w-full max-w-md text-center">
            <div class="p-6 border-b border-white/50 flex justify-between items-center">
                <h3 class="text-xl font-extrabold text-slate-800">‚è±Ô∏è Study Timer</h3>
                <button onclick="closeTimerModal()" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div class="p-8">
                <div id="timerDisplay" class="text-6xl font-mono font-extrabold text-indigo-600 mb-8">00:00:00</div>
                <div class="flex justify-center gap-3">
                    <button onclick="startTimer()" class="px-6 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #22c55e, #10b981);">‚ñ∂ Start</button>
                    <button onclick="pauseTimer()" class="px-6 py-2 rounded-2xl text-slate-900 font-extrabold btn-glow" style="background: linear-gradient(135deg, #fde047, #f59e0b);">‚è∏ Pause</button>
                    <button onclick="resetTimer()" class="px-6 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, #ef4444, #f43f5e);">‚èπ Reset</button>
                </div>
                <button onclick="saveSession()" class="mt-6 px-6 py-2 rounded-2xl text-white font-extrabold btn-glow" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">üíæ Save Session</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFile" class="hidden" accept=".json" onchange="handleImport(event)">

    <script>
        // =============================================
        // API CONFIGURATION (soft-coded)
        // =============================================
        // Default:
        // - If frontend is served by the same server as the API (recommended), it auto-uses:  <current-origin>/api
        // Override (useful when hosting frontend on Firebase and backend elsewhere):
        //   localStorage.setItem('wbcs_api_base', 'https://YOUR_BACKEND_DOMAIN/api')
        //   location.reload()
        const API_BASE = (function resolveApiBase(){
            const override = localStorage.getItem('wbcs_api_base');
            if (override) return override.replace(/\/$/, '');

            // Same-origin by default (works for Render/Railway/VM where Express serves index.html)
            const sameOrigin = `${window.location.origin}/api`;

            // If you are on localhost but using a different backend port, keep old default
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:5000/api';
            }

            return sameOrigin;
        })();

        // =============================================
        // APP STATE
        // =============================================
        let currentUser = null;
        let activeTabId = 'overview';
        let appData = {
            subjects: [],
            tasks: [],
            tests: [],
            routines: { weekday: [], saturday: [], sunday: [] },
            userProgress: {
                completedTasks: {},
                testScores: {},
                customDates: {},
                customTestDates: {},
                customTests: [],
                dailyNotes: {},
                studySessions: [],
                notes: '',
                darkMode: false
            }
        };
        let activeSubject = null;
        let timerInterval = null;
        let timerSeconds = 0;

        // =============================================
        // SMALL UTILITIES
        // =============================================
        function hashString(str) {
            let h = 0;
            for (let i = 0; i < (str || '').length; i++) {
                h = (h * 31 + str.charCodeAt(i)) >>> 0;
            }
            return h;
        }

        function getSubjectAccent(subject) {
            const hue = hashString(subject) % 360;
            const border = `hsl(${hue} 78% 52%)`;
            const text = document.body.classList.contains('dark-mode')
                ? `hsl(${hue} 80% 78%)`
                : `hsl(${hue} 58% 34%)`;
            const bar = `linear-gradient(90deg, hsl(${hue} 78% 52%), hsl(${(hue + 44) % 360} 78% 52%))`;
            return { hue, border, text, bar };
        }

        function clamp(n, min, max) {
            return Math.min(max, Math.max(min, n));
        }

        // Progress palette (0% = red, 100% = green)
        function getProgressPalette(pct) {
            const p = clamp(Number(pct) || 0, 0, 100);
            const hue = (p / 100) * 120; // 0..120 (red‚Üígreen)
            const isDark = document.body.classList.contains('dark-mode');

            // Text must remain readable across light/dark + row highlights.
            const text = isDark
                ? `hsl(${hue} 85% 78%)`
                : `hsl(${hue} 75% 28%)`;

            const mutedText = isDark
                ? `hsl(${hue} 55% 78%)`
                : `hsl(${hue} 55% 26%)`;

            const border = `hsl(${hue} 80% 44%)`;
            const bar = `linear-gradient(90deg, hsl(${clamp(hue - 10, 0, 120)} 85% 50%), hsl(${clamp(hue + 10, 0, 120)} 85% 45%))`;

            const pillBg = isDark
                ? `hsla(${hue}, 80%, 52%, 0.18)`
                : `hsla(${hue}, 85%, 55%, 0.16)`;

            const pillBorder = isDark
                ? `hsla(${hue}, 90%, 70%, 0.22)`
                : `hsla(${hue}, 65%, 38%, 0.22)`;

            return { pct: p, hue, text, mutedText, border, bar, pillBg, pillBorder };
        }

        function getSubjectProgress(subject) {
            const subjectTasks = (appData.tasks || []).filter(t => t.subject === subject);
            const completed = subjectTasks.filter(t => appData.userProgress?.completedTasks?.[t.id]).length;
            const total = subjectTasks.length;
            const pct = total ? Math.round((completed / total) * 100) : 0;
            return { completed, total, pct };
        }

        function getSubjectProgressPalette(subject) {
            return getProgressPalette(getSubjectProgress(subject).pct);
        }

        // =============================================
        // DATE HELPERS (avoid timezone shifts)
        // =============================================
        function parseISODate(dateStr) {
            if (!dateStr) return null;
            return new Date(dateStr + 'T00:00:00');
        }

        function toLocalISODate(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const da = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${da}`;
        }

        function formatDate(dateStr) {
            const d = parseISODate(dateStr);
            if (!d || Number.isNaN(d.getTime())) return '';
            return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
        }

        function getDayName(dateStr) {
            const d = parseISODate(dateStr);
            if (!d || Number.isNaN(d.getTime())) return '';
            return d.toLocaleDateString('en-US', { weekday: 'short' });
        }

        // =============================================
        // DATE HIGHLIGHT HELPERS (Monthly + Subject tables)
        // =============================================
        function getTaskRowHighlightClass(isoDate, isCompleted) {
            if (!isoDate) return '';
            const d = parseISODate(isoDate);
            if (!d || Number.isNaN(d.getTime())) return '';

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const dd = new Date(d);
            dd.setHours(0, 0, 0, 0);

            const ddISO = toLocalISODate(dd);
            const todayISO = toLocalISODate(today);
            const tomorrowISO = toLocalISODate(tomorrow);

            if (ddISO === todayISO) return 'row-today';
            if (ddISO === tomorrowISO) return 'row-tomorrow';

            if (dd < today) {
                return isCompleted ? 'row-past-done' : 'row-past-missed';
            }

            return '';
        }

        // =============================================
        // RESCHEDULING (per-user)
        // =============================================
        function getEffectiveTaskDate(task) {
            return appData.userProgress?.customDates?.[task.id] || task.date;
        }

        function getEffectiveTestDate(test) {
            // Personal tests store their date directly on the test object
            if (test?.origin === 'personal') return test.date;
            return appData.userProgress?.customTestDates?.[test.id] || test.date;
        }

        function updateTaskDate(taskId, newDate) {
            if (!newDate) return;
            appData.userProgress.customDates ||= {};

            const task = appData.tasks.find(t => t.id === taskId);
            if (task && task.date === newDate) {
                delete appData.userProgress.customDates[taskId];
            } else {
                appData.userProgress.customDates[taskId] = newDate;
            }
            saveProgress();
            renderAll();
            showToast('Task date updated (rescheduled)', 'success');
        }

        function updateTestDate(testId, newDate) {
            if (!newDate) return;

            // If it's a personal test, update the test object directly
            const personal = (appData.userProgress.customTests || []).find(t => t.id === testId);
            if (personal) {
                personal.date = newDate;
                // If an override existed, clear it
                if (appData.userProgress.customTestDates) delete appData.userProgress.customTestDates[testId];
                saveProgress();
                renderAll();
                showToast('Personal test date updated', 'success');
                return;
            }

            // Otherwise, per-user override for blueprint tests
            appData.userProgress.customTestDates ||= {};
            const test = appData.tests.find(t => t.id === testId);
            if (test && test.date === newDate) {
                delete appData.userProgress.customTestDates[testId];
            } else {
                appData.userProgress.customTestDates[testId] = newDate;
            }
            saveProgress();
            renderAll();
            showToast('Test date updated (rescheduled)', 'success');
        }

        // Admin blueprint inline updates
        function adminUpdateTaskDate(taskId, newDate) {
            if (!currentUser?.isAdmin) return;
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            task.date = newDate;
            saveAppData();
            loadAdminMonthTasks();
            renderAll();
            showToast('Blueprint task date updated', 'success');
        }

        function adminUpdateTestDate(testId, newDate) {
            if (!currentUser?.isAdmin) return;
            const test = appData.tests.find(t => t.id === testId);
            if (!test) return;
            test.date = newDate;
            saveAppData();
            renderAll();
            showToast('Blueprint test date updated', 'success');
        }

        // =============================================
        // API FUNCTIONS
        // =============================================
        async function apiCall(endpoint, method = 'GET', data = null) {
            const token = localStorage.getItem('wbcs_token');
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                }
            };
            if (data) options.body = JSON.stringify(data);

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);

                const ct = response.headers.get('content-type') || '';
                let result = null;

                // If API returns HTML/text (common when /api is not deployed), avoid JSON parse crash.
                if (ct.includes('application/json')) {
                    result = await response.json().catch(() => null);
                } else {
                    const text = await response.text().catch(() => '');
                    throw new Error(text || `Non-JSON API response (${response.status})`);
                }

                if (!response.ok) throw new Error(result?.message || `API Error (${response.status})`);
                return result;
            } catch (error) {
                // Quiet fallback: use localStorage data when API is missing/unreachable.
                console.warn('API unavailable, using local fallback:', error?.message || error);
                return null;
            }
        }

        // =============================================
        // AUTHENTICATION
        // =============================================
        function showAuthTab(tab) {
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');

            const loginBtn = document.getElementById('loginTab');
            const regBtn = document.getElementById('registerTab');

            if (tab === 'login') {
                loginBtn.className = "py-2.5 rounded-xl bg-gradient-to-r from-indigo-500 to-fuchsia-500 text-white font-bold transition btn-glow";
                regBtn.className = "py-2.5 rounded-xl text-slate-700 font-bold transition";
            } else {
                regBtn.className = "py-2.5 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-bold transition btn-glow";
                loginBtn.className = "py-2.5 rounded-xl text-slate-700 font-bold transition";
            }
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value?.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }

            document.getElementById('authError').classList.add('hidden');
            document.getElementById('authLoader').classList.remove('hidden');

            // Helper: enter demo mode (old behavior)
            const enterDemo = async (reasonMsg) => {
                document.getElementById('authLoader').classList.add('hidden');
                localStorage.removeItem('wbcs_token');
                currentUser = { email, name: email.split('@')[0], isAdmin: email.includes('admin') };
                localStorage.setItem('wbcs_user', JSON.stringify(currentUser));
                if (reasonMsg) showToast(reasonMsg, 'info');
                await initializeApp();
            };

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                // If backend returns HTML (wrong API_BASE), JSON parsing can fail.
                const result = await response.json().catch(() => ({}));

                // If login fails (invalid credentials OR API mismatch), fall back to demo (old sign-in behavior)
                if (!response.ok || !result?.token) {
                    const msg = result?.message || (!response.ok ? 'Login failed.' : 'Login failed: invalid server response.');
                    // Keep the error visible, but still allow entry into app in demo mode.
                    showAuthError(msg + ' (Entering Demo Mode)');
                    await enterDemo('Started in Demo Mode');
                    return;
                }

                // Success
                localStorage.setItem('wbcs_token', result.token);
                currentUser = result.user;
                localStorage.setItem('wbcs_user', JSON.stringify(currentUser));
                document.getElementById('authLoader').classList.add('hidden');
                await initializeApp();
            } catch (e) {
                console.warn('Login API unreachable, switching to demo mode:', e);
                await enterDemo('Server unreachable ‚Äî started in Demo Mode');
            }
        }

        async function handleRegister() {
            const name = document.getElementById('regName').value?.trim();
            const email = document.getElementById('regEmail').value?.trim();
            const password = document.getElementById('regPassword').value;

            if (!name || !email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }

            if (password.length < 6) {
                showAuthError('Password must be at least 6 characters');
                return;
            }

            document.getElementById('authError').classList.add('hidden');
            document.getElementById('authLoader').classList.remove('hidden');

            const enterDemo = async (reasonMsg) => {
                document.getElementById('authLoader').classList.add('hidden');
                localStorage.removeItem('wbcs_token');
                currentUser = { email, name, isAdmin: false };
                localStorage.setItem('wbcs_user', JSON.stringify(currentUser));
                if (reasonMsg) showToast(reasonMsg, 'info');
                await initializeApp();
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });

                const result = await response.json().catch(() => ({}));

                // Old behavior: if registration can't complete (API mismatch, server rules, etc.)
                // allow user to still proceed in demo mode.
                if (!response.ok || !result?.token) {
                    const msg = result?.message || (!response.ok ? 'Registration failed.' : 'Registration failed: invalid server response.');
                    showAuthError(msg + ' (Entering Demo Mode)');
                    await enterDemo('Created account in Demo Mode');
                    return;
                }

                localStorage.setItem('wbcs_token', result.token);
                currentUser = result.user;
                localStorage.setItem('wbcs_user', JSON.stringify(currentUser));
                document.getElementById('authLoader').classList.add('hidden');
                await initializeApp();
            } catch (e) {
                console.warn('Register API unreachable, switching to demo mode:', e);
                await enterDemo('Server unreachable ‚Äî created account in Demo Mode');
            }
        }

        function handleLogout() {
            localStorage.removeItem('wbcs_token');
            localStorage.removeItem('wbcs_user');
            currentUser = null;
            activeSubject = null;
            activeTabId = 'overview';

            // stop timer if running
            pauseTimer();
            timerSeconds = 0;
            updateTimerDisplay();

            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');

            // close sidebar if open
            document.querySelector('.sidebar')?.classList.remove('active');
            document.querySelector('.overlay')?.classList.remove('active');
        }

        function showAuthError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3500);
        }

        // =============================================
        // DATA LOADING & SAVING
        // =============================================
        function normalizeUserProgress() {
            appData.userProgress ||= {};
            appData.userProgress.completedTasks ||= {};
            appData.userProgress.testScores ||= {};
            appData.userProgress.customDates ||= {};
            appData.userProgress.customTestDates ||= {};
            appData.userProgress.customTests ||= [];
            appData.userProgress.dailyNotes ||= {};
            appData.userProgress.studySessions ||= [];
            appData.userProgress.notes ||= '';
            appData.userProgress.darkMode ||= false;
        }

        async function loadAppData() {
            // Try to load from API
            const serverData = await apiCall('/data');

            if (serverData) {
                appData = { ...appData, ...serverData };
            } else {
                const localData = localStorage.getItem('wbcs_appData');
                if (localData) {
                    appData = JSON.parse(localData);
                } else {
                    appData = getDefaultAppData();
                }
            }

            // Load user-specific progress
            const userProgress = await apiCall('/progress');
            if (userProgress) {
                appData.userProgress = { ...appData.userProgress, ...userProgress };
            } else {
                const localProgress = localStorage.getItem('wbcs_progress_' + currentUser.email);
                if (localProgress) {
                    appData.userProgress = { ...appData.userProgress, ...JSON.parse(localProgress) };
                }
            }

            normalizeUserProgress();
        }

        async function saveProgress() {
            normalizeUserProgress();

            await apiCall('/progress', 'PUT', appData.userProgress);
            localStorage.setItem('wbcs_progress_' + currentUser.email, JSON.stringify(appData.userProgress));
            localStorage.setItem('wbcs_appData', JSON.stringify(appData));
        }

        async function saveAppData() {
            if (!currentUser.isAdmin) return;

            await apiCall('/data', 'PUT', {
                subjects: appData.subjects,
                tasks: appData.tasks,
                tests: appData.tests,
                routines: appData.routines
            });

            localStorage.setItem('wbcs_appData', JSON.stringify(appData));
        }

        function getDefaultAppData() {
            return {
                subjects: ['Polity', 'History', 'Geography', 'Economy', 'Science', 'Environment', 'Current Affairs'],
                tasks: getDefaultTasks(),
                tests: getDefaultTests(),
                routines: getDefaultRoutines(),
                userProgress: {
                    completedTasks: {},
                    testScores: {},
                    customDates: {},
                    customTestDates: {},
                    customTests: [],
                    dailyNotes: {},
                    studySessions: [],
                    notes: '',
                    darkMode: false
                }
            };
        }

        function getDefaultTasks() {
            const tasks = [];
            const janData = [
                { date: '2026-01-01', morning: 'Polity: Constitution Basics, Preamble', evening: 'Polity MCQs (50)', test: 'New Year Holiday', subject: 'Polity', hours: 3.75 },
                { date: '2026-01-02', morning: 'History: 1857 Revolt - Causes & Course', evening: '1857 MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-03', morning: 'Geography: Earth, Solar System', evening: 'Geography MCQs', test: 'Weekend Study', subject: 'Geography', hours: 8.5 },
                { date: '2026-01-04', morning: 'Economy: National Income Concepts', evening: 'Economy MCQs', test: 'TEST 1: 50 MCQs', subject: 'Economy', hours: 8 },
                { date: '2026-01-05', morning: 'Polity: Fundamental Rights (Art 12-35)', evening: 'FR MCQs + Case laws', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-01-06', morning: 'History: Social Reform Movements', evening: 'Reformers MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-07', morning: 'Geography: Indian Physiography', evening: 'Mountain ranges MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-01-08', morning: 'Economy: Money, Banking, RBI Functions', evening: 'Banking MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-01-09', morning: 'Science: Physics - Motion, Work, Energy', evening: 'Physics MCQs', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-01-10', morning: 'Science: Heat, Light, Sound waves', evening: 'Science comp MCQs', test: 'Weekend Study', subject: 'Science', hours: 8.5 },
                { date: '2026-01-11', morning: 'Current Affairs: Dec 2025 Wrap-up', evening: 'CA MCQs', test: 'TEST 2: 50 MCQs', subject: 'Current Affairs', hours: 8 },
                { date: '2026-01-12', morning: 'Polity: DPSP (Art 36-51) & FD', evening: 'Directives MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-01-13', morning: 'History: INC Formation, Moderate Phase', evening: 'Early Congress MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-14', morning: 'Geography: Indian Drainage - Rivers', evening: 'Rivers Map Marking', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-01-15', morning: 'Economy: Fiscal Policy, Budget', evening: 'Budget Terms MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-01-16', morning: 'Science: Atomic Structure', evening: 'Chemistry Elements', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-01-17', morning: 'History: National Movement Timeline', evening: 'Chronology Practice', test: 'Weekend Study', subject: 'History', hours: 8.5 },
                { date: '2026-01-18', morning: 'Polity: Union Executive', evening: 'Executive MCQs', test: 'TEST 3: 75 MCQs', subject: 'Polity', hours: 8 },
                { date: '2026-01-19', morning: 'Polity: Parliament Basics', evening: 'Legislature MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-01-20', morning: 'History: Partition of Bengal 1905', evening: 'Swadeshi Movement MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-21', morning: 'Geography: Climate & Monsoon', evening: 'Monsoon patterns MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-01-22', morning: 'Economy: Agriculture Sector', evening: 'Green Revolution MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-01-23', morning: 'Science: Acids, Bases, Salts', evening: 'pH scale reactions', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-01-24', morning: 'Geography: Indian Map Comprehensive', evening: 'Map locations drill', test: 'Weekend Study', subject: 'Geography', hours: 8.5 },
                { date: '2026-01-25', morning: 'Economy: Full Economy Marathon', evening: 'Economy comprehensive MCQs', test: 'TEST 4: 75 MCQs', subject: 'Economy', hours: 8 },
                { date: '2026-01-26', morning: 'Republic Day: Constitution Deep Study', evening: 'Polity 100 MCQs marathon', test: 'Holiday', subject: 'Polity', hours: 6 },
                { date: '2026-01-27', morning: 'History: Home Rule, Lucknow Pact', evening: '1916-1919 MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-28', morning: 'Geography: Soils & Vegetation', evening: 'Forest types MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-01-29', morning: 'Economy: Industry & MSMEs', evening: 'Manufacturing policies MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-01-30', morning: 'Science: Biology - Cell & Tissues', evening: 'Cell structures MCQs', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-01-31', morning: 'Polity: Full Revision Marathon', evening: 'Polity final drill MCQs', test: 'TEST 5: 75 MCQs', subject: 'Polity', hours: 8.5 }
            ];

            const febData = [
                { date: '2026-02-01', morning: 'Environment: Ecology, Biodiversity', evening: 'Environment comp MCQs', test: 'TEST 6: 75 MCQs', subject: 'Environment', hours: 8 },
                { date: '2026-02-02', morning: 'Polity: Judiciary - SC & High Courts', evening: 'Judicial cases MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-02-03', morning: 'History: Non-Cooperation Movement', evening: 'Gandhi era drill MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-02-04', morning: 'Geography: Minerals & Energy', evening: 'Resource maps MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-02-05', morning: 'Economy: Planning & NITI Aayog', evening: 'Plan objectives MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-02-06', morning: 'Science: Human Body Systems', evening: 'Human diseases MCQs', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-02-07', morning: 'History: 1857-1947 Final Chronology', evening: 'Timeline marathon drill', test: 'TEST 7: 75 MCQs', subject: 'History', hours: 8.5 },
                { date: '2026-02-08', morning: 'Polity + Geography Integration', evening: 'Combined mock MCQs', test: 'TEST 8: 75 MCQs', subject: 'Polity', hours: 8 },
                { date: '2026-02-09', morning: 'Polity: Local Government (73rd/74th)', evening: 'Panchayat MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-02-10', morning: 'History: Civil Disobedience', evening: 'Dandi March MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-02-11', morning: 'Geography WB: Physical Features', evening: 'WB district maps MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-02-12', morning: 'Economy: Govt Schemes Review', evening: 'Central/State welfare MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-02-13', morning: 'Science: Environment Pollution', evening: 'Climate treaties MCQs', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-02-14', morning: 'Mixed Revision: All Weak Areas', evening: 'Problem topic intensive', test: 'TEST 9: 75 MCQs', subject: 'General', hours: 8.5 },
                { date: '2026-02-15', morning: 'Full Science Revision Marathon', evening: 'Science comprehensive MCQs', test: 'TEST 10: 100 MCQs', subject: 'Science', hours: 8 },
                { date: '2026-02-16', morning: 'Polity: Emergency Provisions', evening: 'Emergency history MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-02-17', morning: 'History: Quit India & INA', evening: 'Final phase leaders MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-02-18', morning: 'Geography WB: Economy & Industry', evening: 'WB agriculture MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-02-19', morning: 'Reasoning: Logical Patterns', evening: 'Reasoning speed practice', test: '-', subject: 'General', hours: 3.75 },
                { date: '2026-02-20', morning: 'Quant: Perc, Ratio, Shortcuts', evening: 'Speed math MCQs', test: '-', subject: 'General', hours: 3.75 },
                { date: '2026-02-21', morning: 'Complete GS Syllabus Revision', evening: 'Full mock test simulation', test: 'TEST 11: 100 MCQs', subject: 'General', hours: 8.5 },
                { date: '2026-02-22', morning: 'Current Affairs: Jan-Feb 2026', evening: 'Recent events mock MCQs', test: 'TEST 12: 100 MCQs', subject: 'Current Affairs', hours: 8 },
                { date: '2026-02-23', morning: 'English Basics & Vocabulary', evening: 'English comp MCQs', test: '-', subject: 'General', hours: 3 },
                { date: '2026-02-24', morning: 'Formulas & Facts Final Look', evening: 'Quick recall MCQs', test: '-', subject: 'General', hours: 2.5 },
                { date: '2026-02-25', morning: 'Timeline & Events Final Review', evening: 'Chronology final check', test: '-', subject: 'History', hours: 2.5 },
                { date: '2026-02-26', morning: 'Maps & Diagrams Final Review', evening: 'Visual memory drill', test: '-', subject: 'Geography', hours: 2.5 },
                { date: '2026-02-27', morning: 'Error Log Final Revision', evening: 'Mistake pattern analysis', test: '-', subject: 'General', hours: 2 },
                { date: '2026-02-28', morning: 'Rest & Mental Relaxation', evening: 'Final simulation mock', test: 'FULL MOCK: 200 MCQs', subject: 'General', hours: 3 }
            ];

            const marData = [
                { date: '2026-03-01', morning: 'Full Revision: Polity Weak Areas', evening: 'Polity Marathon', test: '-', subject: 'Polity', hours: 6 },
                { date: '2026-03-02', morning: 'Full Revision: History Weak Areas', evening: 'History Marathon', test: '-', subject: 'History', hours: 6 },
                { date: '2026-03-03', morning: 'Full Revision: Geography Weak Areas', evening: 'Geography Marathon', test: '-', subject: 'Geography', hours: 6 },
                { date: '2026-03-04', morning: 'Full Revision: Economy Weak Areas', evening: 'Economy Marathon', test: '-', subject: 'Economy', hours: 6 },
                { date: '2026-03-05', morning: 'Full Revision: Science Weak Areas', evening: 'Science Marathon', test: '-', subject: 'Science', hours: 6 },
                { date: '2026-03-06', morning: 'Current Affairs: Complete Review', evening: 'CA Final Drill', test: '-', subject: 'Current Affairs', hours: 6 },
                { date: '2026-03-07', morning: 'Mock Test Simulation', evening: 'Error Analysis', test: 'TEST 13: FULL MOCK', subject: 'General', hours: 8 },
                { date: '2026-03-08', morning: 'Mock Test Simulation', evening: 'Error Analysis', test: 'TEST 14: FULL MOCK', subject: 'General', hours: 8 },
                { date: '2026-03-09', morning: 'Rapid Revision: All Subjects', evening: 'Quick Facts Review', test: '-', subject: 'General', hours: 6 },
                { date: '2026-03-10', morning: 'Rapid Revision: All Subjects', evening: 'Quick Facts Review', test: '-', subject: 'General', hours: 6 },
                { date: '2026-03-11', morning: 'Focus: Constitution & Amendments', evening: 'Polity Final MCQs', test: '-', subject: 'Polity', hours: 5 },
                { date: '2026-03-12', morning: 'Focus: Freedom Movement Timeline', evening: 'History Final MCQs', test: '-', subject: 'History', hours: 5 },
                { date: '2026-03-13', morning: 'Focus: Maps & Current Affairs', evening: 'Geography + CA MCQs', test: '-', subject: 'Geography', hours: 5 },
                { date: '2026-03-14', morning: 'Final Mock Test', evening: 'Complete Review', test: 'TEST 15: FINAL MOCK', subject: 'General', hours: 8 },
                { date: '2026-03-15', morning: 'Light Revision Only', evening: 'Rest', test: '-', subject: 'General', hours: 3 },
                { date: '2026-03-16', morning: 'Formula Sheet Review', evening: 'Quick Facts', test: '-', subject: 'General', hours: 3 },
                { date: '2026-03-17', morning: 'Current Affairs: Last Week', evening: 'Light Reading', test: '-', subject: 'Current Affairs', hours: 3 },
                { date: '2026-03-18', morning: 'Exam Prep: Admit Card, Center', evening: 'Mental Relaxation', test: 'Preparation Day', subject: 'General', hours: 2 },
                { date: '2026-03-19', morning: 'Complete Rest', evening: 'Early Sleep', test: 'Rest Day', subject: 'General', hours: 1 },
                { date: '2026-03-20', morning: 'WBCS PRELIMINARY EXAM 2026', evening: 'Self Reflection', test: 'D-DAY', subject: 'General', hours: 10 }
            ];

            [...janData, ...febData, ...marData].forEach((t, i) => {
                tasks.push({ ...t, id: `task-${i}` });
            });

            return tasks;
        }

        function getDefaultTests() {
            return [
                { id: 'test-1', number: 1, date: '2026-01-04', type: 'Subject', mcqs: 50, focus: 'Polity + History', target: 40 },
                { id: 'test-2', number: 2, date: '2026-01-11', type: 'Subject', mcqs: 50, focus: 'Geography + Economy', target: 40 },
                { id: 'test-3', number: 3, date: '2026-01-18', type: 'Mixed', mcqs: 75, focus: 'GS Comprehensive', target: 60 },
                { id: 'test-4', number: 4, date: '2026-01-25', type: 'Mixed', mcqs: 75, focus: 'All Subjects', target: 60 },
                { id: 'test-5', number: 5, date: '2026-01-31', type: 'Mixed', mcqs: 75, focus: 'Polity Heavy', target: 60 },
                { id: 'test-6', number: 6, date: '2026-02-01', type: 'Subject', mcqs: 75, focus: 'Environment', target: 60 },
                { id: 'test-7', number: 7, date: '2026-02-07', type: 'Mixed', mcqs: 75, focus: 'History Focus', target: 60 },
                { id: 'test-8', number: 8, date: '2026-02-08', type: 'Mixed', mcqs: 75, focus: 'Polity + Geo', target: 60 },
                { id: 'test-9', number: 9, date: '2026-02-14', type: 'Mixed', mcqs: 75, focus: 'Weak Areas', target: 60 },
                { id: 'test-10', number: 10, date: '2026-02-15', type: 'Full', mcqs: 100, focus: 'Science Focus', target: 80 },
                { id: 'test-11', number: 11, date: '2026-02-21', type: 'Full', mcqs: 100, focus: 'Complete GS', target: 80 },
                { id: 'test-12', number: 12, date: '2026-02-22', type: 'Full', mcqs: 100, focus: 'Current Affairs', target: 80 },
                { id: 'test-13', number: 13, date: '2026-03-07', type: 'Full Mock', mcqs: 200, focus: 'Exam Simulation', target: 160 },
                { id: 'test-14', number: 14, date: '2026-03-08', type: 'Full Mock', mcqs: 200, focus: 'Exam Simulation', target: 160 },
                { id: 'test-15', number: 15, date: '2026-03-14', type: 'Final Mock', mcqs: 200, focus: 'Final Simulation', target: 170 }
            ];
        }

        function getDefaultRoutines() {
            return {
                weekday: [
                    { time: '05:30 - 06:00', activity: 'Wake Up & Freshen', details: 'Morning routine, light exercise', duration: '30 min' },
                    { time: '06:00 - 08:00', activity: 'Morning Study Block', details: 'Theory reading - Primary subject', duration: '2 hrs' },
                    { time: '08:00 - 09:00', activity: 'Breakfast & Break', details: 'News reading, current affairs', duration: '1 hr' },
                    { time: '09:00 - 18:00', activity: 'Office/Work', details: 'Professional commitments', duration: '9 hrs' },
                    { time: '18:00 - 19:00', activity: 'Evening Break', details: 'Rest, snacks, light walk', duration: '1 hr' },
                    { time: '19:00 - 21:00', activity: 'Evening Study Block', details: 'MCQ practice, revision', duration: '2 hrs' },
                    { time: '21:00 - 22:00', activity: 'Dinner & Relaxation', details: 'Light reading, family time', duration: '1 hr' },
                    { time: '22:00 - 22:30', activity: 'Quick Revision', details: 'Day recap, next day planning', duration: '30 min' }
                ],
                saturday: [
                    { time: '06:00 - 08:00', activity: 'Morning Theory', details: 'Subject deep dive', duration: '2 hrs' },
                    { time: '08:00 - 09:00', activity: 'Breakfast', details: 'Current affairs reading', duration: '1 hr' },
                    { time: '09:00 - 12:00', activity: 'Intensive Study', details: 'Primary subject completion', duration: '3 hrs' },
                    { time: '12:00 - 14:00', activity: 'Lunch & Break', details: 'Rest and refresh', duration: '2 hrs' },
                    { time: '14:00 - 17:00', activity: 'MCQ Practice', details: 'Subject-wise practice', duration: '3 hrs' },
                    { time: '17:00 - 19:00', activity: 'Revision', details: 'Week summary revision', duration: '2 hrs' },
                    { time: '19:00 onwards', activity: 'Free Time', details: 'Relaxation, light study', duration: '~' }
                ],
                sunday: [
                    { time: '07:00 - 09:00', activity: 'Light Morning Study', details: 'Weak area focus', duration: '2 hrs' },
                    { time: '09:00 - 11:00', activity: 'Mock Test', details: 'Weekly assessment', duration: '2 hrs' },
                    { time: '11:00 - 13:00', activity: 'Test Analysis', details: 'Error log, learning', duration: '2 hrs' },
                    { time: '13:00 - 16:00', activity: 'Break & Lunch', details: 'Complete rest', duration: '3 hrs' },
                    { time: '16:00 - 18:00', activity: 'Next Week Planning', details: 'Schedule preparation', duration: '2 hrs' },
                    { time: '18:00 onwards', activity: 'Family/Recreation', details: 'Mental refresh', duration: '~' }
                ]
            };
        }

        // =============================================
        // APP INITIALIZATION
        // =============================================
        async function initializeApp() {
            await loadAppData();

            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            document.getElementById('userEmailDisplay').textContent = 'üë§ ' + currentUser.email;
            document.getElementById('sidebarUserEmail').textContent = currentUser.email;

            if (currentUser.isAdmin) {
                document.getElementById('adminMenuSection').classList.remove('hidden');
            }

            if (appData.userProgress.darkMode) {
                document.body.classList.add('dark-mode');
            }

            document.getElementById('globalNotes').value = appData.userProgress.notes || '';

            renderAll();
            showToast('Welcome back, ' + (currentUser.name || 'Friend') + '!', 'success');
        }

        // =============================================
        // RENDERING FUNCTIONS
        // =============================================
        function renderAll() {
            renderDashboard();
            renderRoutines();
            renderMonthlySchedules();
            renderSubjects();
            renderTests();
            renderAnalytics();
            if (activeSubject) renderSubjectViewTable();
            if (currentUser.isAdmin) renderAdminPanel();
            setActiveTab(activeTabId, true);
        }

        function renderDashboard() {
            const tasks = appData.tasks;
            const completed = Object.keys(appData.userProgress.completedTasks).filter(k => appData.userProgress.completedTasks[k]).length;
            const progress = tasks.length ? Math.round((completed / tasks.length) * 100) : 0;

            document.getElementById('statProgress').textContent = progress + '%';
            document.getElementById('progressBar').style.width = progress + '%';

            const examDate = new Date('2026-03-20T00:00:00');
            const today = new Date();
            const daysLeft = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
            document.getElementById('statDays').textContent = Math.max(0, daysLeft);

            let totalHours = 0;
            tasks.forEach(t => {
                if (appData.userProgress.completedTasks[t.id]) totalHours += t.hours || 0;
            });
            document.getElementById('statHours').textContent = totalHours.toFixed(1) + 'h';

            document.getElementById('statStreak').textContent = calculateStreak() + ' days';

            const cardsHtml = appData.subjects.map(s => {
                const { completed: subjectCompleted, total: subjectTotal, pct: subjectProgress } = getSubjectProgress(s);
                const pal = getProgressPalette(subjectProgress);

                return `
                    <div onclick="viewSubject('${s}')" class="glass bouncy-card rounded-3xl p-5 cursor-pointer hover:shadow-lg transition border-l-4" style="border-left-color: ${pal.border};">
                        <div class="flex items-start justify-between gap-3">
                            <h4 class="font-extrabold text-lg md:text-xl" style="color: ${pal.text};">${s}</h4>
                            <span class="px-2 py-1 rounded-xl text-[11px] font-extrabold" style="background: ${pal.pillBg}; border: 1px solid ${pal.pillBorder}; color: ${pal.text};">
                                ${subjectProgress}%
                            </span>
                        </div>
                        <div class="text-sm" style="color: ${pal.mutedText};">${subjectCompleted}/${subjectTotal} topics</div>
                        <div class="h-2 bg-white/70 rounded-full mt-3 overflow-hidden">
                            <div class="h-full" style="width: ${subjectProgress}%; background: ${pal.bar};"></div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('subjectCards').innerHTML = cardsHtml;
        }

        function calculateStreak() {
            const completedDates = new Set();
            appData.tasks.forEach(t => {
                if (appData.userProgress.completedTasks[t.id]) completedDates.add(getEffectiveTaskDate(t));
            });

            let streak = 0;
            let checkDate = new Date();
            checkDate.setHours(0, 0, 0, 0);

            let dateStr = toLocalISODate(checkDate);
            if (!completedDates.has(dateStr)) checkDate.setDate(checkDate.getDate() - 1);

            while (true) {
                dateStr = toLocalISODate(checkDate);
                if (completedDates.has(dateStr)) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else break;
                if (streak > 365) break;
            }
            return streak;
        }

        function renderRoutines() {
            const renderTable = (data, tableId) => {
                document.getElementById(tableId).innerHTML = data.map(r => `
                    <tr class="border-b border-black/5 table-row-hover">
                        <td class="p-3 font-bold">${r.time}</td>
                        <td class="p-3">${r.activity}</td>
                        <td class="p-3 text-slate-600">${r.details}</td>
                        <td class="p-3">${r.duration}</td>
                    </tr>
                `).join('');
            };

            renderTable(appData.routines.weekday, 'weekdayTable');
            renderTable(appData.routines.saturday, 'saturdayTable');
            renderTable(appData.routines.sunday, 'sundayTable');
        }

        function renderMonthlySchedules() {
            const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            let menuHtml = '';
            let tabsHtml = '';

            months.forEach((month, idx) => {
                const monthNum = String(idx + 1).padStart(2, '0');
                const monthTasks = appData.tasks
                    .filter(t => (getEffectiveTaskDate(t) || '').split('-')[1] === monthNum)
                    .slice()
                    .sort((a, b) => getEffectiveTaskDate(a).localeCompare(getEffectiveTaskDate(b)));

                if (monthTasks.length > 0) {
                    menuHtml += `<div class="sidebar-subitem text-slate-200/90 cursor-pointer hover:bg-white/10 text-sm" onclick="switchTab('${month}')">${monthNames[idx]} 2026</div>`;

                    tabsHtml += `
                        <div id="tab-${month}" class="tab-content">
                            <div class="flex items-center justify-between gap-3 mb-4">
                                <h2 class="text-2xl font-extrabold text-slate-800">üìÜ ${monthNames[idx]} 2026</h2>
                                <div class="text-xs text-slate-500">Edit dates to reschedule tasks (saved per-user)</div>
                            </div>
                            <div class="glass no-hover-card rounded-3xl overflow-x-auto">
                                <table class="w-full">
                                    <thead class="text-white" style="background: linear-gradient(135deg, var(--primary), var(--primary-2));">
                                        <tr>
                                            <th class="p-3 text-left">Date</th>
                                            <th class="p-3 text-left">Day</th>
                                            <th class="p-3 text-left">Morning</th>
                                            <th class="p-3 text-left">Evening</th>
                                            <th class="p-3 text-left">Test</th>
                                            <th class="p-3 text-left">Subject</th>
                                            <th class="p-3 text-left">Hrs</th>
                                            <th class="p-3 text-left">‚úì</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${monthTasks.map(t => {
                                            const isCompleted = appData.userProgress.completedTasks[t.id];
                                            const effDate = getEffectiveTaskDate(t);
                                            const displayDate = formatDate(effDate);
                                            const dayName = getDayName(effDate);
                                            const highlightClass = getTaskRowHighlightClass(effDate, isCompleted);
                                            const pal = getSubjectProgressPalette(t.subject);
                                            return `
                                                <tr class="${highlightClass} ${isCompleted ? 'completed-row' : ''} border-b border-black/5 table-row-hover">
                                                    <td class="p-3">
                                                        <div class="date-chip bounceable">${displayDate} ‚Ä¢ ${dayName}</div>
                                                        <div class="mt-2">
                                                            <input type="date" value="${effDate}" onchange="updateTaskDate('${t.id}', this.value)" class="input-mini bg-white/70">
                                                        </div>
                                                    </td>
                                                    <td class="p-3 font-bold">${dayName}</td>
                                                    <td class="p-3"><span class="hover-bounce" style="color: ${pal.text};">${t.morning}</span></td>
                                                    <td class="p-3"><span class="hover-bounce" style="color: ${pal.mutedText};">${t.evening}</span></td>
                                                    <td class="p-3">${t.test}</td>
                                                    <td class="p-3">
                                                        <span class="px-2 py-1 rounded-xl text-xs font-bold" style="background: ${pal.pillBg}; color: ${pal.text}; border: 1px solid ${pal.pillBorder};">
                                                            ${t.subject}
                                                        </span>
                                                    </td>
                                                    <td class="p-3 font-bold">${t.hours}</td>
                                                    <td class="p-3">
                                                        <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleTask('${t.id}')" class="w-5 h-5 accent-indigo-500 cursor-pointer">
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            });

            document.getElementById('monthMenu').innerHTML = menuHtml;
            document.getElementById('monthlyTabs').innerHTML = tabsHtml;
        }

        function renderSubjects() {
            const menuHtml = appData.subjects.map(s => `
                <div class="sidebar-subitem text-slate-200/90 cursor-pointer hover:bg-white/10 text-sm" onclick="viewSubject('${s}')">üìö ${s}</div>
            `).join('');
            document.getElementById('subjectMenuList').innerHTML = menuHtml;
        }

        function getAllTestsMerged() {
            const blueprint = (appData.tests || []).map(t => ({ ...t, origin: 'blueprint' }));
            const personal = (appData.userProgress.customTests || []).map(t => ({ ...t, origin: 'personal' }));
            return [...blueprint, ...personal];
        }

        function renderTests() {
            const tests = getAllTestsMerged()
                .slice()
                .sort((a, b) => (getEffectiveTestDate(a) || '').localeCompare(getEffectiveTestDate(b) || '') || ((a.number || 0) - (b.number || 0)));

            const html = tests.map(t => {
                const score = appData.userProgress.testScores[t.id];
                const percentage = (score !== undefined && score !== null && Number.isFinite(Number(score))) ? Math.round((Number(score) / t.mcqs) * 100) : null;
                const status = (percentage === null)
                    ? '‚è≥ Pending'
                    : (percentage >= 80 ? '‚úÖ Excellent' : percentage >= 60 ? 'üëç Good' : '‚ö†Ô∏è Improve');

                const effDate = getEffectiveTestDate(t);
                const badge = t.origin === 'personal'
                    ? `<span class="ml-2 px-2 py-1 rounded-xl text-[11px] font-extrabold" style="background: rgba(34,197,94,0.14); border: 1px solid rgba(34,197,94,0.18); color: rgb(21,128,61);">Personal</span>`
                    : `<span class="ml-2 px-2 py-1 rounded-xl text-[11px] font-extrabold" style="background: rgba(99,102,241,0.12); border: 1px solid rgba(99,102,241,0.18); color: rgb(79,70,229);">Blueprint</span>`;

                const pctText = percentage === null ? '-' : `${percentage}%`;
                const pctClass = percentage === null ? '' : (percentage >= 80 ? 'text-emerald-600' : percentage >= 60 ? 'text-amber-600' : 'text-rose-600');

                const actions = t.origin === 'personal'
                    ? `<button onclick="deletePersonalTest('${t.id}')" class="px-3 py-1.5 rounded-2xl text-white font-extrabold text-xs btn-glow" style="background: linear-gradient(135deg, #ef4444, #f43f5e);">üóëÔ∏è Delete</button>`
                    : `<span class="text-xs text-slate-500">‚Äî</span>`;

                return `
                    <tr class="border-b border-black/5 table-row-hover">
                        <td class="p-3 font-extrabold">Test ${t.number || ''} ${badge}</td>
                        <td class="p-3">
                            <div class="date-chip">${formatDate(effDate)}</div>
                            <div class="mt-2">
                                <input type="date" value="${effDate || ''}" onchange="updateTestDate('${t.id}', this.value)" class="input-mini bg-white/70">
                            </div>
                        </td>
                        <td class="p-3 font-bold">${t.type}</td>
                        <td class="p-3">${t.mcqs}</td>
                        <td class="p-3">${t.focus || '-'}</td>
                        <td class="p-3 font-bold">${t.target ?? '-'}</td>
                        <td class="p-3">
                            <input type="number" value="${score ?? ''}" placeholder="Score" min="0" max="${t.mcqs}" 
                                onchange="updateTestScore('${t.id}', this.value)"
                                class="w-24 px-3 py-2 border rounded-2xl text-center bg-white/70">
                        </td>
                        <td class="p-3 font-extrabold ${pctClass}">${pctText}</td>
                        <td class="p-3">${status}</td>
                        <td class="p-3">${actions}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('testsTable').innerHTML = html || `
                <tr><td class="p-4 text-slate-500" colspan="10">No tests found. Click ‚ÄúAdd Personal Test‚Äù.</td></tr>
            `;
        }

        function renderAnalytics() {
            const analyticsHtml = appData.subjects.map(s => {
                const subjectTasks = appData.tasks.filter(t => t.subject === s);
                const completed = subjectTasks.filter(t => appData.userProgress.completedTasks[t.id]).length;
                const progress = subjectTasks.length ? Math.round((completed / subjectTasks.length) * 100) : 0;
                const hours = subjectTasks
                    .filter(t => appData.userProgress.completedTasks[t.id])
                    .reduce((sum, t) => sum + (t.hours || 0), 0);
                return `
                    <div class="flex items-center justify-between py-3 border-b border-black/5">
                        <div>
                            <div class="font-extrabold">${s}</div>
                            <div class="text-sm text-slate-600">${completed}/${subjectTasks.length} topics ‚Ä¢ ${hours.toFixed(1)}h</div>
                        </div>
                        <div class="w-32">
                            <div class="text-right text-sm font-extrabold text-indigo-600 mb-1">${progress}%</div>
                            <div class="h-2 bg-white/70 rounded-full overflow-hidden">
                                <div class="h-full" style="width: ${progress}%; background: linear-gradient(90deg, var(--primary), var(--primary-2));"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('subjectAnalytics').innerHTML = analyticsHtml;

            const weeklyData = [4, 6, 3, 5, 8, 7, 2];
            const weeklyHtml = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((day, i) => `
                <div class="flex-1 flex flex-col items-center">
                    <div class="rounded-t-2xl w-full" style="height: ${weeklyData[i] * 15}px; background: linear-gradient(180deg, var(--primary), var(--primary-2));"></div>
                    <div class="text-xs text-slate-500 mt-2 font-bold">${day}</div>
                </div>
            `).join('');
            document.getElementById('weeklyChart').innerHTML = weeklyHtml;
        }

        function renderAdminPanel() {
            const subjectListHtml = appData.subjects.map(s => `
                <div class="flex items-center justify-between bg-white/50 px-3 py-2 rounded-2xl border border-white/60">
                    <span class="font-bold">${s}</span>
                    <button onclick="adminDeleteSubject('${s}')" class="text-rose-500 hover:text-rose-700">üóëÔ∏è</button>
                </div>
            `).join('');
            document.getElementById('adminSubjectList').innerHTML = subjectListHtml;

            const testsHtml = appData.tests.length ? `
                <table class="w-full">
                    <thead class="bg-white/60">
                        <tr>
                            <th class="p-2 text-left">#</th>
                            <th class="p-2 text-left">Date</th>
                            <th class="p-2 text-left">Type</th>
                            <th class="p-2 text-left">MCQs</th>
                            <th class="p-2 text-left">Focus</th>
                            <th class="p-2 text-left">Target</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appData.tests
                            .slice()
                            .sort((a, b) => a.number - b.number)
                            .map(t => `
                            <tr class="border-b border-black/5 table-row-hover">
                                <td class="p-2 font-extrabold">${t.number}</td>
                                <td class="p-2">
                                    <input type="date" class="px-3 py-2 border rounded-2xl text-xs w-40 bg-white/70" value="${t.date}" onchange="adminUpdateTestDate('${t.id}', this.value)">
                                    <div class="text-xs text-slate-500 mt-1">${formatDate(t.date)}</div>
                                </td>
                                <td class="p-2">${t.type}</td>
                                <td class="p-2">${t.mcqs}</td>
                                <td class="p-2">${t.focus}</td>
                                <td class="p-2">${t.target}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p class="text-slate-500 text-center py-8">No tests configured.</p>';

            const adminTestsListEl = document.getElementById('adminTestsList');
            if (adminTestsListEl) adminTestsListEl.innerHTML = testsHtml;
        }

        // =============================================
        // SUBJECT VIEW RENDER
        // =============================================
        function renderSubjectViewTable() {
            if (!activeSubject) return;
            const palHead = getSubjectProgressPalette(activeSubject);
            const titleEl = document.getElementById('subjectViewTitle');
            titleEl.textContent = 'üìö ' + activeSubject;
            titleEl.style.color = palHead.text;

            const subjectTasks = appData.tasks
                .filter(t => t.subject === activeSubject)
                .slice()
                .sort((a, b) => getEffectiveTaskDate(a).localeCompare(getEffectiveTaskDate(b)));

            const html = subjectTasks.map(t => {
                const isCompleted = appData.userProgress.completedTasks[t.id];
                const effDate = getEffectiveTaskDate(t);
                const dayName = getDayName(effDate);
                const highlightClass = getTaskRowHighlightClass(effDate, isCompleted);
                const pal = getSubjectProgressPalette(activeSubject);
                return `
                    <tr class="${highlightClass} ${isCompleted ? 'completed-row' : ''} border-b border-black/5 table-row-hover">
                        <td class="p-3">
                            <div class="font-extrabold hover-bounce" style="color: ${pal.text};">${t.morning}</div>
                            <div class="text-sm hover-bounce" style="color: ${pal.mutedText};">${t.evening}</div>
                        </td>
                        <td class="p-3">
                            <div class="date-chip bounceable">${formatDate(effDate)} ‚Ä¢ ${dayName}</div>
                            <div class="mt-2">
                                <input type="date" value="${effDate}" onchange="updateTaskDate('${t.id}', this.value)" class="input-mini bg-white/70">
                            </div>
                        </td>
                        <td class="p-3 font-bold">${dayName}</td>
                        <td class="p-3 font-bold">${t.hours}h</td>
                        <td class="p-3">
                            <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleTask('${t.id}')" class="w-5 h-5 accent-indigo-500 cursor-pointer">
                        </td>
                        <td class="p-3">
                            <button onclick="editTask('${t.id}')" class="text-indigo-600 hover:text-indigo-800 font-bold mr-2">‚úèÔ∏è</button>
                            <button onclick="deleteTask('${t.id}')" class="text-rose-500 hover:text-rose-700 font-bold">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('subjectTopicsTable').innerHTML = html || `
                <tr><td class="p-3 text-slate-500" colspan="6">No tasks found for ${activeSubject}. Add a topic to start tracking.</td></tr>
            `;
        }

        // =============================================
        // UI INTERACTIONS
        // =============================================
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function toggleSubmenu(id) {
            const menu = document.getElementById(id);
            const arrow = document.getElementById(id + 'Arrow');
            menu.classList.toggle('hidden');
            arrow.textContent = menu.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
        }

        function setActiveTab(tabId, silent = false) {
            const target = document.getElementById('tab-' + tabId);
            const fallback = document.getElementById('tab-overview');

            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            if (target) {
                target.classList.add('active');
                activeTabId = tabId;
            } else {
                fallback?.classList.add('active');
                activeTabId = 'overview';
            }

            if (!silent) toggleSidebar();
        }

        function switchTab(tabId) {
            setActiveTab(tabId, false);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            appData.userProgress.darkMode = document.body.classList.contains('dark-mode');
            saveProgress();
        }

        // =============================================
        // TASK OPERATIONS
        // =============================================
        function toggleTask(taskId) {
            appData.userProgress.completedTasks[taskId] = !appData.userProgress.completedTasks[taskId];
            saveProgress();
            renderAll();
        }

        function updateTestScore(testId, score) {
            const n = parseInt(score);
            appData.userProgress.testScores[testId] = Number.isFinite(n) ? n : null;
            saveProgress();
            renderAll();
        }

        // =============================================
        // PERSONAL TESTS (per-user)
        // =============================================
        function getNextTestNumber() {
            const all = getAllTestsMerged();
            const maxN = all.reduce((m, t) => Math.max(m, Number(t.number) || 0), 0);
            return maxN + 1;
        }

        function updatePersonalTestTypeUI() {
            const typeEl = document.getElementById('personalTestType');
            const subjectWrap = document.getElementById('personalSubjectWrap');
            const subjectEl = document.getElementById('personalSubject');
            const focusEl = document.getElementById('personalFocus');
            const mcqsEl = document.getElementById('personalTestMcqs');
            const targetEl = document.getElementById('personalTestTarget');

            if (!typeEl || !subjectWrap || !subjectEl || !focusEl || !mcqsEl || !targetEl) return;

            const type = typeEl.value;
            const isSubject = type === 'Subject';
            subjectWrap.classList.toggle('hidden', !isSubject);

            // Smart defaults (only if user hasn't already typed custom values)
            const mcqsWasEmpty = !mcqsEl.dataset.userEdited;
            const targetWasEmpty = !targetEl.dataset.userEdited;

            const defaults = {
                'Subject': { mcqs: 75, target: 60 },
                'Mixed': { mcqs: 75, target: 60 },
                'Full': { mcqs: 100, target: 80 },
                'Full Mock': { mcqs: 200, target: 160 },
                'Final Mock': { mcqs: 200, target: 170 }
            };

            const d = defaults[type] || defaults['Mixed'];
            if (mcqsWasEmpty) mcqsEl.value = d.mcqs;
            if (targetWasEmpty) targetEl.value = d.target;

            if (isSubject) {
                const subj = subjectEl.value;
                if (!focusEl.value) focusEl.value = `${subj} - Subject Test`;
            }
        }

        function openAddPersonalTestModal() {
            const nextNum = getNextTestNumber();
            const todayISO = toLocalISODate(new Date());

            openModal('‚ûï Add Personal Test', `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block font-extrabold mb-2 text-slate-700">Test Number</label>
                            <input type="number" id="personalTestNumber" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${nextNum}">
                        </div>
                        <div>
                            <label class="block font-extrabold mb-2 text-slate-700">Date</label>
                            <input type="date" id="personalTestDate" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${todayISO}">
                        </div>
                    </div>

                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Type</label>
                        <select id="personalTestType" class="w-full px-4 py-3 border rounded-2xl bg-white/70" onchange="updatePersonalTestTypeUI()">
                            <option>Subject</option>
                            <option>Mixed</option>
                            <option>Full</option>
                            <option>Full Mock</option>
                            <option>Final Mock</option>
                        </select>
                    </div>

                    <div id="personalSubjectWrap">
                        <label class="block font-extrabold mb-2 text-slate-700">Subject</label>
                        <select id="personalSubject" class="w-full px-4 py-3 border rounded-2xl bg-white/70" onchange="updatePersonalTestTypeUI()">
                            ${(appData.subjects || []).map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block font-extrabold mb-2 text-slate-700">MCQs</label>
                            <input type="number" id="personalTestMcqs" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="75" min="1" oninput="this.dataset.userEdited='1'">
                        </div>
                        <div>
                            <label class="block font-extrabold mb-2 text-slate-700">Target Score</label>
                            <input type="number" id="personalTestTarget" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="60" min="0" oninput="this.dataset.userEdited='1'">
                        </div>
                    </div>

                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Focus / Notes</label>
                        <input type="text" id="personalFocus" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="e.g., Polity (FR + DPSP) + 50 MCQs">
                    </div>

                    <div class="text-xs text-slate-500">
                        Personal tests are saved only for your account and synced to MongoDB under <code>userProgress.customTests</code>.
                    </div>
                </div>
            `, () => {
                const id = 'ptest-' + Date.now();
                const number = parseInt(document.getElementById('personalTestNumber').value) || getNextTestNumber();
                const date = document.getElementById('personalTestDate').value;
                const type = document.getElementById('personalTestType').value;
                const mcqs = parseInt(document.getElementById('personalTestMcqs').value) || 75;
                const target = parseInt(document.getElementById('personalTestTarget').value) || 0;
                const focus = (document.getElementById('personalFocus').value || '').trim();

                let finalFocus = focus;
                if (!finalFocus && type === 'Subject') {
                    const subj = document.getElementById('personalSubject').value;
                    finalFocus = `${subj} - Subject Test`;
                }

                appData.userProgress.customTests ||= [];
                appData.userProgress.customTests.push({
                    id,
                    number,
                    date,
                    type,
                    mcqs,
                    focus: finalFocus,
                    target
                });

                saveProgress();
                renderAll();
                showToast('Personal test added!', 'success');
            });

            setTimeout(updatePersonalTestTypeUI, 0);
        }

        function deletePersonalTest(testId) {
            if (!confirm('Delete this personal test?')) return;
            appData.userProgress.customTests = (appData.userProgress.customTests || []).filter(t => t.id !== testId);
            if (appData.userProgress.testScores) delete appData.userProgress.testScores[testId];
            if (appData.userProgress.customTestDates) delete appData.userProgress.customTestDates[testId];
            saveProgress();
            renderAll();
            showToast('Personal test removed', 'info');
        }

        // =============================================
        // SUBJECT OPERATIONS
        // =============================================
        function viewSubject(name) {
            activeSubject = name;
            renderSubjectViewTable();
            setActiveTab('subject-view');
        }

        function createNewSubject() {
            openModal('Add New Subject', `
                <div class="mb-2">
                    <label class="block font-extrabold mb-2 text-slate-700">Subject Name</label>
                    <input type="text" id="newSubjectName" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="e.g., Physics">
                </div>
            `, () => {
                const name = document.getElementById('newSubjectName').value.trim();
                if (name && !appData.subjects.includes(name)) {
                    appData.subjects.push(name);
                    saveAppData();
                    saveProgress();
                    renderAll();
                    showToast('Subject added!', 'success');
                }
            });
        }

        function deleteCurrentSubject() {
            if (!activeSubject) return;
            if (confirm(`Delete subject "${activeSubject}"? This won't delete tasks.`)) {
                appData.subjects = appData.subjects.filter(s => s !== activeSubject);
                saveAppData();
                activeSubject = null;
                renderAll();
                setActiveTab('overview');
                showToast('Subject deleted', 'info');
            }
        }

        function addTopicToSubject() {
            if (!activeSubject) return;
            openModal('Add Topic to ' + activeSubject, `
                <div class="space-y-4">
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Morning Topic</label>
                        <input type="text" id="topicMorning" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="Theory topic...">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Evening Practice</label>
                        <input type="text" id="topicEvening" class="w-full px-4 py-3 border rounded-2xl bg-white/70" placeholder="MCQs, practice...">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block font-extrabold mb-2 text-slate-700">Date</label>
                            <input type="date" id="topicDate" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${toLocalISODate(new Date())}">
                        </div>
                        <div>
                            <label class="block font-extrabold mb-2 text-slate-700">Hours</label>
                            <input type="number" id="topicHours" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="3" step="0.5">
                        </div>
                    </div>
                </div>
            `, () => {
                const newTask = {
                    id: 'task-' + Date.now(),
                    morning: document.getElementById('topicMorning').value,
                    evening: document.getElementById('topicEvening').value,
                    date: document.getElementById('topicDate').value,
                    hours: parseFloat(document.getElementById('topicHours').value) || 3,
                    subject: activeSubject,
                    test: '-'
                };
                appData.tasks.push(newTask);
                saveAppData();
                renderAll();
                setActiveTab('subject-view');
                showToast('Topic added!', 'success');
            });
        }

        // =============================================
        // ADMIN FUNCTIONS
        // =============================================
        function adminAddSubject() { createNewSubject(); }

        function adminDeleteSubject(name) {
            if (confirm(`Delete subject "${name}"?`)) {
                appData.subjects = appData.subjects.filter(s => s !== name);
                saveAppData();
                renderAll();
                showToast('Subject deleted', 'info');
            }
        }

        function loadAdminMonthTasks() {
            const month = document.getElementById('adminMonthSelect').value;
            const monthTasks = appData.tasks
                .filter(t => (t.date || '').split('-')[1] === month)
                .slice()
                .sort((a, b) => (a.date || '').localeCompare(b.date || ''));

            const html = monthTasks.length ? `
                <table class="w-full">
                    <thead class="bg-white/60">
                        <tr>
                            <th class="p-2 text-left">Date</th>
                            <th class="p-2 text-left">Morning</th>
                            <th class="p-2 text-left">Evening</th>
                            <th class="p-2 text-left">Subject</th>
                            <th class="p-2 text-left">Hours</th>
                            <th class="p-2 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${monthTasks.map(t => `
                            <tr class="border-b border-black/5 table-row-hover">
                                <td class="p-2">
                                    <input type="date" value="${t.date}" onchange="adminUpdateTaskDate('${t.id}', this.value)" class="px-3 py-2 border rounded-2xl text-xs w-40 bg-white/70">
                                    <div class="text-xs text-slate-500 mt-1">${formatDate(t.date)}</div>
                                </td>
                                <td class="p-2">${t.morning}</td>
                                <td class="p-2">${t.evening}</td>
                                <td class="p-2">${t.subject}</td>
                                <td class="p-2">${t.hours}</td>
                                <td class="p-2">
                                    <button onclick="editTask('${t.id}')" class="text-indigo-600 font-bold mr-2">‚úèÔ∏è</button>
                                    <button onclick="deleteTask('${t.id}')" class="text-rose-600 font-bold">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p class="text-slate-500 text-center py-8">No tasks for this month.</p>';

            document.getElementById('adminTasksList').innerHTML = html;
        }

        function adminAddTask() {
            const month = document.getElementById('adminMonthSelect').value;
            openModal('Add New Task', `
                <div class="space-y-4">
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Date</label>
                        <input type="date" id="taskDate" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="2026-${month}-01">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Morning Topic</label>
                        <input type="text" id="taskMorning" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Evening Practice</label>
                        <input type="text" id="taskEvening" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Test/Activity</label>
                        <input type="text" id="taskTest" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="-">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Subject</label>
                        <select id="taskSubject" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                            ${appData.subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Hours</label>
                        <input type="number" id="taskHours" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="3.75" step="0.25">
                    </div>
                </div>
            `, () => {
                const newTask = {
                    id: 'task-' + Date.now(),
                    date: document.getElementById('taskDate').value,
                    morning: document.getElementById('taskMorning').value,
                    evening: document.getElementById('taskEvening').value,
                    test: document.getElementById('taskTest').value,
                    subject: document.getElementById('taskSubject').value,
                    hours: parseFloat(document.getElementById('taskHours').value)
                };
                appData.tasks.push(newTask);
                saveAppData();
                loadAdminMonthTasks();
                renderAll();
                showToast('Task added!', 'success');
            });
        }

        function editTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;

            openModal('Edit Task', `
                <div class="space-y-4">
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Date</label>
                        <input type="date" id="editDate" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${task.date}">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Morning Topic</label>
                        <input type="text" id="editMorning" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${task.morning}">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Evening Practice</label>
                        <input type="text" id="editEvening" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${task.evening}">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Test/Activity</label>
                        <input type="text" id="editTest" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${task.test}">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Subject</label>
                        <select id="editSubject" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                            ${appData.subjects.map(s => `<option value="${s}" ${s === task.subject ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Hours</label>
                        <input type="number" id="editHours" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${task.hours}" step="0.25">
                    </div>
                </div>
            `, () => {
                task.date = document.getElementById('editDate').value;
                task.morning = document.getElementById('editMorning').value;
                task.evening = document.getElementById('editEvening').value;
                task.test = document.getElementById('editTest').value;
                task.subject = document.getElementById('editSubject').value;
                task.hours = parseFloat(document.getElementById('editHours').value);
                saveAppData();
                renderAll();
                showToast('Task updated!', 'success');
            });
        }

        function deleteTask(taskId) {
            if (confirm('Delete this task?')) {
                appData.tasks = appData.tasks.filter(t => t.id !== taskId);
                if (appData.userProgress?.completedTasks) delete appData.userProgress.completedTasks[taskId];
                if (appData.userProgress?.customDates) delete appData.userProgress.customDates[taskId];

                saveAppData();
                saveProgress();
                renderAll();
                showToast('Task deleted', 'info');
            }
        }

        function adminAddTest() {
            const nextNum = appData.tests.length + 1;
            openModal('Add New Test (Blueprint)', `
                <div class="space-y-4">
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Test Number</label>
                        <input type="number" id="testNumber" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="${nextNum}">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Date</label>
                        <input type="date" id="testDate" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Type</label>
                        <select id="testType" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                            <option>Subject</option>
                            <option>Mixed</option>
                            <option>Full</option>
                            <option>Full Mock</option>
                            <option>Final Mock</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">MCQs</label>
                        <input type="number" id="testMcqs" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="75">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Focus Area</label>
                        <input type="text" id="testFocus" class="w-full px-4 py-3 border rounded-2xl bg-white/70">
                    </div>
                    <div>
                        <label class="block font-extrabold mb-2 text-slate-700">Target Score</label>
                        <input type="number" id="testTarget" class="w-full px-4 py-3 border rounded-2xl bg-white/70" value="60">
                    </div>
                </div>
            `, () => {
                const newTest = {
                    id: 'test-' + Date.now(),
                    number: parseInt(document.getElementById('testNumber').value),
                    date: document.getElementById('testDate').value,
                    type: document.getElementById('testType').value,
                    mcqs: parseInt(document.getElementById('testMcqs').value),
                    focus: document.getElementById('testFocus').value,
                    target: parseInt(document.getElementById('testTarget').value)
                };
                appData.tests.push(newTest);
                appData.tests.sort((a, b) => a.number - b.number);
                saveAppData();
                renderAll();
                showToast('Blueprint test added!', 'success');
            });
        }

        function editRoutine(type) {
            const routine = appData.routines[type];
            const html = routine.map((r, i) => `
                <div class="border border-white/60 rounded-2xl p-3 mb-2 bg-white/40">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" value="${r.time}" placeholder="Time" class="routine-time px-3 py-2 border rounded-2xl bg-white/70" data-index="${i}">
                        <input type="text" value="${r.duration}" placeholder="Duration" class="routine-duration px-3 py-2 border rounded-2xl bg-white/70" data-index="${i}">
                    </div>
                    <input type="text" value="${r.activity}" placeholder="Activity" class="routine-activity w-full px-3 py-2 border rounded-2xl bg-white/70 mb-2" data-index="${i}">
                    <input type="text" value="${r.details}" placeholder="Details" class="routine-details w-full px-3 py-2 border rounded-2xl bg-white/70" data-index="${i}">
                </div>
            `).join('');

            openModal('Edit ' + type.charAt(0).toUpperCase() + type.slice(1) + ' Routine', html, () => {
                routine.forEach((r, i) => {
                    r.time = document.querySelector(`.routine-time[data-index="${i}"]`).value;
                    r.activity = document.querySelector(`.routine-activity[data-index="${i}"]`).value;
                    r.details = document.querySelector(`.routine-details[data-index="${i}"]`).value;
                    r.duration = document.querySelector(`.routine-duration[data-index="${i}"]`).value;
                });
                saveAppData();
                renderRoutines();
                showToast('Routine updated!', 'success');
            });
        }

        // =============================================
        // MODAL FUNCTIONS
        // =============================================
        function openModal(title, bodyHtml, onSubmit) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = bodyHtml;
            document.getElementById('modalSubmit').onclick = () => {
                onSubmit();
                closeModal();
            };
            document.getElementById('genericModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('genericModal').classList.add('hidden');
        }

        function openNotesModal() {
            document.getElementById('notesModal').classList.remove('hidden');
        }

        function closeNotesModal() {
            document.getElementById('notesModal').classList.add('hidden');
        }

        function saveNotes() {
            appData.userProgress.notes = document.getElementById('globalNotes').value;
            saveProgress();
            showToast('Notes saved!', 'success');
        }

        // =============================================
        // TIMER FUNCTIONS
        // =============================================
        function openTimerModal() {
            document.getElementById('timerModal').classList.remove('hidden');
        }

        function closeTimerModal() {
            document.getElementById('timerModal').classList.add('hidden');
        }

        function startTimer() {
            if (timerInterval) return;
            timerInterval = setInterval(() => {
                timerSeconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        function resetTimer() {
            pauseTimer();
            timerSeconds = 0;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const hrs = Math.floor(timerSeconds / 3600);
            const mins = Math.floor((timerSeconds % 3600) / 60);
            const secs = timerSeconds % 60;
            document.getElementById('timerDisplay').textContent =
                `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function saveSession() {
            const hours = timerSeconds / 3600;
            appData.userProgress.studySessions.push({
                date: new Date().toISOString(),
                duration: hours
            });
            saveProgress();
            resetTimer();
            showToast(`Session saved: ${hours.toFixed(2)} hours`, 'success');
        }

        // =============================================
        // DATA IMPORT/EXPORT
        // =============================================
        function exportData() {
            const data = {
                appData,
                exportDate: new Date().toISOString(),
                user: currentUser.email
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wbcs-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup downloaded!', 'success');
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.appData) {
                        appData = imported.appData;
                        normalizeUserProgress();
                        saveAppData();
                        saveProgress();
                        renderAll();
                        showToast('Data restored successfully!', 'success');
                    }
                } catch (err) {
                    showToast('Invalid backup file', 'error');
                }
            };
            reader.readAsText(file);
        }

        async function syncData() {
            showToast('Syncing with server...', 'info');
            await saveProgress();
            await loadAppData();
            renderAll();
            showToast('Data synced!', 'success');
        }

        // =============================================
        // TOAST NOTIFICATIONS
        // =============================================
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // =============================================
        // Fancy glow cursor tracking for .btn-glow
        // =============================================
        document.addEventListener('pointermove', (e) => {
            const target = e.target.closest('.btn-glow');
            if (!target) return;
            const rect = target.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            target.style.setProperty('--x', `${x}%`);
            target.style.setProperty('--y', `${y}%`);
        });

        // =============================================
        // INITIALIZATION
        // =============================================
        window.onload = () => {
            const token = localStorage.getItem('wbcs_token');
            const savedUser = localStorage.getItem('wbcs_user');

            if (token || savedUser) {
                currentUser = savedUser ? JSON.parse(savedUser) : { email: 'user@demo.com', name: 'User', isAdmin: false };

                // If we have a saved user but NO token, it's likely demo mode.
                // Try to initialize, but if API requires token it will fall back to localStorage.
                initializeApp();
            } else {
                // Ensure auth screen visible when not signed in
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        };
    </script>
</body>
</html>
