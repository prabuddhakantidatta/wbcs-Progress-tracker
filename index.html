<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBCS 2026 - Interactive Prep Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --dark-bg: #1a1a2e;
            --dark-card: #16213e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.info { background: var(--primary); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .dark-mode { background: var(--dark-bg) !important; color: #eee !important; }
        .dark-mode .bg-white { background: var(--dark-card) !important; }
        .dark-mode input, .dark-mode textarea, .dark-mode select { background: #0a2647 !important; color: white !important; border-color: #333 !important; }
        .dark-mode table { background: var(--dark-card) !important; }
        .dark-mode td { border-color: rgba(255,255,255,0.1) !important; }

        .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
        .sidebar.active { transform: translateX(0); }
        .overlay { display: none; }
        .overlay.active { display: block; }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .completed-row { background: #d4edda !important; }
        .dark-mode .completed-row { background: #1a4d2e !important; }
        .completed-row td { text-decoration: line-through; opacity: 0.7; }

        .progress-bar { transition: width 0.5s ease; }

        @media print {
            .no-print { display: none !important; }
            body { font-size: 10pt !important; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Auth Screen -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">üéØ WBCS 2026</h1>
                <p class="text-gray-500 mt-2">Interactive Study Portal</p>
            </div>

            <div id="authTabs" class="flex mb-6 bg-gray-100 rounded-lg p-1">
                <button onclick="showAuthTab('login')" id="loginTab" class="flex-1 py-2 px-4 rounded-lg bg-indigo-500 text-white font-semibold transition">Login</button>
                <button onclick="showAuthTab('register')" id="registerTab" class="flex-1 py-2 px-4 rounded-lg text-gray-600 font-semibold transition">Register</button>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Email</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="your@email.com">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button onclick="handleLogin()" class="w-full bg-indigo-500 text-white py-3 rounded-lg font-semibold hover:bg-indigo-600 transition">Sign In</button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Full Name</label>
                    <input type="text" id="regName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="John Doe">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Email</label>
                    <input type="email" id="regEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="your@email.com">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Password</label>
                    <input type="password" id="regPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Min 6 characters">
                </div>
                <button onclick="handleRegister()" class="w-full bg-indigo-500 text-white py-3 rounded-lg font-semibold hover:bg-indigo-600 transition">Create Account</button>
            </div>

            <div id="authError" class="mt-4 text-red-500 text-center hidden"></div>
            <div id="authLoader" class="hidden"><div class="loader"></div></div>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="mainApp" class="hidden">
        <!-- Sidebar Toggle -->
        <button onclick="toggleSidebar()" class="fixed left-4 top-4 z-50 bg-indigo-500 text-white w-12 h-12 rounded-lg shadow-lg flex items-center justify-center text-xl no-print hover:bg-indigo-600 transition">‚ò∞</button>

        <!-- Overlay -->
        <div class="overlay fixed inset-0 bg-black/50 z-40" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside class="sidebar fixed left-0 top-0 w-72 h-full bg-slate-800 text-white z-50 overflow-y-auto no-print">
            <div class="p-6 border-b border-slate-700">
                <h2 class="text-xl font-bold text-indigo-400">üéØ WBCS 2026</h2>
                <p class="text-xs text-slate-400 mt-1">Interactive Study Portal</p>
                <p class="text-xs text-indigo-300 mt-2" id="sidebarUserEmail"></p>
            </div>

            <nav class="py-4">
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-slate-700 border-l-4 border-transparent hover:border-indigo-500 transition flex items-center gap-3" onclick="switchTab('overview')">
                    <span>üìä</span> Dashboard
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-slate-700 border-l-4 border-transparent hover:border-indigo-500 transition flex items-center gap-3" onclick="switchTab('weekday')">
                    <span>üìÖ</span> Weekday Routine
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-slate-700 border-l-4 border-transparent hover:border-indigo-500 transition flex items-center gap-3" onclick="switchTab('weekend')">
                    <span>üåÖ</span> Weekend Routine
                </div>

                <div class="px-6 py-3 cursor-pointer hover:bg-slate-700 flex items-center justify-between" onclick="toggleSubmenu('monthMenu')">
                    <span class="flex items-center gap-3"><span>üìÜ</span> Monthly Schedules</span>
                    <span id="monthMenuArrow">‚ñº</span>
                </div>
                <div id="monthMenu" class="hidden bg-slate-900"></div>

                <div class="px-6 py-3 cursor-pointer hover:bg-slate-700 flex items-center justify-between" onclick="toggleSubmenu('subjectMenu')">
                    <span class="flex items-center gap-3"><span>üìö</span> Subjects</span>
                    <span id="subjectMenuArrow">‚ñº</span>
                </div>
                <div id="subjectMenu" class="hidden bg-slate-900">
                    <div class="px-8 py-2 text-green-400 cursor-pointer hover:bg-slate-800 text-sm" onclick="createNewSubject()">‚ûï Add Subject</div>
                    <div id="subjectMenuList"></div>
                </div>

                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-slate-700 border-l-4 border-transparent hover:border-indigo-500 transition flex items-center gap-3" onclick="switchTab('tests')">
                    <span>‚úÖ</span> Test Tracker
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-slate-700 border-l-4 border-transparent hover:border-indigo-500 transition flex items-center gap-3" onclick="switchTab('analytics')">
                    <span>üìà</span> Analytics
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-slate-700 border-l-4 border-transparent hover:border-indigo-500 transition flex items-center gap-3" onclick="openNotesModal()">
                    <span>üìù</span> Global Notes
                </div>
                <div class="menu-item px-6 py-3 cursor-pointer hover:bg-slate-700 border-l-4 border-transparent hover:border-indigo-500 transition flex items-center gap-3" onclick="openTimerModal()">
                    <span>‚è±Ô∏è</span> Session Timer
                </div>

                <!-- Admin Menu (visible for admins) -->
                <div id="adminMenuSection" class="hidden border-t border-slate-700 mt-4 pt-4">
                    <div class="px-6 py-2 text-xs text-slate-400 uppercase">Admin Panel</div>
                    <div class="menu-item px-6 py-3 cursor-pointer hover:bg-slate-700 border-l-4 border-transparent hover:border-yellow-500 transition flex items-center gap-3 text-yellow-400" onclick="switchTab('admin')">
                        <span>‚öôÔ∏è</span> Manage Blueprints
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="pl-4 md:pl-20 pr-4 py-6 transition-all">
            <!-- Header -->
            <header class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6 rounded-xl mb-6 no-print">
                <h1 class="text-2xl md:text-3xl font-bold">üéØ WBCS Exam Preparation 2026</h1>
                <p class="text-indigo-100 mt-1">Complete Study Blueprint & Progress Tracker</p>
            </header>

            <!-- Controls Bar -->
            <div class="bg-white rounded-xl p-4 mb-6 flex flex-wrap gap-3 items-center shadow-sm no-print">
                <button onclick="toggleDarkMode()" class="px-4 py-2 bg-gray-600 text-white rounded-lg text-sm font-semibold hover:bg-gray-700 transition">üåô Theme</button>
                <button onclick="exportData()" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-600 transition">üíæ Backup</button>
                <button onclick="importData()" class="px-4 py-2 bg-yellow-500 text-gray-800 rounded-lg text-sm font-semibold hover:bg-yellow-600 transition">üì• Restore</button>
                <button onclick="window.print()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm font-semibold hover:bg-indigo-600 transition">üñ®Ô∏è Print</button>
                <button onclick="syncData()" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-semibold hover:bg-green-600 transition">üîÑ Sync</button>
                <button onclick="handleLogout()" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition ml-auto">üîí Logout</button>
                <span id="userEmailDisplay" class="font-semibold text-indigo-600"></span>
            </div>

            <!-- Tab Contents -->

            <!-- Overview Tab -->
            <div id="tab-overview" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-xl p-5 shadow-sm border-l-4 border-indigo-500">
                        <h3 class="text-xs uppercase text-gray-500 font-semibold">Overall Progress</h3>
                        <div class="text-3xl font-bold text-indigo-600 mt-2" id="statProgress">0%</div>
                        <div class="h-2 bg-gray-200 rounded-full mt-3 overflow-hidden">
                            <div class="progress-bar h-full bg-indigo-500" id="progressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-5 shadow-sm border-l-4 border-green-500">
                        <h3 class="text-xs uppercase text-gray-500 font-semibold">Study Streak</h3>
                        <div class="text-3xl font-bold text-green-600 mt-2" id="statStreak">0 days</div>
                    </div>
                    <div class="bg-white rounded-xl p-5 shadow-sm border-l-4 border-blue-500">
                        <h3 class="text-xs uppercase text-gray-500 font-semibold">Total Hours</h3>
                        <div class="text-3xl font-bold text-blue-600 mt-2" id="statHours">0.0h</div>
                    </div>
                    <div class="bg-white rounded-xl p-5 shadow-sm border-l-4 border-red-500">
                        <h3 class="text-xs uppercase text-gray-500 font-semibold">Days to Exam</h3>
                        <div class="text-3xl font-bold text-red-600 mt-2" id="statDays">0</div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-sm border border-indigo-200 mb-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">üìã Preparation Summary</h3>
                    <p class="text-gray-600">Target Date: <strong class="text-indigo-600">20 March 2026 (Preliminary)</strong></p>
                    <p class="text-gray-600">Plan includes comprehensive GS coverage with regular mock tests.</p>
                </div>

                <h2 class="text-xl font-bold text-gray-800 mb-4">üìö Quick Subject Access</h2>
                <div id="subjectCards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </div>

            <!-- Weekday Tab -->
            <div id="tab-weekday" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üìÖ Weekday Routine</h2>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-indigo-500 text-white">
                            <tr>
                                <th class="p-3 text-left">Time</th>
                                <th class="p-3 text-left">Activity</th>
                                <th class="p-3 text-left">Details</th>
                                <th class="p-3 text-left">Duration</th>
                            </tr>
                        </thead>
                        <tbody id="weekdayTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Weekend Tab -->
            <div id="tab-weekend" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üåÖ Weekend Routine</h2>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Saturday</h3>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
                    <table class="w-full">
                        <thead class="bg-indigo-500 text-white">
                            <tr><th class="p-3 text-left">Time</th><th class="p-3 text-left">Activity</th><th class="p-3 text-left">Details</th><th class="p-3 text-left">Duration</th></tr>
                        </thead>
                        <tbody id="saturdayTable"></tbody>
                    </table>
                </div>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Sunday</h3>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-indigo-500 text-white">
                            <tr><th class="p-3 text-left">Time</th><th class="p-3 text-left">Activity</th><th class="p-3 text-left">Details</th><th class="p-3 text-left">Duration</th></tr>
                        </thead>
                        <tbody id="sundayTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Monthly Tabs (Dynamic) -->
            <div id="monthlyTabs"></div>

            <!-- Subject View Tab -->
            <div id="tab-subject-view" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800" id="subjectViewTitle">Subject</h2>
                    <button onclick="deleteCurrentSubject()" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition">üóëÔ∏è Delete Subject</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-indigo-500 text-white">
                            <tr>
                                <th class="p-3 text-left">Topic</th>
                                <th class="p-3 text-left">Date (editable)</th>
                                <th class="p-3 text-left">Day</th>
                                <th class="p-3 text-left">Hours</th>
                                <th class="p-3 text-left">Status</th>
                                <th class="p-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subjectTopicsTable"></tbody>
                    </table>
                </div>
                <button onclick="addTopicToSubject()" class="mt-4 px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition">‚ûï Add Topic</button>
            </div>

            <!-- Tests Tab -->
            <div id="tab-tests" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">‚úÖ Test Performance Tracker</h2>
                <p class="text-gray-500 mb-3">You can reschedule test dates for your account (does not change the global/admin blueprint).</p>
                <div class="bg-white rounded-xl shadow-sm overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-indigo-500 text-white">
                            <tr>
                                <th class="p-3 text-left">Test #</th>
                                <th class="p-3 text-left">Date (editable)</th>
                                <th class="p-3 text-left">Type</th>
                                <th class="p-3 text-left">MCQs</th>
                                <th class="p-3 text-left">Focus</th>
                                <th class="p-3 text-left">Score</th>
                                <th class="p-3 text-left">%</th>
                                <th class="p-3 text-left">Status</th>
                            </tr>
                        </thead>
                        <tbody id="testsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="tab-analytics" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üìà Progress Analytics</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Subject Progress</h3>
                        <div id="subjectAnalytics"></div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Weekly Study Hours</h3>
                        <div id="weeklyChart" class="h-48 flex items-end gap-2"></div>
                    </div>
                </div>
            </div>

            <!-- Admin Tab -->
            <div id="tab-admin" class="tab-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">‚öôÔ∏è Admin - Manage Blueprints</h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Manage Routines -->
                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìÖ Manage Routines</h3>
                        <div class="space-y-2">
                            <button onclick="editRoutine('weekday')" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-left">Edit Weekday Routine</button>
                            <button onclick="editRoutine('saturday')" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-left">Edit Saturday Routine</button>
                            <button onclick="editRoutine('sunday')" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-left">Edit Sunday Routine</button>
                        </div>
                    </div>

                    <!-- Manage Subjects -->
                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìö Manage Subjects</h3>
                        <div id="adminSubjectList" class="space-y-2 mb-4"></div>
                        <button onclick="adminAddSubject()" class="w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">‚ûï Add New Subject</button>
                    </div>
                </div>

                <!-- Manage Monthly Blueprint -->
                <div class="bg-white rounded-xl p-6 shadow-sm mb-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üìÜ Manage Monthly Blueprints</h3>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <select id="adminMonthSelect" class="px-4 py-2 border rounded-lg">
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                        <button onclick="loadAdminMonthTasks()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition">Load Tasks</button>
                        <button onclick="adminAddTask()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">‚ûï Add Task</button>
                    </div>
                    <div class="text-xs text-gray-500 mb-3">Tip: You can edit task dates inline (admin blueprint update).</div>
                    <div id="adminTasksList" class="overflow-x-auto"></div>
                </div>

                <!-- Manage Tests -->
                <div class="bg-white rounded-xl p-6 shadow-sm">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">‚úÖ Manage Test Schedule</h3>
                    <button onclick="adminAddTest()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition mb-4">‚ûï Add Test</button>
                    <div class="text-xs text-gray-500 mb-3">Tip: You can edit test dates inline (admin blueprint update).</div>
                    <div id="adminTestsList" class="overflow-x-auto"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->

    <!-- Generic Modal -->
    <div id="genericModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800">Modal</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="modalBody" class="p-6"></div>
            <div class="p-6 border-t flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition">Cancel</button>
                <button id="modalSubmit" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition">Save</button>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">üìù Global Study Notes</h3>
                <button onclick="closeNotesModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <textarea id="globalNotes" class="w-full h-64 p-4 border rounded-lg resize-none focus:ring-2 focus:ring-indigo-500" placeholder="Write your study notes here..."></textarea>
            </div>
            <div class="p-6 border-t">
                <button onclick="saveNotes()" class="w-full px-4 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition">üíæ Save Notes</button>
            </div>
        </div>
    </div>

    <!-- Timer Modal -->
    <div id="timerModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md text-center">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">‚è±Ô∏è Study Timer</h3>
                <button onclick="closeTimerModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-8">
                <div id="timerDisplay" class="text-6xl font-mono font-bold text-indigo-600 mb-8">00:00:00</div>
                <div class="flex justify-center gap-3">
                    <button onclick="startTimer()" class="px-6 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition">‚ñ∂ Start</button>
                    <button onclick="pauseTimer()" class="px-6 py-2 bg-yellow-500 text-gray-800 rounded-lg font-semibold hover:bg-yellow-600 transition">‚è∏ Pause</button>
                    <button onclick="resetTimer()" class="px-6 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition">‚èπ Reset</button>
                </div>
                <button onclick="saveSession()" class="mt-6 px-6 py-2 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600 transition">üíæ Save Session</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFile" class="hidden" accept=".json" onchange="handleImport(event)">

    <script>
        // =============================================
        // API CONFIGURATION - Change this to your server
        // =============================================
        const API_BASE = 'http://localhost:5000/api'; // Change to your backend URL

        // =============================================
        // APP STATE
        // =============================================
        let currentUser = null;
        let activeTabId = 'overview';
        let appData = {
            subjects: [],
            tasks: [],
            tests: [],
            routines: { weekday: [], saturday: [], sunday: [] },
            userProgress: {
                completedTasks: {},
                testScores: {},
                customDates: {},
                customTestDates: {},
                dailyNotes: {},
                studySessions: [],
                notes: '',
                darkMode: false
            }
        };
        let activeSubject = null;
        let timerInterval = null;
        let timerSeconds = 0;

        // =============================================
        // DATE HELPERS (avoid timezone shifts)
        // =============================================
        function parseISODate(dateStr) {
            if (!dateStr) return null;
            // Force local midnight
            return new Date(dateStr + 'T00:00:00');
        }

        function toLocalISODate(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const da = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${da}`;
        }

        function formatDate(dateStr) {
            const d = parseISODate(dateStr);
            if (!d || Number.isNaN(d.getTime())) return '';
            return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
        }

        function getDayName(dateStr) {
            const d = parseISODate(dateStr);
            if (!d || Number.isNaN(d.getTime())) return '';
            return d.toLocaleDateString('en-US', { weekday: 'short' });
        }

        // =============================================
        // RESCHEDULING (per-user)
        // =============================================
        function getEffectiveTaskDate(task) {
            return appData.userProgress?.customDates?.[task.id] || task.date;
        }

        function getEffectiveTestDate(test) {
            return appData.userProgress?.customTestDates?.[test.id] || test.date;
        }

        function updateTaskDate(taskId, newDate) {
            if (!newDate) return;
            appData.userProgress.customDates ||= {};

            const task = appData.tasks.find(t => t.id === taskId);
            if (task && task.date === newDate) {
                delete appData.userProgress.customDates[taskId];
            } else {
                appData.userProgress.customDates[taskId] = newDate;
            }
            saveProgress();
            renderAll();
            showToast('Task date updated (rescheduled)', 'success');
        }

        function updateTestDate(testId, newDate) {
            if (!newDate) return;
            appData.userProgress.customTestDates ||= {};

            const test = appData.tests.find(t => t.id === testId);
            if (test && test.date === newDate) {
                delete appData.userProgress.customTestDates[testId];
            } else {
                appData.userProgress.customTestDates[testId] = newDate;
            }
            saveProgress();
            renderAll();
            showToast('Test date updated (rescheduled)', 'success');
        }

        // Admin blueprint inline updates
        function adminUpdateTaskDate(taskId, newDate) {
            if (!currentUser?.isAdmin) return;
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            task.date = newDate;
            saveAppData();
            loadAdminMonthTasks();
            renderAll();
            showToast('Blueprint task date updated', 'success');
        }

        function adminUpdateTestDate(testId, newDate) {
            if (!currentUser?.isAdmin) return;
            const test = appData.tests.find(t => t.id === testId);
            if (!test) return;
            test.date = newDate;
            saveAppData();
            renderAll();
            showToast('Blueprint test date updated', 'success');
        }

        // =============================================
        // API FUNCTIONS
        // =============================================
        async function apiCall(endpoint, method = 'GET', data = null) {
            const token = localStorage.getItem('wbcs_token');
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                }
            };
            if (data) options.body = JSON.stringify(data);

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'API Error');
                return result;
            } catch (error) {
                console.error('API Error:', error);
                // Fallback to localStorage if API fails
                return null;
            }
        }

        // =============================================
        // AUTHENTICATION
        // =============================================
        function showAuthTab(tab) {
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
            document.getElementById('loginTab').classList.toggle('bg-indigo-500', tab === 'login');
            document.getElementById('loginTab').classList.toggle('text-white', tab === 'login');
            document.getElementById('loginTab').classList.toggle('text-gray-600', tab !== 'login');
            document.getElementById('registerTab').classList.toggle('bg-indigo-500', tab === 'register');
            document.getElementById('registerTab').classList.toggle('text-white', tab === 'register');
            document.getElementById('registerTab').classList.toggle('text-gray-600', tab !== 'register');
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }

            document.getElementById('authLoader').classList.remove('hidden');

            const result = await apiCall('/auth/login', 'POST', { email, password });

            document.getElementById('authLoader').classList.add('hidden');

            if (result && result.token) {
                localStorage.setItem('wbcs_token', result.token);
                currentUser = result.user;
                await initializeApp();
            } else {
                // Fallback: demo mode with localStorage
                currentUser = { email, name: email.split('@')[0], isAdmin: email.includes('admin') };
                localStorage.setItem('wbcs_user', JSON.stringify(currentUser));
                await initializeApp();
            }
        }

        async function handleRegister() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            if (!name || !email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }

            if (password.length < 6) {
                showAuthError('Password must be at least 6 characters');
                return;
            }

            document.getElementById('authLoader').classList.remove('hidden');

            const result = await apiCall('/auth/register', 'POST', { name, email, password });

            document.getElementById('authLoader').classList.add('hidden');

            if (result && result.token) {
                localStorage.setItem('wbcs_token', result.token);
                currentUser = result.user;
                await initializeApp();
            } else {
                // Fallback: demo mode
                currentUser = { email, name, isAdmin: false };
                localStorage.setItem('wbcs_user', JSON.stringify(currentUser));
                showToast('Account created (Demo Mode)', 'success');
                await initializeApp();
            }
        }

        function handleLogout() {
            localStorage.removeItem('wbcs_token');
            localStorage.removeItem('wbcs_user');
            currentUser = null;
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showAuthError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        // =============================================
        // DATA LOADING & SAVING
        // =============================================
        function normalizeUserProgress() {
            appData.userProgress ||= {};
            appData.userProgress.completedTasks ||= {};
            appData.userProgress.testScores ||= {};
            appData.userProgress.customDates ||= {};
            appData.userProgress.customTestDates ||= {};
            appData.userProgress.dailyNotes ||= {};
            appData.userProgress.studySessions ||= [];
            appData.userProgress.notes ||= '';
            appData.userProgress.darkMode ||= false;
        }

        async function loadAppData() {
            // Try to load from API
            const serverData = await apiCall('/data');

            if (serverData) {
                appData = { ...appData, ...serverData };
            } else {
                // Fallback: Load from localStorage or use defaults
                const localData = localStorage.getItem('wbcs_appData');
                if (localData) {
                    appData = JSON.parse(localData);
                } else {
                    // Initialize with default data
                    appData = getDefaultAppData();
                }
            }

            // Load user-specific progress
            const userProgress = await apiCall('/progress');
            if (userProgress) {
                appData.userProgress = { ...appData.userProgress, ...userProgress };
            } else {
                const localProgress = localStorage.getItem('wbcs_progress_' + currentUser.email);
                if (localProgress) {
                    appData.userProgress = { ...appData.userProgress, ...JSON.parse(localProgress) };
                }
            }

            normalizeUserProgress();
        }

        async function saveProgress() {
            normalizeUserProgress();

            // Save to API
            await apiCall('/progress', 'PUT', appData.userProgress);

            // Also save to localStorage as backup
            localStorage.setItem('wbcs_progress_' + currentUser.email, JSON.stringify(appData.userProgress));
            localStorage.setItem('wbcs_appData', JSON.stringify(appData));
        }

        async function saveAppData() {
            // Admin only - save blueprint data
            if (!currentUser.isAdmin) return;

            await apiCall('/data', 'PUT', {
                subjects: appData.subjects,
                tasks: appData.tasks,
                tests: appData.tests,
                routines: appData.routines
            });

            localStorage.setItem('wbcs_appData', JSON.stringify(appData));
        }

        function getDefaultAppData() {
            return {
                subjects: ['Polity', 'History', 'Geography', 'Economy', 'Science', 'Environment', 'Current Affairs'],
                tasks: getDefaultTasks(),
                tests: getDefaultTests(),
                routines: getDefaultRoutines(),
                userProgress: {
                    completedTasks: {},
                    testScores: {},
                    customDates: {},
                    customTestDates: {},
                    dailyNotes: {},
                    studySessions: [],
                    notes: '',
                    darkMode: false
                }
            };
        }

        function getDefaultTasks() {
            const tasks = [];
            // January Blueprint
            const janData = [
                { date: '2026-01-01', morning: 'Polity: Constitution Basics, Preamble', evening: 'Polity MCQs (50)', test: 'New Year Holiday', subject: 'Polity', hours: 3.75 },
                { date: '2026-01-02', morning: 'History: 1857 Revolt - Causes & Course', evening: '1857 MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-03', morning: 'Geography: Earth, Solar System', evening: 'Geography MCQs', test: 'Weekend Study', subject: 'Geography', hours: 8.5 },
                { date: '2026-01-04', morning: 'Economy: National Income Concepts', evening: 'Economy MCQs', test: 'TEST 1: 50 MCQs', subject: 'Economy', hours: 8 },
                { date: '2026-01-05', morning: 'Polity: Fundamental Rights (Art 12-35)', evening: 'FR MCQs + Case laws', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-01-06', morning: 'History: Social Reform Movements', evening: 'Reformers MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-07', morning: 'Geography: Indian Physiography', evening: 'Mountain ranges MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-01-08', morning: 'Economy: Money, Banking, RBI Functions', evening: 'Banking MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-01-09', morning: 'Science: Physics - Motion, Work, Energy', evening: 'Physics MCQs', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-01-10', morning: 'Science: Heat, Light, Sound waves', evening: 'Science comp MCQs', test: 'Weekend Study', subject: 'Science', hours: 8.5 },
                { date: '2026-01-11', morning: 'Current Affairs: Dec 2025 Wrap-up', evening: 'CA MCQs', test: 'TEST 2: 50 MCQs', subject: 'Current Affairs', hours: 8 },
                { date: '2026-01-12', morning: 'Polity: DPSP (Art 36-51) & FD', evening: 'Directives MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-01-13', morning: 'History: INC Formation, Moderate Phase', evening: 'Early Congress MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-14', morning: 'Geography: Indian Drainage - Rivers', evening: 'Rivers Map Marking', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-01-15', morning: 'Economy: Fiscal Policy, Budget', evening: 'Budget Terms MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-01-16', morning: 'Science: Atomic Structure', evening: 'Chemistry Elements', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-01-17', morning: 'History: National Movement Timeline', evening: 'Chronology Practice', test: 'Weekend Study', subject: 'History', hours: 8.5 },
                { date: '2026-01-18', morning: 'Polity: Union Executive', evening: 'Executive MCQs', test: 'TEST 3: 75 MCQs', subject: 'Polity', hours: 8 },
                { date: '2026-01-19', morning: 'Polity: Parliament Basics', evening: 'Legislature MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-01-20', morning: 'History: Partition of Bengal 1905', evening: 'Swadeshi Movement MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-21', morning: 'Geography: Climate & Monsoon', evening: 'Monsoon patterns MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-01-22', morning: 'Economy: Agriculture Sector', evening: 'Green Revolution MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-01-23', morning: 'Science: Acids, Bases, Salts', evening: 'pH scale reactions', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-01-24', morning: 'Geography: Indian Map Comprehensive', evening: 'Map locations drill', test: 'Weekend Study', subject: 'Geography', hours: 8.5 },
                { date: '2026-01-25', morning: 'Economy: Full Economy Marathon', evening: 'Economy comprehensive MCQs', test: 'TEST 4: 75 MCQs', subject: 'Economy', hours: 8 },
                { date: '2026-01-26', morning: 'Republic Day: Constitution Deep Study', evening: 'Polity 100 MCQs marathon', test: 'Holiday', subject: 'Polity', hours: 6 },
                { date: '2026-01-27', morning: 'History: Home Rule, Lucknow Pact', evening: '1916-1919 MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-01-28', morning: 'Geography: Soils & Vegetation', evening: 'Forest types MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-01-29', morning: 'Economy: Industry & MSMEs', evening: 'Manufacturing policies MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-01-30', morning: 'Science: Biology - Cell & Tissues', evening: 'Cell structures MCQs', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-01-31', morning: 'Polity: Full Revision Marathon', evening: 'Polity final drill MCQs', test: 'TEST 5: 75 MCQs', subject: 'Polity', hours: 8.5 }
            ];

            // February Blueprint
            const febData = [
                { date: '2026-02-01', morning: 'Environment: Ecology, Biodiversity', evening: 'Environment comp MCQs', test: 'TEST 6: 75 MCQs', subject: 'Environment', hours: 8 },
                { date: '2026-02-02', morning: 'Polity: Judiciary - SC & High Courts', evening: 'Judicial cases MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-02-03', morning: 'History: Non-Cooperation Movement', evening: 'Gandhi era drill MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-02-04', morning: 'Geography: Minerals & Energy', evening: 'Resource maps MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-02-05', morning: 'Economy: Planning & NITI Aayog', evening: 'Plan objectives MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-02-06', morning: 'Science: Human Body Systems', evening: 'Human diseases MCQs', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-02-07', morning: 'History: 1857-1947 Final Chronology', evening: 'Timeline marathon drill', test: 'TEST 7: 75 MCQs', subject: 'History', hours: 8.5 },
                { date: '2026-02-08', morning: 'Polity + Geography Integration', evening: 'Combined mock MCQs', test: 'TEST 8: 75 MCQs', subject: 'Polity', hours: 8 },
                { date: '2026-02-09', morning: 'Polity: Local Government (73rd/74th)', evening: 'Panchayat MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-02-10', morning: 'History: Civil Disobedience', evening: 'Dandi March MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-02-11', morning: 'Geography WB: Physical Features', evening: 'WB district maps MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-02-12', morning: 'Economy: Govt Schemes Review', evening: 'Central/State welfare MCQs', test: '-', subject: 'Economy', hours: 3.75 },
                { date: '2026-02-13', morning: 'Science: Environment Pollution', evening: 'Climate treaties MCQs', test: '-', subject: 'Science', hours: 3.75 },
                { date: '2026-02-14', morning: 'Mixed Revision: All Weak Areas', evening: 'Problem topic intensive', test: 'TEST 9: 75 MCQs', subject: 'General', hours: 8.5 },
                { date: '2026-02-15', morning: 'Full Science Revision Marathon', evening: 'Science comprehensive MCQs', test: 'TEST 10: 100 MCQs', subject: 'Science', hours: 8 },
                { date: '2026-02-16', morning: 'Polity: Emergency Provisions', evening: 'Emergency history MCQs', test: '-', subject: 'Polity', hours: 3.75 },
                { date: '2026-02-17', morning: 'History: Quit India & INA', evening: 'Final phase leaders MCQs', test: '-', subject: 'History', hours: 3.75 },
                { date: '2026-02-18', morning: 'Geography WB: Economy & Industry', evening: 'WB agriculture MCQs', test: '-', subject: 'Geography', hours: 3.75 },
                { date: '2026-02-19', morning: 'Reasoning: Logical Patterns', evening: 'Reasoning speed practice', test: '-', subject: 'General', hours: 3.75 },
                { date: '2026-02-20', morning: 'Quant: Perc, Ratio, Shortcuts', evening: 'Speed math MCQs', test: '-', subject: 'General', hours: 3.75 },
                { date: '2026-02-21', morning: 'Complete GS Syllabus Revision', evening: 'Full mock test simulation', test: 'TEST 11: 100 MCQs', subject: 'General', hours: 8.5 },
                { date: '2026-02-22', morning: 'Current Affairs: Jan-Feb 2026', evening: 'Recent events mock MCQs', test: 'TEST 12: 100 MCQs', subject: 'Current Affairs', hours: 8 },
                { date: '2026-02-23', morning: 'English Basics & Vocabulary', evening: 'English comp MCQs', test: '-', subject: 'General', hours: 3 },
                { date: '2026-02-24', morning: 'Formulas & Facts Final Look', evening: 'Quick recall MCQs', test: '-', subject: 'General', hours: 2.5 },
                { date: '2026-02-25', morning: 'Timeline & Events Final Review', evening: 'Chronology final check', test: '-', subject: 'History', hours: 2.5 },
                { date: '2026-02-26', morning: 'Maps & Diagrams Final Review', evening: 'Visual memory drill', test: '-', subject: 'Geography', hours: 2.5 },
                { date: '2026-02-27', morning: 'Error Log Final Revision', evening: 'Mistake pattern analysis', test: '-', subject: 'General', hours: 2 },
                { date: '2026-02-28', morning: 'Rest & Mental Relaxation', evening: 'Final simulation mock', test: 'FULL MOCK: 200 MCQs', subject: 'General', hours: 3 }
            ];

            // March Blueprint
            const marData = [
                { date: '2026-03-01', morning: 'Full Revision: Polity Weak Areas', evening: 'Polity Marathon', test: '-', subject: 'Polity', hours: 6 },
                { date: '2026-03-02', morning: 'Full Revision: History Weak Areas', evening: 'History Marathon', test: '-', subject: 'History', hours: 6 },
                { date: '2026-03-03', morning: 'Full Revision: Geography Weak Areas', evening: 'Geography Marathon', test: '-', subject: 'Geography', hours: 6 },
                { date: '2026-03-04', morning: 'Full Revision: Economy Weak Areas', evening: 'Economy Marathon', test: '-', subject: 'Economy', hours: 6 },
                { date: '2026-03-05', morning: 'Full Revision: Science Weak Areas', evening: 'Science Marathon', test: '-', subject: 'Science', hours: 6 },
                { date: '2026-03-06', morning: 'Current Affairs: Complete Review', evening: 'CA Final Drill', test: '-', subject: 'Current Affairs', hours: 6 },
                { date: '2026-03-07', morning: 'Mock Test Simulation', evening: 'Error Analysis', test: 'TEST 13: FULL MOCK', subject: 'General', hours: 8 },
                { date: '2026-03-08', morning: 'Mock Test Simulation', evening: 'Error Analysis', test: 'TEST 14: FULL MOCK', subject: 'General', hours: 8 },
                { date: '2026-03-09', morning: 'Rapid Revision: All Subjects', evening: 'Quick Facts Review', test: '-', subject: 'General', hours: 6 },
                { date: '2026-03-10', morning: 'Rapid Revision: All Subjects', evening: 'Quick Facts Review', test: '-', subject: 'General', hours: 6 },
                { date: '2026-03-11', morning: 'Focus: Constitution & Amendments', evening: 'Polity Final MCQs', test: '-', subject: 'Polity', hours: 5 },
                { date: '2026-03-12', morning: 'Focus: Freedom Movement Timeline', evening: 'History Final MCQs', test: '-', subject: 'History', hours: 5 },
                { date: '2026-03-13', morning: 'Focus: Maps & Current Affairs', evening: 'Geography + CA MCQs', test: '-', subject: 'Geography', hours: 5 },
                { date: '2026-03-14', morning: 'Final Mock Test', evening: 'Complete Review', test: 'TEST 15: FINAL MOCK', subject: 'General', hours: 8 },
                { date: '2026-03-15', morning: 'Light Revision Only', evening: 'Rest', test: '-', subject: 'General', hours: 3 },
                { date: '2026-03-16', morning: 'Formula Sheet Review', evening: 'Quick Facts', test: '-', subject: 'General', hours: 3 },
                { date: '2026-03-17', morning: 'Current Affairs: Last Week', evening: 'Light Reading', test: '-', subject: 'Current Affairs', hours: 3 },
                { date: '2026-03-18', morning: 'Exam Prep: Admit Card, Center', evening: 'Mental Relaxation', test: 'Preparation Day', subject: 'General', hours: 2 },
                { date: '2026-03-19', morning: 'Complete Rest', evening: 'Early Sleep', test: 'Rest Day', subject: 'General', hours: 1 },
                { date: '2026-03-20', morning: 'WBCS PRELIMINARY EXAM 2026', evening: 'Self Reflection', test: 'D-DAY', subject: 'General', hours: 10 }
            ];

            [...janData, ...febData, ...marData].forEach((t, i) => {
                tasks.push({ ...t, id: `task-${i}` });
            });

            return tasks;
        }

        function getDefaultTests() {
            return [
                { id: 'test-1', number: 1, date: '2026-01-04', type: 'Subject', mcqs: 50, focus: 'Polity + History', target: 40 },
                { id: 'test-2', number: 2, date: '2026-01-11', type: 'Subject', mcqs: 50, focus: 'Geography + Economy', target: 40 },
                { id: 'test-3', number: 3, date: '2026-01-18', type: 'Mixed', mcqs: 75, focus: 'GS Comprehensive', target: 60 },
                { id: 'test-4', number: 4, date: '2026-01-25', type: 'Mixed', mcqs: 75, focus: 'All Subjects', target: 60 },
                { id: 'test-5', number: 5, date: '2026-01-31', type: 'Mixed', mcqs: 75, focus: 'Polity Heavy', target: 60 },
                { id: 'test-6', number: 6, date: '2026-02-01', type: 'Subject', mcqs: 75, focus: 'Environment', target: 60 },
                { id: 'test-7', number: 7, date: '2026-02-07', type: 'Mixed', mcqs: 75, focus: 'History Focus', target: 60 },
                { id: 'test-8', number: 8, date: '2026-02-08', type: 'Mixed', mcqs: 75, focus: 'Polity + Geo', target: 60 },
                { id: 'test-9', number: 9, date: '2026-02-14', type: 'Mixed', mcqs: 75, focus: 'Weak Areas', target: 60 },
                { id: 'test-10', number: 10, date: '2026-02-15', type: 'Full', mcqs: 100, focus: 'Science Focus', target: 80 },
                { id: 'test-11', number: 11, date: '2026-02-21', type: 'Full', mcqs: 100, focus: 'Complete GS', target: 80 },
                { id: 'test-12', number: 12, date: '2026-02-22', type: 'Full', mcqs: 100, focus: 'Current Affairs', target: 80 },
                { id: 'test-13', number: 13, date: '2026-03-07', type: 'Full Mock', mcqs: 200, focus: 'Exam Simulation', target: 160 },
                { id: 'test-14', number: 14, date: '2026-03-08', type: 'Full Mock', mcqs: 200, focus: 'Exam Simulation', target: 160 },
                { id: 'test-15', number: 15, date: '2026-03-14', type: 'Final Mock', mcqs: 200, focus: 'Final Simulation', target: 170 }
            ];
        }

        function getDefaultRoutines() {
            return {
                weekday: [
                    { time: '05:30 - 06:00', activity: 'Wake Up & Freshen', details: 'Morning routine, light exercise', duration: '30 min' },
                    { time: '06:00 - 08:00', activity: 'Morning Study Block', details: 'Theory reading - Primary subject', duration: '2 hrs' },
                    { time: '08:00 - 09:00', activity: 'Breakfast & Break', details: 'News reading, current affairs', duration: '1 hr' },
                    { time: '09:00 - 18:00', activity: 'Office/Work', details: 'Professional commitments', duration: '9 hrs' },
                    { time: '18:00 - 19:00', activity: 'Evening Break', details: 'Rest, snacks, light walk', duration: '1 hr' },
                    { time: '19:00 - 21:00', activity: 'Evening Study Block', details: 'MCQ practice, revision', duration: '2 hrs' },
                    { time: '21:00 - 22:00', activity: 'Dinner & Relaxation', details: 'Light reading, family time', duration: '1 hr' },
                    { time: '22:00 - 22:30', activity: 'Quick Revision', details: 'Day recap, next day planning', duration: '30 min' }
                ],
                saturday: [
                    { time: '06:00 - 08:00', activity: 'Morning Theory', details: 'Subject deep dive', duration: '2 hrs' },
                    { time: '08:00 - 09:00', activity: 'Breakfast', details: 'Current affairs reading', duration: '1 hr' },
                    { time: '09:00 - 12:00', activity: 'Intensive Study', details: 'Primary subject completion', duration: '3 hrs' },
                    { time: '12:00 - 14:00', activity: 'Lunch & Break', details: 'Rest and refresh', duration: '2 hrs' },
                    { time: '14:00 - 17:00', activity: 'MCQ Practice', details: 'Subject-wise practice', duration: '3 hrs' },
                    { time: '17:00 - 19:00', activity: 'Revision', details: 'Week summary revision', duration: '2 hrs' },
                    { time: '19:00 onwards', activity: 'Free Time', details: 'Relaxation, light study', duration: '~' }
                ],
                sunday: [
                    { time: '07:00 - 09:00', activity: 'Light Morning Study', details: 'Weak area focus', duration: '2 hrs' },
                    { time: '09:00 - 11:00', activity: 'Mock Test', details: 'Weekly assessment', duration: '2 hrs' },
                    { time: '11:00 - 13:00', activity: 'Test Analysis', details: 'Error log, learning', duration: '2 hrs' },
                    { time: '13:00 - 16:00', activity: 'Break & Lunch', details: 'Complete rest', duration: '3 hrs' },
                    { time: '16:00 - 18:00', activity: 'Next Week Planning', details: 'Schedule preparation', duration: '2 hrs' },
                    { time: '18:00 onwards', activity: 'Family/Recreation', details: 'Mental refresh', duration: '~' }
                ]
            };
        }

        // =============================================
        // APP INITIALIZATION
        // =============================================
        async function initializeApp() {
            await loadAppData();

            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            document.getElementById('userEmailDisplay').textContent = 'üë§ ' + currentUser.email;
            document.getElementById('sidebarUserEmail').textContent = currentUser.email;

            // Show admin menu if admin
            if (currentUser.isAdmin) {
                document.getElementById('adminMenuSection').classList.remove('hidden');
            }

            // Apply dark mode
            if (appData.userProgress.darkMode) {
                document.body.classList.add('dark-mode');
            }

            // Load notes
            document.getElementById('globalNotes').value = appData.userProgress.notes || '';

            renderAll();
            showToast('Welcome back, ' + currentUser.name + '!', 'success');
        }

        // =============================================
        // RENDERING FUNCTIONS
        // =============================================
        function renderAll() {
            renderDashboard();
            renderRoutines();
            renderMonthlySchedules();
            renderSubjects();
            renderTests();
            renderAnalytics();
            if (activeSubject) renderSubjectViewTable();
            if (currentUser.isAdmin) renderAdminPanel();

            // Restore the currently open tab after re-rendering dynamic content
            setActiveTab(activeTabId, true);
        }

        function renderDashboard() {
            const tasks = appData.tasks;
            const completed = Object.keys(appData.userProgress.completedTasks).filter(k => appData.userProgress.completedTasks[k]).length;
            const progress = tasks.length ? Math.round((completed / tasks.length) * 100) : 0;

            document.getElementById('statProgress').textContent = progress + '%';
            document.getElementById('progressBar').style.width = progress + '%';

            // Days to exam
            const examDate = new Date('2026-03-20T00:00:00');
            const today = new Date();
            const daysLeft = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));
            document.getElementById('statDays').textContent = Math.max(0, daysLeft);

            // Total hours
            let totalHours = 0;
            tasks.forEach(t => {
                if (appData.userProgress.completedTasks[t.id]) {
                    totalHours += t.hours || 0;
                }
            });
            document.getElementById('statHours').textContent = totalHours.toFixed(1) + 'h';

            // Streak
            document.getElementById('statStreak').textContent = calculateStreak() + ' days';

            // Subject cards
            const cardsHtml = appData.subjects.map(s => {
                const subjectTasks = tasks.filter(t => t.subject === s);
                const subjectCompleted = subjectTasks.filter(t => appData.userProgress.completedTasks[t.id]).length;
                const subjectProgress = subjectTasks.length ? Math.round((subjectCompleted / subjectTasks.length) * 100) : 0;
                return `
                    <div onclick="viewSubject('${s}')" class="bg-white rounded-xl p-4 shadow-sm cursor-pointer hover:shadow-md transition border-l-4 border-indigo-500">
                        <h4 class="font-bold text-gray-800">${s}</h4>
                        <div class="text-sm text-gray-500">${subjectCompleted}/${subjectTasks.length} topics</div>
                        <div class="h-2 bg-gray-200 rounded-full mt-2 overflow-hidden">
                            <div class="h-full bg-indigo-500" style="width: ${subjectProgress}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('subjectCards').innerHTML = cardsHtml;
        }

        function calculateStreak() {
            const completedDates = new Set();
            appData.tasks.forEach(t => {
                if (appData.userProgress.completedTasks[t.id]) {
                    completedDates.add(getEffectiveTaskDate(t));
                }
            });

            let streak = 0;
            let checkDate = new Date();
            checkDate.setHours(0, 0, 0, 0);

            // Start from today, otherwise from yesterday
            let dateStr = toLocalISODate(checkDate);
            if (!completedDates.has(dateStr)) {
                checkDate.setDate(checkDate.getDate() - 1);
            }

            while (true) {
                dateStr = toLocalISODate(checkDate);
                if (completedDates.has(dateStr)) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
                if (streak > 365) break;
            }
            return streak;
        }

        function renderRoutines() {
            const renderTable = (data, tableId) => {
                document.getElementById(tableId).innerHTML = data.map(r => `
                    <tr class="border-b">
                        <td class="p-3 font-semibold">${r.time}</td>
                        <td class="p-3">${r.activity}</td>
                        <td class="p-3 text-gray-600">${r.details}</td>
                        <td class="p-3">${r.duration}</td>
                    </tr>
                `).join('');
            };

            renderTable(appData.routines.weekday, 'weekdayTable');
            renderTable(appData.routines.saturday, 'saturdayTable');
            renderTable(appData.routines.sunday, 'sundayTable');
        }

        function renderMonthlySchedules() {
            const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

            let menuHtml = '';
            let tabsHtml = '';

            months.forEach((month, idx) => {
                const monthNum = String(idx + 1).padStart(2, '0');
                const monthTasks = appData.tasks
                    .filter(t => (getEffectiveTaskDate(t) || '').split('-')[1] === monthNum)
                    .slice()
                    .sort((a, b) => getEffectiveTaskDate(a).localeCompare(getEffectiveTaskDate(b)));

                if (monthTasks.length > 0) {
                    menuHtml += `<div class="px-8 py-2 text-slate-300 cursor-pointer hover:bg-slate-800 text-sm" onclick="switchTab('${month}')">${monthNames[idx]} 2026</div>`;

                    tabsHtml += `
                        <div id="tab-${month}" class="tab-content">
                            <div class="flex items-center justify-between gap-3 mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">üìÜ ${monthNames[idx]} 2026</h2>
                                <div class="text-xs text-gray-500">Edit dates to reschedule tasks (saved per-user)</div>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-indigo-500 text-white">
                                        <tr>
                                            <th class="p-3 text-left">Date</th>
                                            <th class="p-3 text-left">Day</th>
                                            <th class="p-3 text-left">Morning</th>
                                            <th class="p-3 text-left">Evening</th>
                                            <th class="p-3 text-left">Test</th>
                                            <th class="p-3 text-left">Subject</th>
                                            <th class="p-3 text-left">Hrs</th>
                                            <th class="p-3 text-left">‚úì</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${monthTasks.map(t => {
                                            const isCompleted = appData.userProgress.completedTasks[t.id];
                                            const effDate = getEffectiveTaskDate(t);
                                            const displayDate = formatDate(effDate);
                                            const dayName = getDayName(effDate);
                                            return `
                                                <tr class="${isCompleted ? 'completed-row' : ''} border-b hover:bg-gray-50">
                                                    <td class="p-3">
                                                        <div class="font-semibold">${displayDate}</div>
                                                        <input type="date" value="${effDate}" onchange="updateTaskDate('${t.id}', this.value)" class="mt-1 w-36 px-2 py-1 border rounded text-xs">
                                                    </td>
                                                    <td class="p-3">${dayName}</td>
                                                    <td class="p-3">${t.morning}</td>
                                                    <td class="p-3">${t.evening}</td>
                                                    <td class="p-3">${t.test}</td>
                                                    <td class="p-3"><span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-xs">${t.subject}</span></td>
                                                    <td class="p-3">${t.hours}</td>
                                                    <td class="p-3">
                                                        <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleTask('${t.id}')" class="w-5 h-5 accent-indigo-500 cursor-pointer">
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
            });

            document.getElementById('monthMenu').innerHTML = menuHtml;
            document.getElementById('monthlyTabs').innerHTML = tabsHtml;
        }

        function renderSubjects() {
            const menuHtml = appData.subjects.map(s => `
                <div class="px-8 py-2 text-slate-300 cursor-pointer hover:bg-slate-800 text-sm" onclick="viewSubject('${s}')">üìö ${s}</div>
            `).join('');
            document.getElementById('subjectMenuList').innerHTML = menuHtml;
        }

        function renderTests() {
            const html = appData.tests
                .slice()
                .sort((a, b) => (getEffectiveTestDate(a) || '').localeCompare(getEffectiveTestDate(b) || '') || (a.number - b.number))
                .map(t => {
                    const score = appData.userProgress.testScores[t.id];
                    const percentage = score ? Math.round((score / t.mcqs) * 100) : '-';
                    const status = score ? (percentage >= 80 ? '‚úÖ Excellent' : percentage >= 60 ? 'üëç Good' : '‚ö†Ô∏è Improve') : '‚è≥ Pending';
                    const effDate = getEffectiveTestDate(t);
                    return `
                        <tr class="border-b">
                            <td class="p-3 font-bold">Test ${t.number}</td>
                            <td class="p-3">
                                <div class="font-semibold">${formatDate(effDate)}</div>
                                <input type="date" value="${effDate}" onchange="updateTestDate('${t.id}', this.value)" class="mt-1 w-36 px-2 py-1 border rounded text-xs">
                            </td>
                            <td class="p-3">${t.type}</td>
                            <td class="p-3">${t.mcqs}</td>
                            <td class="p-3">${t.focus}</td>
                            <td class="p-3">
                                <input type="number" value="${score ?? ''}" placeholder="Score" 
                                    onchange="updateTestScore('${t.id}', this.value)"
                                    class="w-20 px-2 py-1 border rounded text-center">
                            </td>
                            <td class="p-3 font-bold ${score ? (percentage >= 80 ? 'text-green-600' : percentage >= 60 ? 'text-yellow-600' : 'text-red-600') : ''}">${percentage}%</td>
                            <td class="p-3">${status}</td>
                        </tr>
                    `;
                }).join('');
            document.getElementById('testsTable').innerHTML = html;
        }

        function renderAnalytics() {
            // Subject analytics
            const analyticsHtml = appData.subjects.map(s => {
                const subjectTasks = appData.tasks.filter(t => t.subject === s);
                const completed = subjectTasks.filter(t => appData.userProgress.completedTasks[t.id]).length;
                const progress = subjectTasks.length ? Math.round((completed / subjectTasks.length) * 100) : 0;
                const hours = subjectTasks
                    .filter(t => appData.userProgress.completedTasks[t.id])
                    .reduce((sum, t) => sum + (t.hours || 0), 0);
                return `
                    <div class="flex items-center justify-between py-3 border-b">
                        <div>
                            <div class="font-semibold">${s}</div>
                            <div class="text-sm text-gray-500">${completed}/${subjectTasks.length} topics ‚Ä¢ ${hours.toFixed(1)}h</div>
                        </div>
                        <div class="w-32">
                            <div class="text-right text-sm font-bold text-indigo-600 mb-1">${progress}%</div>
                            <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-indigo-500" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('subjectAnalytics').innerHTML = analyticsHtml;

            // Weekly chart (simple bar representation)
            const weeklyData = [4, 6, 3, 5, 8, 7, 2]; // Sample data
            const weeklyHtml = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((day, i) => `
                <div class="flex-1 flex flex-col items-center">
                    <div class="bg-indigo-500 rounded-t w-full" style="height: ${weeklyData[i] * 15}px"></div>
                    <div class="text-xs text-gray-500 mt-2">${day}</div>
                </div>
            `).join('');
            document.getElementById('weeklyChart').innerHTML = weeklyHtml;
        }

        function renderAdminPanel() {
            // Admin subject list
            const subjectListHtml = appData.subjects.map(s => `
                <div class="flex items-center justify-between bg-gray-100 px-3 py-2 rounded">
                    <span>${s}</span>
                    <button onclick="adminDeleteSubject('${s}')" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                </div>
            `).join('');
            document.getElementById('adminSubjectList').innerHTML = subjectListHtml;

            // Admin tests list (inline date edit)
            const testsHtml = appData.tests.length ? `
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 text-left">#</th>
                            <th class="p-2 text-left">Date</th>
                            <th class="p-2 text-left">Type</th>
                            <th class="p-2 text-left">MCQs</th>
                            <th class="p-2 text-left">Focus</th>
                            <th class="p-2 text-left">Target</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appData.tests
                            .slice()
                            .sort((a, b) => a.number - b.number)
                            .map(t => `
                            <tr class="border-b">
                                <td class="p-2 font-semibold">${t.number}</td>
                                <td class="p-2">
                                    <input type="date" class="px-2 py-1 border rounded text-xs w-36" value="${t.date}" onchange="adminUpdateTestDate('${t.id}', this.value)">
                                    <div class="text-xs text-gray-500 mt-1">${formatDate(t.date)}</div>
                                </td>
                                <td class="p-2">${t.type}</td>
                                <td class="p-2">${t.mcqs}</td>
                                <td class="p-2">${t.focus}</td>
                                <td class="p-2">${t.target}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p class="text-gray-500 text-center py-8">No tests configured.</p>';

            const adminTestsListEl = document.getElementById('adminTestsList');
            if (adminTestsListEl) adminTestsListEl.innerHTML = testsHtml;
        }

        // =============================================
        // SUBJECT VIEW RENDER
        // =============================================
        function renderSubjectViewTable() {
            if (!activeSubject) return;
            document.getElementById('subjectViewTitle').textContent = 'üìö ' + activeSubject;

            const subjectTasks = appData.tasks
                .filter(t => t.subject === activeSubject)
                .slice()
                .sort((a, b) => getEffectiveTaskDate(a).localeCompare(getEffectiveTaskDate(b)));

            const html = subjectTasks.map(t => {
                const isCompleted = appData.userProgress.completedTasks[t.id];
                const effDate = getEffectiveTaskDate(t);
                const dayName = getDayName(effDate);
                return `
                    <tr class="${isCompleted ? 'completed-row' : ''} border-b">
                        <td class="p-3">
                            <div class="font-semibold">${t.morning}</div>
                            <div class="text-sm text-gray-500">${t.evening}</div>
                        </td>
                        <td class="p-3">
                            <div class="font-semibold">${formatDate(effDate)}</div>
                            <input type="date" value="${effDate}" onchange="updateTaskDate('${t.id}', this.value)" class="mt-1 w-36 px-2 py-1 border rounded text-xs">
                        </td>
                        <td class="p-3">${dayName}</td>
                        <td class="p-3">${t.hours}h</td>
                        <td class="p-3">
                            <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleTask('${t.id}')" class="w-5 h-5 accent-indigo-500 cursor-pointer">
                        </td>
                        <td class="p-3">
                            <button onclick="editTask('${t.id}')" class="text-blue-500 hover:text-blue-700 mr-2">‚úèÔ∏è</button>
                            <button onclick="deleteTask('${t.id}')" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('subjectTopicsTable').innerHTML = html || `
                <tr><td class="p-3 text-gray-500" colspan="6">No tasks found for ${activeSubject}. Add a topic to start tracking.</td></tr>
            `;
        }

        // =============================================
        // UI INTERACTIONS
        // =============================================
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function toggleSubmenu(id) {
            const menu = document.getElementById(id);
            const arrow = document.getElementById(id + 'Arrow');
            menu.classList.toggle('hidden');
            arrow.textContent = menu.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
        }

        function setActiveTab(tabId, silent = false) {
            const target = document.getElementById('tab-' + tabId);
            const fallback = document.getElementById('tab-overview');

            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            if (target) {
                target.classList.add('active');
                activeTabId = tabId;
            } else {
                fallback?.classList.add('active');
                activeTabId = 'overview';
            }

            if (!silent) toggleSidebar();
        }

        function switchTab(tabId) {
            setActiveTab(tabId, false);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            appData.userProgress.darkMode = document.body.classList.contains('dark-mode');
            saveProgress();
        }

        // =============================================
        // TASK OPERATIONS
        // =============================================
        function toggleTask(taskId) {
            appData.userProgress.completedTasks[taskId] = !appData.userProgress.completedTasks[taskId];
            saveProgress();
            renderAll();
        }

        function updateTestScore(testId, score) {
            appData.userProgress.testScores[testId] = Number.isFinite(parseInt(score)) ? parseInt(score) : null;
            saveProgress();
            renderAll();
        }

        // =============================================
        // SUBJECT OPERATIONS
        // =============================================
        function viewSubject(name) {
            activeSubject = name;
            renderSubjectViewTable();
            setActiveTab('subject-view');
        }

        function createNewSubject() {
            openModal('Add New Subject', `
                <div class="mb-4">
                    <label class="block font-semibold mb-2">Subject Name</label>
                    <input type="text" id="newSubjectName" class="w-full px-4 py-2 border rounded-lg" placeholder="e.g., Physics">
                </div>
            `, () => {
                const name = document.getElementById('newSubjectName').value.trim();
                if (name && !appData.subjects.includes(name)) {
                    appData.subjects.push(name);
                    saveAppData();
                    saveProgress();
                    renderAll();
                    showToast('Subject added!', 'success');
                }
            });
        }

        function deleteCurrentSubject() {
            if (!activeSubject) return;
            if (confirm(`Delete subject "${activeSubject}"? This won't delete tasks.`)) {
                appData.subjects = appData.subjects.filter(s => s !== activeSubject);
                saveAppData();
                activeSubject = null;
                renderAll();
                setActiveTab('overview');
                showToast('Subject deleted', 'info');
            }
        }

        function addTopicToSubject() {
            if (!activeSubject) return;
            openModal('Add Topic to ' + activeSubject, `
                <div class="space-y-4">
                    <div>
                        <label class="block font-semibold mb-2">Morning Topic</label>
                        <input type="text" id="topicMorning" class="w-full px-4 py-2 border rounded-lg" placeholder="Theory topic...">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Evening Practice</label>
                        <input type="text" id="topicEvening" class="w-full px-4 py-2 border rounded-lg" placeholder="MCQs, practice...">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Date</label>
                        <input type="date" id="topicDate" class="w-full px-4 py-2 border rounded-lg" value="${toLocalISODate(new Date())}">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Hours</label>
                        <input type="number" id="topicHours" class="w-full px-4 py-2 border rounded-lg" value="3" step="0.5">
                    </div>
                </div>
            `, () => {
                const newTask = {
                    id: 'task-' + Date.now(),
                    morning: document.getElementById('topicMorning').value,
                    evening: document.getElementById('topicEvening').value,
                    date: document.getElementById('topicDate').value,
                    hours: parseFloat(document.getElementById('topicHours').value) || 3,
                    subject: activeSubject,
                    test: '-'
                };
                appData.tasks.push(newTask);
                saveAppData();
                renderAll();
                setActiveTab('subject-view');
                showToast('Topic added!', 'success');
            });
        }

        // =============================================
        // ADMIN FUNCTIONS
        // =============================================
        function adminAddSubject() {
            createNewSubject();
        }

        function adminDeleteSubject(name) {
            if (confirm(`Delete subject "${name}"?`)) {
                appData.subjects = appData.subjects.filter(s => s !== name);
                saveAppData();
                renderAll();
                showToast('Subject deleted', 'info');
            }
        }

        function loadAdminMonthTasks() {
            const month = document.getElementById('adminMonthSelect').value;
            const monthTasks = appData.tasks
                .filter(t => (t.date || '').split('-')[1] === month)
                .slice()
                .sort((a, b) => (a.date || '').localeCompare(b.date || ''));

            const html = monthTasks.length ? `
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 text-left">Date</th>
                            <th class="p-2 text-left">Morning</th>
                            <th class="p-2 text-left">Evening</th>
                            <th class="p-2 text-left">Subject</th>
                            <th class="p-2 text-left">Hours</th>
                            <th class="p-2 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${monthTasks.map(t => `
                            <tr class="border-b">
                                <td class="p-2">
                                    <input type="date" value="${t.date}" onchange="adminUpdateTaskDate('${t.id}', this.value)" class="px-2 py-1 border rounded text-xs w-36">
                                    <div class="text-xs text-gray-500 mt-1">${formatDate(t.date)}</div>
                                </td>
                                <td class="p-2">${t.morning}</td>
                                <td class="p-2">${t.evening}</td>
                                <td class="p-2">${t.subject}</td>
                                <td class="p-2">${t.hours}</td>
                                <td class="p-2">
                                    <button onclick="editTask('${t.id}')" class="text-blue-500 mr-2">‚úèÔ∏è</button>
                                    <button onclick="deleteTask('${t.id}')" class="text-red-500">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p class="text-gray-500 text-center py-8">No tasks for this month.</p>';

            document.getElementById('adminTasksList').innerHTML = html;
        }

        function adminAddTask() {
            const month = document.getElementById('adminMonthSelect').value;
            openModal('Add New Task', `
                <div class="space-y-4">
                    <div>
                        <label class="block font-semibold mb-2">Date</label>
                        <input type="date" id="taskDate" class="w-full px-4 py-2 border rounded-lg" value="2026-${month}-01">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Morning Topic</label>
                        <input type="text" id="taskMorning" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Evening Practice</label>
                        <input type="text" id="taskEvening" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Test/Activity</label>
                        <input type="text" id="taskTest" class="w-full px-4 py-2 border rounded-lg" value="-">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Subject</label>
                        <select id="taskSubject" class="w-full px-4 py-2 border rounded-lg">
                            ${appData.subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Hours</label>
                        <input type="number" id="taskHours" class="w-full px-4 py-2 border rounded-lg" value="3.75" step="0.25">
                    </div>
                </div>
            `, () => {
                const newTask = {
                    id: 'task-' + Date.now(),
                    date: document.getElementById('taskDate').value,
                    morning: document.getElementById('taskMorning').value,
                    evening: document.getElementById('taskEvening').value,
                    test: document.getElementById('taskTest').value,
                    subject: document.getElementById('taskSubject').value,
                    hours: parseFloat(document.getElementById('taskHours').value)
                };
                appData.tasks.push(newTask);
                saveAppData();
                loadAdminMonthTasks();
                renderAll();
                showToast('Task added!', 'success');
            });
        }

        function editTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;

            openModal('Edit Task', `
                <div class="space-y-4">
                    <div>
                        <label class="block font-semibold mb-2">Date</label>
                        <input type="date" id="editDate" class="w-full px-4 py-2 border rounded-lg" value="${task.date}">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Morning Topic</label>
                        <input type="text" id="editMorning" class="w-full px-4 py-2 border rounded-lg" value="${task.morning}">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Evening Practice</label>
                        <input type="text" id="editEvening" class="w-full px-4 py-2 border rounded-lg" value="${task.evening}">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Test/Activity</label>
                        <input type="text" id="editTest" class="w-full px-4 py-2 border rounded-lg" value="${task.test}">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Subject</label>
                        <select id="editSubject" class="w-full px-4 py-2 border rounded-lg">
                            ${appData.subjects.map(s => `<option value="${s}" ${s === task.subject ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Hours</label>
                        <input type="number" id="editHours" class="w-full px-4 py-2 border rounded-lg" value="${task.hours}" step="0.25">
                    </div>
                </div>
            `, () => {
                task.date = document.getElementById('editDate').value;
                task.morning = document.getElementById('editMorning').value;
                task.evening = document.getElementById('editEvening').value;
                task.test = document.getElementById('editTest').value;
                task.subject = document.getElementById('editSubject').value;
                task.hours = parseFloat(document.getElementById('editHours').value);
                saveAppData();
                renderAll();
                showToast('Task updated!', 'success');
            });
        }

        function deleteTask(taskId) {
            if (confirm('Delete this task?')) {
                appData.tasks = appData.tasks.filter(t => t.id !== taskId);
                // also clean per-user overrides for this task
                if (appData.userProgress?.completedTasks) delete appData.userProgress.completedTasks[taskId];
                if (appData.userProgress?.customDates) delete appData.userProgress.customDates[taskId];

                saveAppData();
                saveProgress();
                renderAll();
                showToast('Task deleted', 'info');
            }
        }

        function adminAddTest() {
            const nextNum = appData.tests.length + 1;
            openModal('Add New Test', `
                <div class="space-y-4">
                    <div>
                        <label class="block font-semibold mb-2">Test Number</label>
                        <input type="number" id="testNumber" class="w-full px-4 py-2 border rounded-lg" value="${nextNum}">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Date</label>
                        <input type="date" id="testDate" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Type</label>
                        <select id="testType" class="w-full px-4 py-2 border rounded-lg">
                            <option>Subject</option>
                            <option>Mixed</option>
                            <option>Full</option>
                            <option>Full Mock</option>
                            <option>Final Mock</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">MCQs</label>
                        <input type="number" id="testMcqs" class="w-full px-4 py-2 border rounded-lg" value="75">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Focus Area</label>
                        <input type="text" id="testFocus" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Target Score</label>
                        <input type="number" id="testTarget" class="w-full px-4 py-2 border rounded-lg" value="60">
                    </div>
                </div>
            `, () => {
                const newTest = {
                    id: 'test-' + Date.now(),
                    number: parseInt(document.getElementById('testNumber').value),
                    date: document.getElementById('testDate').value,
                    type: document.getElementById('testType').value,
                    mcqs: parseInt(document.getElementById('testMcqs').value),
                    focus: document.getElementById('testFocus').value,
                    target: parseInt(document.getElementById('testTarget').value)
                };
                appData.tests.push(newTest);
                appData.tests.sort((a, b) => a.number - b.number);
                saveAppData();
                renderAll();
                showToast('Test added!', 'success');
            });
        }

        function editRoutine(type) {
            const routine = appData.routines[type];
            const html = routine.map((r, i) => `
                <div class="border rounded p-3 mb-2">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" value="${r.time}" placeholder="Time" class="routine-time px-2 py-1 border rounded" data-index="${i}">
                        <input type="text" value="${r.duration}" placeholder="Duration" class="routine-duration px-2 py-1 border rounded" data-index="${i}">
                    </div>
                    <input type="text" value="${r.activity}" placeholder="Activity" class="routine-activity w-full px-2 py-1 border rounded mb-2" data-index="${i}">
                    <input type="text" value="${r.details}" placeholder="Details" class="routine-details w-full px-2 py-1 border rounded" data-index="${i}">
                </div>
            `).join('');

            openModal('Edit ' + type.charAt(0).toUpperCase() + type.slice(1) + ' Routine', html, () => {
                routine.forEach((r, i) => {
                    r.time = document.querySelector(`.routine-time[data-index="${i}"]`).value;
                    r.activity = document.querySelector(`.routine-activity[data-index="${i}"]`).value;
                    r.details = document.querySelector(`.routine-details[data-index="${i}"]`).value;
                    r.duration = document.querySelector(`.routine-duration[data-index="${i}"]`).value;
                });
                saveAppData();
                renderRoutines();
                showToast('Routine updated!', 'success');
            });
        }

        // =============================================
        // MODAL FUNCTIONS
        // =============================================
        function openModal(title, bodyHtml, onSubmit) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = bodyHtml;
            document.getElementById('modalSubmit').onclick = () => {
                onSubmit();
                closeModal();
            };
            document.getElementById('genericModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('genericModal').classList.add('hidden');
        }

        function openNotesModal() {
            document.getElementById('notesModal').classList.remove('hidden');
        }

        function closeNotesModal() {
            document.getElementById('notesModal').classList.add('hidden');
        }

        function saveNotes() {
            appData.userProgress.notes = document.getElementById('globalNotes').value;
            saveProgress();
            showToast('Notes saved!', 'success');
        }

        // =============================================
        // TIMER FUNCTIONS
        // =============================================
        function openTimerModal() {
            document.getElementById('timerModal').classList.remove('hidden');
        }

        function closeTimerModal() {
            document.getElementById('timerModal').classList.add('hidden');
        }

        function startTimer() {
            if (timerInterval) return;
            timerInterval = setInterval(() => {
                timerSeconds++;
                updateTimerDisplay();
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        function resetTimer() {
            pauseTimer();
            timerSeconds = 0;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const hrs = Math.floor(timerSeconds / 3600);
            const mins = Math.floor((timerSeconds % 3600) / 60);
            const secs = timerSeconds % 60;
            document.getElementById('timerDisplay').textContent =
                `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function saveSession() {
            const hours = timerSeconds / 3600;
            appData.userProgress.studySessions.push({
                date: new Date().toISOString(),
                duration: hours
            });
            saveProgress();
            resetTimer();
            showToast(`Session saved: ${hours.toFixed(2)} hours`, 'success');
        }

        // =============================================
        // DATA IMPORT/EXPORT
        // =============================================
        function exportData() {
            const data = {
                appData,
                exportDate: new Date().toISOString(),
                user: currentUser.email
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wbcs-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup downloaded!', 'success');
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.appData) {
                        appData = imported.appData;
                        normalizeUserProgress();
                        saveAppData();
                        saveProgress();
                        renderAll();
                        showToast('Data restored successfully!', 'success');
                    }
                } catch (err) {
                    showToast('Invalid backup file', 'error');
                }
            };
            reader.readAsText(file);
        }

        async function syncData() {
            showToast('Syncing with server...', 'info');
            await saveProgress();
            await loadAppData();
            renderAll();
            showToast('Data synced!', 'success');
        }

        // =============================================
        // TOAST NOTIFICATIONS
        // =============================================
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // =============================================
        // INITIALIZATION
        // =============================================
        window.onload = () => {
            // Check for existing session
            const token = localStorage.getItem('wbcs_token');
            const savedUser = localStorage.getItem('wbcs_user');

            if (token || savedUser) {
                currentUser = savedUser ? JSON.parse(savedUser) : { email: 'user@demo.com', name: 'User', isAdmin: false };
                initializeApp();
            }
        };
    </script>
</body>
</html>
